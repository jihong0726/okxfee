<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>交易计算工具</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "PingFang SC",
        "Helvetica Neue", Arial, sans-serif;
      background: radial-gradient(circle at top left, #1b2750 0, #050816 45%, #02030a 100%);
      color: #e8f0ff;
      min-height: 100vh;
    }
    .app-root {
      max-width: 1440px;
      margin: 24px auto;
      padding: 0 24px 32px;
      display: grid;
      grid-template-columns: 320px minmax(0, 1fr);
      gap: 24px;
    }

    /* 侧边栏 */
    .sidebar {
      background: radial-gradient(circle at top, #16213a 0, #050815 60%);
      border-radius: 20px;
      padding: 20px 20px 16px;
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.6);
      border: 1px solid rgba(86, 123, 255, 0.4);
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 12px;
      letter-spacing: 0.02em;
      color: #c5d4ff;
      background: linear-gradient(135deg, rgba(76, 130, 255, 0.18), rgba(119, 148, 255, 0.05));
      border: 1px solid rgba(118, 150, 255, 0.6);
      margin-bottom: 16px;
    }
    .badge-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      margin-right: 6px;
      background: #4fd1ff;
      box-shadow: 0 0 8px rgba(79, 209, 255, 0.9);
    }
    .side-title {
      font-size: 26px;
      font-weight: 700;
      margin-bottom: 12px;
    }
    .side-subtitle {
      font-size: 13px;
      line-height: 1.6;
      color: #a9b6dd;
      margin-bottom: 20px;
    }
    .side-section-title {
      font-size: 13px;
      color: #8f9ad0;
      margin: 10px 0 8px;
    }
    .area-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 18px;
    }
    .area-item {
      border-radius: 14px;
      padding: 12px 14px;
      background: rgba(10, 18, 40, 0.9);
      border: 1px solid rgba(77, 102, 179, 0.5);
      cursor: pointer;
      transition: all 0.18s ease-out;
    }
    .area-item:hover {
      border-color: #5c7cff;
      box-shadow: 0 0 0 1px rgba(92, 124, 255, 0.4);
    }
    .area-item.active {
      background: radial-gradient(circle at top left, #255dff40 0, #101424 60%);
      border-color: #6c8dff;
      box-shadow: 0 12px 25px rgba(15, 70, 200, 0.65);
    }
    .area-item-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .area-item-desc {
      font-size: 12px;
      color: #9facdf;
    }
    .side-tip {
      font-size: 11px;
      color: #6f7bb0;
      margin-top: 22px;
      border-top: 1px dashed rgba(92, 119, 210, 0.5);
      padding-top: 10px;
      line-height: 1.6;
    }

    /* 主体 */
    .main {
      background: radial-gradient(circle at top, #141c38 0, #050815 45%, #02030a 100%);
      border-radius: 20px;
      padding: 20px 22px 18px;
      border: 1px solid rgba(86, 123, 255, 0.45);
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.7);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* 头部：左描述 + 右下拉 */
    .main-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 24px;
      margin-bottom: 4px;
    }
    .main-header-left {
      flex: 1 1 auto;
      min-width: 0;
    }
    .main-header-right {
      flex: 0 0 auto;
      display: flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
    }
    .main-headline {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 3px;
    }
    .main-desc {
      font-size: 13px;
      color: #99a7de;
    }

    .tool-select-label {
      font-size: 14px;
      color: #9fb2ff;
      opacity: 0.9;
    }
    .tool-select {
      min-width: 220px;
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid rgba(117, 145, 230, 0.9);
      background: rgba(5, 10, 32, 0.95);
      color: #f4f6ff;
      font-size: 13px;
      outline: none;
      appearance: none;
      -webkit-appearance: none;
      background-image: linear-gradient(45deg, transparent 50%, #b7c7ff 50%),
        linear-gradient(135deg, #b7c7ff 50%, transparent 50%);
      background-position: calc(100% - 16px) 50%, calc(100% - 11px) 50%;
      background-size: 6px 6px, 6px 6px;
      background-repeat: no-repeat;
      padding-right: 28px;
    }

    .main-body {
      display: grid;
      grid-template-columns: minmax(0, 1.15fr) minmax(0, 1.05fr);
      gap: 18px;
    }

    .card {
      border-radius: 16px;
      padding: 14px 16px 14px;
      background: radial-gradient(circle at top left, #232c4a 0, #050815 65%);
      border: 1px solid rgba(88, 120, 210, 0.65);
      box-shadow: 0 12px 26px rgba(0, 0, 0, 0.55);
      min-height: 210px;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .card-title {
      font-size: 14px;
      font-weight: 600;
    }
    .card-subtitle {
      font-size: 11px;
      color: #9cadf0;
    }
    .copy-btn {
      font-size: 11px;
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid rgba(132, 158, 255, 0.85);
      background: rgba(12, 20, 52, 0.9);
      color: #e5ebff;
      cursor: pointer;
      transition: all 0.16s ease-out;
      white-space: nowrap;
    }
    .copy-btn:hover {
      background: rgba(151, 178, 255, 0.22);
      border-color: #c5d6ff;
    }

    .input-tip {
      font-size: 12px;
      color: #94a2df;
      margin-bottom: 10px;
      line-height: 1.6;
    }
    .field-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 12px;
    }
    .field-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .field-label {
      min-width: 120px;
      font-size: 13px;
      color: #cbd6ff;
      text-align: right;
    }
    .field-input-wrap {
      flex: 1;
      position: relative;
    }
    .field-input,
    .field-select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(103, 133, 212, 0.9);
      background: rgba(5, 10, 32, 0.9);
      color: #f5f7ff;
      font-size: 13px;
      outline: none;
      transition: all 0.16s ease-out;
    }
    .field-input:focus,
    .field-select:focus {
      border-color: #a9c4ff;
      box-shadow: 0 0 0 1px rgba(80, 140, 255, 0.6);
      background: rgba(7, 13, 38, 0.95);
    }
    .field-suffix {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 11px;
      color: #9fb0f3;
      pointer-events: none;
    }

    .btn-row {
  display: flex;
  gap: 10px;
  margin-top: 12px;     /* 想更靠下可以调这个值 */
  justify-content: center;  /* 关键：让按钮在这一行居中 */
  align-items: center;
}

    .btn {
      border-radius: 999px;
      padding: 7px 18px;
      font-size: 13px;
      border: 1px solid rgba(107, 136, 220, 0.9);
      background: rgba(9, 14, 38, 0.9);
      color: #d3dfff;
      cursor: pointer;
      transition: all 0.16s ease-out;
    }
    .btn:hover {
      background: rgba(124, 157, 255, 0.15);
      border-color: #9eb7ff;
    }
    .btn-primary {
      background: radial-gradient(circle at top left, #3f83ff 0, #1b3da6 45%, #0b183a 100%);
      border-color: #a3c3ff;
      color: #ffffff;
      box-shadow: 0 10px 26px rgba(50, 120, 255, 0.85);
    }
    .btn-primary:hover {
      background: radial-gradient(circle at top left, #4b8fff 0, #2546b4 45%, #0e214a 100%);
      border-color: #c4d6ff;
    }
    .btn-small {
      padding: 4px 10px;
      font-size: 11px;
    }

    .status-text {
      margin-top: 6px;
      font-size: 12px;
      color: #93a4ff;
      min-height: 16px;
    }
    .status-error {
      color: #ff9a9a;
    }

    .preview-block {
      border-radius: 12px;
      padding: 10px 12px;
      background: rgba(3, 9, 32, 0.95);
      border: 1px solid rgba(116, 144, 235, 0.7);
      font-size: 13px;
      line-height: 1.7;
      white-space: pre-wrap;
      min-height: 72px;
      margin-bottom: 10px;
    }
    .preview-label {
      font-size: 12px;
      margin-bottom: 4px;
      color: #a9b8ff;
    }

    .history-card {
      border-radius: 16px;
      padding: 10px 16px 12px;
      background: radial-gradient(circle at top left, #232c4a 0, #050815 70%);
      border: 1px solid rgba(88, 120, 210, 0.65);
      box-shadow: 0 12px 26px rgba(0, 0, 0, 0.55);
      margin-top: 4px;
    }
    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .history-title {
      font-size: 13px;
      font-weight: 500;
    }
    .history-tip {
      font-size: 11px;
      color: #9fb0f3;
    }
    .history-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 6px;
    }
    .history-item {
      padding: 6px 10px;
      border-radius: 10px;
      background: rgba(4, 10, 40, 0.9);
      border: 1px solid rgba(103, 124, 215, 0.7);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      font-size: 12px;
    }
    .history-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .history-meta {
      font-size: 11px;
      color: #9aa9f0;
    }
    .history-actions {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .version {
      font-size: 11px;
      color: #7f8ae0;
      text-align: right;
      margin-top: 6px;
      opacity: 0.85;
    }

    @media (max-width: 1100px) {
      .app-root {
        grid-template-columns: 1fr;
      }
      .sidebar {
        width: 100%;
      }
      .main-body {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
<div class="app-root">
  <!-- 侧边栏 -->
  <aside class="sidebar">
    <div class="badge">
      <span class="badge-dot"></span>
      交易计算助手 · 内部自用
    </div>
    <div class="side-title">交易计算工具</div>
    <div class="side-subtitle">
      先选交易区，再选计算项目，右侧输入数据即可看到结果和中文公式说明。
    </div>

    <div class="side-section-title">交易区</div>
    <div class="area-list" id="areaList">
      <div class="area-item active" data-area="uPerp">
        <div class="area-item-title">U 本位合约</div>
      </div>
      <div class="area-item" data-area="coinPerp">
        <div class="area-item-title">币本位合约</div>
      </div>
      <div class="area-item" data-area="other">
        <div class="area-item-title">其他交易区（开发中）</div>
        <div class="area-item-desc">暂不开放，统一在 U 本位页面展示占位提示</div>
      </div>
    </div>

    <div class="side-tip">
      提示：左侧切换 U 本位 / 币本位后，右侧内容区域即时刷新。
    </div>
  </aside>

  <!-- 主体 -->
  <main class="main">
    <div class="main-header">
      <div class="main-header-left">
        <div class="main-headline" id="currentAreaTitle">当前交易区：U 本位合约</div>
        <div class="main-desc" id="currentAreaDesc">
          以 USDT 结算的合约。
        </div>
      </div>

      <div class="main-header-right">
        <label class="tool-select-label" for="toolSelect">计算项目：</label>
        <select id="toolSelect" class="tool-select"></select>
      </div>
    </div>

    <!-- 中间 + 右侧 -->
    <div class="main-body">
      <!-- 左：输入区 -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title" id="inputCardTitle">输入区：开仓均价</div>
            <div class="card-subtitle" id="inputCardSub">输入合约面值、原持仓张数和均价、新开仓张数和成交均价，计算新的整体开仓均价。</div>
          </div>
        </div>

        <div class="input-tip" id="inputTip">
          格式示例：合约面值 0.01、原持仓 100 张、原持仓均价 1000，新开仓 50 张，新成交均价 2000。
        </div>

        <div class="field-list" id="fieldList"></div>

        <div class="btn-row">
          <button class="btn" id="btnClear">清空输入</button>
          <button class="btn btn-primary" id="btnCalc">开始计算</button>
        </div>

        <div class="status-text" id="statusText"></div>
      </section>

      <!-- 右：结果预览 -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">结果预览</div>
            <div class="card-subtitle">可复制使用。</div>
          </div>
          <button class="copy-btn" id="btnCopyResult">复制当前结果</button>
        </div>

        <div>
          <div class="preview-label">公式：</div>
          <div class="preview-block" id="previewFormula">选择上方计算项目后，点击“开始计算”，这里会显示对应的中文公式。</div>

          <div class="preview-label">代入数值：</div>
          <div class="preview-block" id="previewWithVal">这里会展示将你的输入数据代入后的公式写法。</div>

          <div class="preview-label">当前结果：</div>
          <div class="preview-block" id="previewMain">这里会显示计算结果。</div>
        </div>

        <div class="version">本工具仅作内部计算参考，请以系统实际数据为准。</div>
      </section>
    </div>

    <!-- 下：历史记录 -->
    <section class="history-card">
      <div class="history-header">
        <div>
          <div class="history-title">最近计算记录（最多保留 5 条）</div>
          <div class="history-tip">可快速恢复输入，再次调整数值重新计算。</div>
        </div>
        <button class="btn btn-small" id="btnClearHistory">清空历史</button>
      </div>
      <div class="history-list" id="historyList">
        <div class="history-tip">暂时无记录。</div>
      </div>
    </section>
  </main>
</div>

<script>
  // ----------- 配置：交易区基本信息 -----------
  const AREAS = {
    uPerp: {
      id: "uPerp",
      name: "U 本位合约",
      desc: "以 USDT 结算的合约。",
      unit: "U"
    },
    coinPerp: {
      id: "coinPerp",
      name: "币本位合约",
      desc: "以币本身结算的合约。",
      unit: "" // 不显示 U，用“计价单位”
    }
  };

  function getUnitText(areaId) {
    const area = AREAS[areaId];
    if (!area) return "计价单位";
    return area.unit || "计价单位";
  }

  // ----------- 配置：U 本位 & 币本位工具 -----------
  function buildToolsConfig(areaId) {
    const unit = getUnitText(areaId);
    const unitLabel = unit === "U" ? "U" : "计价单位";

    return [
      {
        id: "openPrice",
        name: "开仓均价",
        tip: "输入合约面值、原持仓张数和均价、新开仓张数和成交均价，计算新的整体开仓均价。",
        subTitle: "开仓均价 = （原持仓面值总额 + 新开仓面值总额） ÷ 总张数。",
        fields: [
          { key: "faceValue", label: "合约面值", placeholder: "例如 0.01", suffix: "" },
          { key: "oldQty", label: "原持仓张数", placeholder: "整数，例如 100", suffix: "张" },
          { key: "oldPrice", label: "原持仓均价", placeholder: "例如 1000", suffix: unit ? unit : "" },
          { key: "newQty", label: "新开仓张数", placeholder: "整数，例如 50", suffix: "张" },
          { key: "newPrice", label: "新成交均价", placeholder: "例如 2000", suffix: unit ? unit : "" }
        ],
        calc: (d) => {
          const f = d.faceValue, oc = d.oldQty, op = d.oldPrice, nc = d.newQty, np = d.newPrice;
          if (oc + nc === 0) throw new Error("原持仓张数 + 新开仓张数 不能为 0。");
          const avg = (f * oc * op + f * nc * np) / (f * (oc + nc));
          const main = `新的开仓均价 ≈ ${avg.toFixed(4)} ${unitLabel}`;
          const formulaText =
            "开仓均价 = （合约面值 × 原持仓张数 × 原持仓均价 + 合约面值 × 新开仓张数 × 新成交均价） ÷ [合约面值 × (原持仓张数 + 新开仓张数)]";
          const withValText =
            `开仓均价 = (${f} × ${oc} × ${op} + ${f} × ${nc} × ${np}) ÷ [${f} × (${oc} + ${nc})]`;
          return { main, formulaText, withValText };
        }
      },
      {
        id: "fee",
        name: "手续费",
        tip: "输入合约面值、张数、开/平仓均价、手续费率（按百分比输入），计算单次交易手续费。",
        subTitle: "手续费 = 合约面值 × 张数 × 开/平仓均价 × 手续费率。",
        fields: [
          { key: "faceValue", label: "合约面值", placeholder: "例如 0.01", suffix: "" },
          { key: "qty", label: "张数", placeholder: "整数，例如 100", suffix: "张" },
          { key: "price", label: "开/平仓均价", placeholder: "例如 1000", suffix: unit ? unit : "" },
          { key: "ratePercent", label: "手续费率", placeholder: "例如 0.05（代表 0.05%）", suffix: "%" }
        ],
        calc: (d) => {
          const rate = d.ratePercent / 100;
          const fee = d.faceValue * d.qty * d.price * rate;
          const main = `本次手续费 ≈ ${fee.toFixed(6)} ${unitLabel}`;
          const formulaText = "手续费 = 合约面值 × 张数 × 开/平仓均价 × 手续费率";
          const withValText =
            `手续费 = ${d.faceValue} × ${d.qty} × ${d.price} × (${d.ratePercent}% ÷ 100)`;
          return { main, formulaText, withValText };
        }
      },
      {
        id: "pnl",
        name: "合约收益",
        tip: "选择多仓或空仓，输入合约面值、张数、开仓均价和平仓均价，计算本次平仓收益。",
        subTitle: "多仓：收益 = 面值 × 张数 × (平仓 - 开仓)；空仓相反。",
        fields: [
          {
            key: "side",
            label: "持仓方向",
            type: "select",
            options: [
              { value: "long", label: "多仓" },
              { value: "short", label: "空仓" }
            ]
          },
          { key: "faceValue", label: "合约面值", placeholder: "例如 0.01", suffix: "" },
          { key: "qty", label: "张数", placeholder: "整数，例如 100", suffix: "张" },
          { key: "openPrice", label: "开仓均价", placeholder: "例如 1000", suffix: unit ? unit : "" },
          { key: "closePrice", label: "平仓均价", placeholder: "例如 1200", suffix: unit ? unit : "" }
        ],
        calc: (d) => {
          let pnl, formulaText, withValText;
          if (d.side === "long") {
            pnl = d.faceValue * d.qty * (d.closePrice - d.openPrice);
            formulaText = "多仓：收益 = 合约面值 × 张数 × (平仓均价 - 开仓均价)";
            withValText = `收益 = ${d.faceValue} × ${d.qty} × (${d.closePrice} - ${d.openPrice})`;
          } else {
            pnl = d.faceValue * d.qty * (d.openPrice - d.closePrice);
            formulaText = "空仓：收益 = 合约面值 × 张数 × (开仓均价 - 平仓均价)";
            withValText = `收益 = ${d.faceValue} × ${d.qty} × (${d.openPrice} - ${d.closePrice})`;
          }
          const main = `本次平仓收益 ≈ ${pnl.toFixed(4)} ${unitLabel}`;
          return { main, formulaText, withValText };
        }
      },
      {
        id: "roi",
        name: "收益率",
        tip: "输入本次收益金额和开仓固定保证金，计算收益率（按 % 显示）。",
        subTitle: "收益率 = 收益 ÷ 开仓固定保证金 × 100%。",
        fields: [
          { key: "pnl", label: "收益金额", placeholder: "例如 50", suffix: unit ? unit : "" },
          { key: "margin", label: "开仓固定保证金", placeholder: "例如 200", suffix: unit ? unit : "" }
        ],
        calc: (d) => {
          if (d.margin === 0) throw new Error("开仓固定保证金不能为 0。");
          const roi = (d.pnl / d.margin) * 100;
          const main = `收益率 ≈ ${roi.toFixed(2)} %`;
          const formulaText = "收益率 = 收益 ÷ 开仓固定保证金 × 100%";
          const withValText = `收益率 = ${d.pnl} ÷ ${d.margin} × 100%`;
          return { main, formulaText, withValText };
        }
      },
      {
        id: "initMargin",
        name: "开仓保证金（初始）",
        tip: "输入合约面值、开仓价格、张数和杠杆倍数，计算开仓所需初始保证金。",
        subTitle: "开仓保证金 = 合约面值 × 开仓价格 × 张数 ÷ 杠杆倍数。",
        fields: [
          { key: "faceValue", label: "合约面值", placeholder: "例如 0.01", suffix: "" },
          { key: "price", label: "开仓价格", placeholder: "例如 1000", suffix: unit ? unit : "" },
          { key: "qty", label: "张数", placeholder: "整数，例如 100", suffix: "张" },
          { key: "leverage", label: "杠杆倍数", placeholder: "例如 10", suffix: "倍" }
        ],
        calc: (d) => {
          if (d.leverage === 0) throw new Error("杠杆倍数不能为 0。");
          const margin = (d.faceValue * d.price * d.qty) / d.leverage;
          const main = `开仓需要的初始保证金 ≈ ${margin.toFixed(4)} ${unitLabel}`;
          const formulaText = "开仓保证金 = 合约面值 × 开仓价格 × 张数 ÷ 杠杆倍数";
          const withValText =
            `开仓保证金 = ${d.faceValue} × ${d.price} × ${d.qty} ÷ ${d.leverage}`;
          return { main, formulaText, withValText };
        }
      },
      {
        id: "maintMargin",
        name: "维持保证金",
        tip: "输入合约面值、仓位张数、维持保证金率（按百分比输入）和标记价格，计算当前需要的维持保证金。",
        subTitle: "维持保证金 = 合约面值 × |张数| × 维持保证金率 × 标记价格。",
        fields: [
          { key: "faceValue", label: "合约面值", placeholder: "例如 0.01", suffix: "" },
          { key: "qty", label: "仓位张数", placeholder: "可正可负，例如 100", suffix: "张" },
          { key: "ratePercent", label: "维持保证金率", placeholder: "例如 0.5（代表 0.5%）", suffix: "%" },
          { key: "markPrice", label: "标记价格", placeholder: "例如 1000", suffix: unit ? unit : "" }
        ],
        calc: (d) => {
          const absQty = Math.abs(d.qty);
          const rate = d.ratePercent / 100;
          const mm = d.faceValue * absQty * rate * d.markPrice;
          const main = `当前维持保证金 ≈ ${mm.toFixed(4)} ${unitLabel}`;
          const formulaText =
            "维持保证金 = 合约面值 × |张数| × 维持保证金率 × 标记价格";
          const withValText =
            `维持保证金 = ${d.faceValue} × ${absQty} × (${d.ratePercent}% ÷ 100) × ${d.markPrice}`;
          return { main, formulaText, withValText };
        }
      },
      {
        id: "marginRatio",
        name: "当前保证金率",
        tip: "输入保证金余额、未实现收益、合约面值、张数、标记价格、维持保证金率和手续费率（均按百分比输入），估算当前保证金率。",
        subTitle: "保证金率 = (保证金余额 + 收益) ÷ [合约面值 × |张数| × 标记价格 × (维持保证金率 + 手续费率)]。",
        fields: [
          { key: "balance", label: "保证金余额", placeholder: "例如 100", suffix: unit ? unit : "" },
          { key: "pnl", label: "未实现收益", placeholder: "亏损用负数，例如 -10", suffix: unit ? unit : "" },
          { key: "faceValue", label: "合约面值", placeholder: "例如 0.01", suffix: "" },
          { key: "qty", label: "仓位张数", placeholder: "可正可负，例如 100", suffix: "张" },
          { key: "markPrice", label: "标记价格", placeholder: "例如 1000", suffix: unit ? unit : "" },
          { key: "maintRatePercent", label: "维持保证金率", placeholder: "例如 0.5（代表 0.5%）", suffix: "%" },
          { key: "feeRatePercent", label: "手续费率", placeholder: "例如 0.05（代表 0.05%）", suffix: "%" }
        ],
        calc: (d) => {
          const absQty = Math.abs(d.qty);
          const maintRate = d.maintRatePercent / 100;
          const feeRate = d.feeRatePercent / 100;
          const denom = d.faceValue * absQty * d.markPrice * (maintRate + feeRate);
          if (denom === 0)
            throw new Error("分母为 0，请检查面值 / 张数 / 标记价格 / 维持保证金率 / 手续费率。");
          const ratio = (d.balance + d.pnl) / denom;
          const main = `当前保证金率 ≈ ${(ratio * 100).toFixed(2)} %`;
          const formulaText =
            "保证金率 = (保证金余额 + 收益) ÷ [合约面值 × |张数| × 标记价格 × (维持保证金率 + 手续费率)]";
          const withValText =
            `保证金率 = (${d.balance} + ${d.pnl}) ÷ [${d.faceValue} × ${absQty} × ${d.markPrice} × ((${d.maintRatePercent}% ÷ 100) + (${d.feeRatePercent}% ÷ 100))]`;
          return { main, formulaText, withValText };
        }
      },
      {
        id: "crossRatio",
        name: "跨币种全仓维持保证金率",
        tip: "输入有效保证金、维持保证金和减仓手续费，计算跨币种全仓模式下的维持保证金率。",
        subTitle: "维持保证金率 = 有效保证金 ÷ (维持保证金 + 减仓手续费)。",
        fields: [
          { key: "effectiveMargin", label: "有效保证金", placeholder: "例如 100", suffix: unit ? unit : "" },
          { key: "maintMargin", label: "维持保证金", placeholder: "例如 80", suffix: unit ? unit : "" },
          { key: "closeFee", label: "减仓手续费", placeholder: "例如 2", suffix: unit ? unit : "" }
        ],
        calc: (d) => {
          const denom = d.maintMargin + d.closeFee;
          if (denom === 0) throw new Error("维持保证金 + 减仓手续费 不能为 0。");
          const ratio = d.effectiveMargin / denom;
          const main = `跨币种全仓维持保证金率 ≈ ${(ratio * 100).toFixed(2)} %`;
          const formulaText =
            "维持保证金率 = 有效保证金 ÷ (维持保证金 + 减仓手续费)";
          const withValText =
            `维持保证金率 = ${d.effectiveMargin} ÷ (${d.maintMargin} + ${d.closeFee})`;
          return { main, formulaText, withValText };
        }
      },
      {
        id: "positionValue",
        name: "仓位价值",
        tip: "输入合约面值、张数和标记价格，计算当前仓位价值。",
        subTitle: "仓位价值 = 合约面值 × 张数 × 标记价格。",
        fields: [
          { key: "faceValue", label: "合约面值", placeholder: "例如 0.01", suffix: "" },
          { key: "qty", label: "张数", placeholder: "整数，例如 100", suffix: "张" },
          { key: "markPrice", label: "标记价格", placeholder: "例如 1000", suffix: unit ? unit : "" }
        ],
        calc: (d) => {
          const value = d.faceValue * d.qty * d.markPrice;
          const main = `当前仓位价值 ≈ ${value.toFixed(4)} ${unitLabel}`;
          const formulaText = "仓位价值 = 合约面值 × 张数 × 标记价格";
          const withValText =
            `仓位价值 = ${d.faceValue} × ${d.qty} × ${d.markPrice}`;
          return { main, formulaText, withValText };
        }
      },
      {
        id: "funding",
        name: "资金费用",
        tip: "输入仓位价值和资金费率（按百分比输入），计算当前资金费用。",
        subTitle: "资金费用 = 仓位价值 × 资金费率。",
        fields: [
          { key: "positionValue", label: "仓位价值", placeholder: "例如 1000", suffix: unit ? unit : "" },
          { key: "fundingRatePercent", label: "资金费率", placeholder: "例如 0.01（代表 0.01%）", suffix: "%" }
        ],
        calc: (d) => {
          const rate = d.fundingRatePercent / 100;
          const fee = d.positionValue * rate;
          const main = `本次资金费用 ≈ ${fee.toFixed(6)} ${unitLabel}`;
          const formulaText = "资金费用 = 仓位价值 × 资金费率";
          const withValText =
            `资金费用 = ${d.positionValue} × (${d.fundingRatePercent}% ÷ 100)`;
          return { main, formulaText, withValText };
        }
      },
      {
        id: "liqPrice",
        name: "预估强平价",
        tip: "选择多仓或空仓，并输入保证金余额、合约面值、张数、开仓均价、维持保证金率和手续费率（均按百分比输入），估算预估强平价（仅供参考）。",
        subTitle: "多仓 / 空仓各有一条公式，结果仅供参考。",
        fields: [
          {
            key: "side",
            label: "持仓方向",
            type: "select",
            options: [
              { value: "long", label: "多仓" },
              { value: "short", label: "空仓" }
            ]
          },
          { key: "balance", label: "保证金余额", placeholder: "例如 100", suffix: unit ? unit : "" },
          { key: "faceValue", label: "合约面值", placeholder: "例如 0.01", suffix: "" },
          { key: "qty", label: "张数", placeholder: "整数，例如 100", suffix: "张" },
          { key: "openPrice", label: "开仓均价", placeholder: "例如 1000", suffix: unit ? unit : "" },
          { key: "maintRatePercent", label: "维持保证金率", placeholder: "例如 0.5（代表 0.5%）", suffix: "%" },
          { key: "feeRatePercent", label: "手续费率", placeholder: "例如 0.05（代表 0.05%）", suffix: "%" }
        ],
        calc: (d) => {
          const q = d.qty;
          if (q === 0) throw new Error("张数不能为 0。");
          const maintRate = d.maintRatePercent / 100;
          const feeRate = d.feeRatePercent / 100;
          let price, formulaText, withValText;

          if (d.side === "long") {
            const denom = d.faceValue * q * (maintRate + feeRate - 1);
            if (denom === 0)
              throw new Error("分母为 0，请检查维持保证金率 + 手续费率 - 1。");
            price = (d.balance - d.faceValue * q * d.openPrice) / denom;
            formulaText =
              "多仓预估强平价 = [保证金余额 - 合约面值 × 张数 × 开仓均价] ÷ [合约面值 × 张数 × (维持保证金率 + 手续费率 - 1)]";
            withValText =
              `多仓预估强平价 = (${d.balance} - ${d.faceValue} × ${q} × ${d.openPrice}) ÷ [${d.faceValue} × ${q} × ((${d.maintRatePercent}% ÷ 100) + (${d.feeRatePercent}% ÷ 100) - 1)]`;
          } else {
            const denom = d.faceValue * q * (maintRate + feeRate + 1);
            if (denom === 0)
              throw new Error("分母为 0，请检查维持保证金率 + 手续费率 + 1。");
            price = (d.balance + d.faceValue * q * d.openPrice) / denom;
            formulaText =
              "空仓预估强平价 = [保证金余额 + 合约面值 × 张数 × 开仓均价] ÷ [合约面值 × 张数 × (维持保证金率 + 手续费率 + 1)]";
            withValText =
              `空仓预估强平价 = (${d.balance} + ${d.faceValue} × ${q} × ${d.openPrice}) ÷ [${d.faceValue} × ${q} × ((${d.maintRatePercent}% ÷ 100) + (${d.feeRatePercent}% ÷ 100) + 1)]`;
          }
          const main = `预估强平价 ≈ ${price.toFixed(4)} ${unitLabel}（仅供参考）`;
          return { main, formulaText, withValText };
        }
      }
    ];
  }

  const AREA_TOOLS = {
    uPerp: buildToolsConfig("uPerp"),
    coinPerp: buildToolsConfig("coinPerp")
  };

  // ----------- DOM 绑定 -----------
  const areaListEl = document.getElementById("areaList");
  const currentAreaTitleEl = document.getElementById("currentAreaTitle");
  const currentAreaDescEl = document.getElementById("currentAreaDesc");
  const toolSelectEl = document.getElementById("toolSelect");

  const fieldListEl = document.getElementById("fieldList");
  const inputTipEl = document.getElementById("inputTip");
  const inputCardTitleEl = document.getElementById("inputCardTitle");
  const inputCardSubEl = document.getElementById("inputCardSub");

  const btnClear = document.getElementById("btnClear");
  const btnCalc = document.getElementById("btnCalc");
  const statusTextEl = document.getElementById("statusText");

  const previewFormulaEl = document.getElementById("previewFormula");
  const previewWithValEl = document.getElementById("previewWithVal");
  const previewMainEl = document.getElementById("previewMain");
  const btnCopyResult = document.getElementById("btnCopyResult");

  const historyListEl = document.getElementById("historyList");
  const btnClearHistory = document.getElementById("btnClearHistory");

  let currentAreaId = "uPerp";
  let currentToolId = AREA_TOOLS[currentAreaId][0].id;
  let lastResultTexts = { formulaText: "", withValText: "", main: "" };

  // ----------- 渲染工具下拉 -----------
  function renderToolOptions() {
    const tools = AREA_TOOLS[currentAreaId];
    toolSelectEl.innerHTML = "";
    tools.forEach((t) => {
      const opt = document.createElement("option");
      opt.value = t.id;
      opt.textContent = t.name;
      if (t.id === currentToolId) opt.selected = true;
      toolSelectEl.appendChild(opt);
    });
  }

  function renderFields(tool) {
    fieldListEl.innerHTML = "";
    tool.fields.forEach((f) => {
      const row = document.createElement("div");
      row.className = "field-row";

      const label = document.createElement("div");
      label.className = "field-label";
      label.textContent = f.label;
      row.appendChild(label);

      const wrap = document.createElement("div");
      wrap.className = "field-input-wrap";

      if (f.type === "select") {
        const sel = document.createElement("select");
        sel.className = "field-select";
        sel.id = "field_" + f.key;
        f.options.forEach((opt) => {
          const o = document.createElement("option");
          o.value = opt.value;
          o.textContent = opt.label;
          sel.appendChild(o);
        });
        wrap.appendChild(sel);
      } else {
        const input = document.createElement("input");
        input.className = "field-input";
        input.type = "text";
        input.placeholder = f.placeholder || "";
        input.id = "field_" + f.key;
        wrap.appendChild(input);

        if (f.suffix) {
          const suf = document.createElement("span");
          suf.className = "field-suffix";
          suf.textContent = f.suffix;
          wrap.appendChild(suf);
        }
      }

      row.appendChild(wrap);
      fieldListEl.appendChild(row);
    });
  }

  function updateToolUI() {
    const tools = AREA_TOOLS[currentAreaId];
    const tool = tools.find((t) => t.id === currentToolId) || tools[0];
    currentToolId = tool.id;

    renderToolOptions();
    renderFields(tool);

    inputCardTitleEl.textContent = "输入区：" + tool.name;
    inputCardSubEl.textContent = tool.subTitle;
    inputTipEl.textContent = tool.tip;

    statusTextEl.textContent = "";
    statusTextEl.classList.remove("status-error");
    previewFormulaEl.textContent = "选择上方计算项目后，点击“开始计算”，这里会显示对应的中文公式。";
    previewWithValEl.textContent = "这里会展示将你的输入数据代入后的公式写法。";
    previewMainEl.textContent = "这里会显示计算结果。";
    lastResultTexts = { formulaText: "", withValText: "", main: "" };
  }

  // ----------- 获取输入数据 -----------
  function getCurrentData() {
    const tools = AREA_TOOLS[currentAreaId];
    const tool = tools.find((t) => t.id === currentToolId);
    const data = {};
    tool.fields.forEach((f) => {
      const el = document.getElementById("field_" + f.key);
      if (!el) return;
      if (f.type === "select") {
        data[f.key] = el.value;
      } else {
        const v = el.value.trim();
        if (f.key.endsWith("Percent")) {
          data[f.key] = v === "" ? NaN : Number(v);
        } else {
          data[f.key] = v === "" ? NaN : Number(v);
        }
      }
    });
    return data;
  }

  function checkNumbers(obj) {
    for (const [k, v] of Object.entries(obj)) {
      if (typeof v === "number" && Number.isNaN(v)) {
        throw new Error("有必填项为空或不是数字，请检查输入。");
      }
    }
  }

  // ----------- 历史记录 -----------
  const HISTORY_KEY = "trade_calc_history_v1";

  function loadHistory() {
    try {
      const text = localStorage.getItem(HISTORY_KEY);
      if (!text) return [];
      const arr = JSON.parse(text);
      if (!Array.isArray(arr)) return [];
      return arr;
    } catch (e) {
      return [];
    }
  }

  function saveHistory(list) {
    try {
      localStorage.setItem(HISTORY_KEY, JSON.stringify(list));
    } catch (e) {}
  }

  function renderHistory() {
    const list = loadHistory();
    historyListEl.innerHTML = "";
    if (!list.length) {
      const tip = document.createElement("div");
      tip.className = "history-tip";
      tip.textContent = "暂时无记录。";
      historyListEl.appendChild(tip);
      return;
    }

    list.forEach((item, idx) => {
      const row = document.createElement("div");
      row.className = "history-item";

      const mainDiv = document.createElement("div");
      mainDiv.className = "history-main";
      const title = document.createElement("div");
      title.textContent = `${idx + 1}. [${item.areaName}] ${item.toolName}`;
      const meta = document.createElement("div");
      meta.className = "history-meta";
      meta.textContent = item.main;
      mainDiv.appendChild(title);
      mainDiv.appendChild(meta);

      const actions = document.createElement("div");
      actions.className = "history-actions";

      const btnRestore = document.createElement("button");
      btnRestore.className = "btn btn-small";
      btnRestore.textContent = "恢复输入";
      btnRestore.onclick = () => restoreHistoryItem(item);

      const btnCopy = document.createElement("button");
      btnCopy.className = "btn btn-small";
      btnCopy.textContent = "复制结果";
      btnCopy.onclick = () => {
        const text =
          item.formulaText + "\n" + item.withValText + "\n" + item.main;
        copyToClipboard(text);
      };

      actions.appendChild(btnRestore);
      actions.appendChild(btnCopy);

      row.appendChild(mainDiv);
      row.appendChild(actions);
      historyListEl.appendChild(row);
    });
  }

  function addHistoryRecord({ areaId, toolId, data, formulaText, withValText, main }) {
    const list = loadHistory();
    const areaName = AREAS[areaId] ? AREAS[areaId].name : areaId;
    const tools = AREA_TOOLS[areaId] || [];
       const tool = tools.find((t) => t.id === toolId);
    const toolName = tool ? tool.name : toolId;

    const record = {
      ts: Date.now(),
      areaId,
      areaName,
      toolId,
      toolName,
      data,
      formulaText,
      withValText,
      main
    };

    const newList = [record, ...list].slice(0, 5);
    saveHistory(newList);
    renderHistory();
  }

  function restoreHistoryItem(item) {
    currentAreaId = item.areaId;
    currentToolId = item.toolId;

    Array.from(areaListEl.querySelectorAll(".area-item")).forEach((el) => {
      el.classList.toggle("active", el.dataset.area === currentAreaId);
    });

    const area = AREAS[currentAreaId] || AREAS["uPerp"];
    currentAreaTitleEl.textContent = "当前交易区：" + area.name;
    currentAreaDescEl.textContent = area.desc;

    updateToolUI();

    const tools = AREA_TOOLS[currentAreaId];
    const tool = tools.find((t) => t.id === currentToolId);
    tool.fields.forEach((f) => {
      const el = document.getElementById("field_" + f.key);
      if (!el) return;
      const v = item.data[f.key];
      if (f.type === "select") {
        el.value = v;
      } else if (typeof v === "number" && !Number.isNaN(v)) {
        el.value = String(v);
      }
    });

    previewFormulaEl.textContent = item.formulaText;
    previewWithValEl.textContent = item.withValText;
    previewMainEl.textContent = item.main;
    lastResultTexts = {
      formulaText: item.formulaText,
      withValText: item.withValText,
      main: item.main
    };
    statusTextEl.textContent = "已恢复历史记录，可调整后重新计算。";
    statusTextEl.classList.remove("status-error");
  }

  // ----------- Clipboard -----------
  function copyToClipboard(text) {
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text).then(
        () => {
          statusTextEl.textContent = "已复制当前结果到剪贴板。";
          statusTextEl.classList.remove("status-error");
        },
        () => {
          fallbackCopy(text);
        }
      );
    } else {
      fallbackCopy(text);
    }
  }

  function fallbackCopy(text) {
    const ta = document.createElement("textarea");
    ta.value = text;
    ta.style.position = "fixed";
    ta.style.opacity = "0";
    document.body.appendChild(ta);
    ta.focus();
    ta.select();
    try {
      document.execCommand("copy");
      statusTextEl.textContent = "已复制当前结果到剪贴板。";
      statusTextEl.classList.remove("status-error");
    } catch (e) {
      statusTextEl.textContent = "复制失败，请手动选择文本复制。";
      statusTextEl.classList.add("status-error");
    }
    document.body.removeChild(ta);
  }

  // ----------- 事件绑定 -----------
  areaListEl.addEventListener("click", (e) => {
    const item = e.target.closest(".area-item");
    if (!item) return;
    const areaId = item.dataset.area;
    if (areaId === "other") {
      alert("其他交易区暂不开放，请在 U 本位 / 币本位页面使用已有功能。");
      return;
    }

    currentAreaId = areaId;

    Array.from(areaListEl.querySelectorAll(".area-item")).forEach((el) => {
      el.classList.toggle("active", el === item);
    });

    const area = AREAS[currentAreaId] || AREAS["uPerp"];
    currentAreaTitleEl.textContent = "当前交易区：" + area.name;
    currentAreaDescEl.textContent = area.desc;

    currentToolId = AREA_TOOLS[currentAreaId][0].id;
    updateToolUI();
  });

  toolSelectEl.addEventListener("change", () => {
    currentToolId = toolSelectEl.value;
    updateToolUI();
  });

  btnCalc.onclick = () => {
    try {
      const tools = AREA_TOOLS[currentAreaId];
      const tool = tools.find((t) => t.id === currentToolId);
      const data = getCurrentData();
      checkNumbers(data);
      const { main, formulaText, withValText } = tool.calc(data);

      previewFormulaEl.textContent = formulaText;
      previewWithValEl.textContent = withValText;
      previewMainEl.textContent = main;
      lastResultTexts = { formulaText, withValText, main };

      statusTextEl.textContent = "计算完成。结果仅供参考。";
      statusTextEl.classList.remove("status-error");

      addHistoryRecord({
        areaId: currentAreaId,
        toolId: currentToolId,
        data,
        formulaText,
        withValText,
        main
      });
    } catch (e) {
      statusTextEl.textContent = e.message || "计算失败，请检查输入。";
      statusTextEl.classList.add("status-error");
    }
  };

  btnClear.onclick = () => {
    Array.from(fieldListEl.querySelectorAll("input.field-input")).forEach((el) => {
      el.value = "";
    });
    statusTextEl.textContent = "已清空输入。";
    statusTextEl.classList.remove("status-error");
  };

  btnCopyResult.onclick = () => {
    if (!lastResultTexts.main) {
      statusTextEl.textContent = "暂无可复制的结果，请先完成一次计算。";
      statusTextEl.classList.add("status-error");
      return;
    }
    const text =
      lastResultTexts.formulaText +
      "\n" +
      lastResultTexts.withValText +
      "\n" +
      lastResultTexts.main;
    copyToClipboard(text);
  };

  btnClearHistory.onclick = () => {
    saveHistory([]);
    renderHistory();
    statusTextEl.textContent = "已清空历史记录。";
    statusTextEl.classList.remove("status-error");
  };

  (function init() {
    updateToolUI();
    renderHistory();
  })();
</script>
</body>
</html>
