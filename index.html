<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆçº¦æ¸…ç®—ä»·æ ¼è®¡ç®—å™¨ (æµ…è‰²ä¸»é¢˜)</title>
    
    <script type="text/javascript" id="MathJax-script" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
    </script>

    <style>
        /* å…¨å±€æ ·å¼å’Œæµ…è‰²ä¸»é¢˜åŸºç¡€ */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa; /* ææµ…ç°èƒŒæ™¯ */
            color: #333333; /* ç¢³ç°æ–‡å­— */
            padding: 20px;
            margin: 0;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #ffffff; /* çº¯ç™½å†…å®¹åŒºåŸŸèƒŒæ™¯ */
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); /* æŸ”å’Œé˜´å½± */
        }

        /* æ ‡é¢˜æ ·å¼ */
        h1 {
            color: #004d99; /* ä¸“ä¸šé‡‘èè“ */
            text-align: center;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 15px;
            margin-top: 0;
            margin-bottom: 30px;
        }

        /* è¾“å…¥ç»„æ ·å¼ */
        .input-group {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #007bff; /* å®è“è‰²æ ‡ç­¾ */
        }

        .input-group input[type="number"],
        .input-group select {
            padding: 12px;
            border: 1px solid #ced4da; /* æµ…è¾¹æ¡† */
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .input-group input[type="number"]:focus,
        .input-group select:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
            outline: none;
        }

        /* æŒ‰é’®æ ·å¼ */
        button {
            background-color: #28a745; /* ç»¿è‰²æŒ‰é’® */
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 700;
            transition: background-color 0.3s, transform 0.1s;
            width: 100%;
            margin-top: 10px;
        }

        button:hover {
            background-color: #218838; /* é¼ æ ‡æ‚¬åœå˜æ·± */
        }

        button:active {
            transform: translateY(1px);
        }

        /* ç»“æœåŒºåŸŸæ ·å¼ */
        #results {
            margin-top: 40px;
            padding: 20px;
            border-top: 3px dashed #e9ecef;
        }

        .result-box {
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 8px;
            border-left: 5px solid #007bff; /* å®è“è‰²å·¦ä¾§ç‚¹ç¼€ */
            background-color: #f1f7fe; /* ææµ…è“è‰²èƒŒæ™¯ */
        }

        .result-box p {
            margin: 0;
            font-size: 16px;
        }

        .result-label {
            font-weight: 600;
            color: #004d99;
            margin-right: 10px;
        }

        .result-value {
            font-size: 18px;
            font-weight: 700;
        }

        /* æ¸…ç®—ä»·æ ¼å’Œæ æ†é«˜äº® */
        #liquidationPrice {
            color: #dc3545; /* çº¢è‰²é«˜äº®æ¸…ç®—ä»· */
            font-size: 24px;
        }

        #effectiveLeverage {
            color: #007bff; /* è“è‰²é«˜äº®æœ‰æ•ˆæ æ† */
        }

        /* å…¬å¼åŒºåŸŸæ ·å¼ */
        .formula-section {
            margin-top: 30px;
            padding: 15px;
            background-color: #e9ecef; /* æµ…ç°èƒŒæ™¯ */
            border-radius: 8px;
            font-size: 14px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ“ åŠ å¯†è´§å¸åˆçº¦æ¸…ç®—ä»·æ ¼è®¡ç®—å™¨</h1>
    <div class="input-group">
        <label for="entryPrice">å¼€ä»“ä»·æ ¼ ($/å¸)</label>
        <input type="number" id="entryPrice" placeholder="ä¾‹å¦‚: 30000" value="30000">
    </div>

    <div class="input-group">
        <label for="leverage">åä¹‰æ æ†å€æ•° (X)</label>
        <input type="number" id="leverage" placeholder="ä¾‹å¦‚: 20" value="20">
    </div>

    <div class="input-group">
        <label for="positionSize">å¼€ä»“æ•°é‡ (å¸)</label>
        <input type="number" id="positionSize" placeholder="ä¾‹å¦‚: 1" value="1">
    </div>

    <div class="input-group">
        <label for="maintenanceMarginRate">ç»´æŒä¿è¯é‡‘ç‡ (%)</label>
        <input type="number" id="maintenanceMarginRate" placeholder="ä¾‹å¦‚: 0.5" value="0.5">
    </div>

    <div class="input-group">
        <label for="fee">å¼€ä»“æ‰‹ç»­è´¹ (%)</label>
        <input type="number" id="fee" placeholder="ä¾‹å¦‚: 0.05" value="0.05">
    </div>

    <div class="input-group">
        <label for="fundingRate">é¢„è®¡èµ„é‡‘è´¹ç‡ (%) (ä»…ä½œä¼°ç®—)</label>
        <input type="number" id="fundingRate" placeholder="ä¾‹å¦‚: 0.01" value="0.01">
    </div>

    <div class="input-group">
        <label for="direction">ä»“ä½æ–¹å‘</label>
        <select id="direction">
            <option value="long">åšå¤š (Long)</option>
            <option value="short">åšç©º (Short)</option>
        </select>
    </div>

    <button onclick="calculateLiquidationPrice()">è®¡ç®—æ¸…ç®—ä»·æ ¼</button>

    <div id="results">
        <div class="result-box">
            <p><span class="result-label">æ¸…ç®—ä»·æ ¼:</span> <span class="result-value" id="liquidationPrice">--</span></p>
        </div>
        <div class="result-box">
            <p><span class="result-label">èµ·å§‹ä¿è¯é‡‘:</span> <span class="result-value" id="initialMargin">--</span></p>
        </div>
        <div class="result-box">
            <p><span class="result-label">æœ‰æ•ˆæ æ†:</span> <span class="result-value" id="effectiveLeverage">--</span></p>
        </div>
        <div class="result-box">
            <p><span class="result-label">å¼€ä»“ä»·å€¼ (æœ¬é‡‘ x æ æ†):</span> <span class="result-value" id="positionValue">--</span></p>
        </div>
        <div class="result-box">
            <p><span class="result-label">å¯æ‰¿å—çš„è·Œå¹…/æ¶¨å¹…:</span> <span class="result-value" id="tolerableChange">--</span></p>
        </div>
    </div>

    <div class="formula-section">
        <p>ä½¿ç”¨çš„ç®€åŒ–è®¡ç®—å…¬å¼ (ä¸å«ä¿é™©åŸºé‡‘å’Œç©¿ä»“å¹³æ‘Š):</p>
        <p>åˆå§‹ä¿è¯é‡‘ç‡: $IMR = 1 / \text{æ æ†å€æ•°}$</p>
        <p>ç»´æŒä¿è¯é‡‘ç‡: $MMR = \text{è¾“å…¥å€¼} / 100$</p>
        <p>å¼€ä»“æ€»æˆæœ¬ (USDT): $Cost = (\text{å¼€ä»“ä»·æ ¼} \times \text{å¼€ä»“æ•°é‡}) / \text{æ æ†} + \text{æ‰‹ç»­è´¹} + \text{èµ„é‡‘è´¹}$</p>
        <p>åšå¤šæ¸…ç®—ä»·æ ¼: $$\text{æ¸…ç®—ä»·æ ¼} = \text{å¼€ä»“ä»·æ ¼} \times \left(1 - \frac{IMR - MMR + \text{é¢å¤–æˆæœ¬æ¯”}}{\text{å¼€ä»“æ•°é‡} \times (1 - MMR)}\right)$$</p>
        <p>åšç©ºæ¸…ç®—ä»·æ ¼: $$\text{æ¸…ç®—ä»·æ ¼} = \text{å¼€ä»“ä»·æ ¼} \times \left(1 + \frac{IMR - MMR + \text{é¢å¤–æˆæœ¬æ¯”}}{\text{å¼€ä»“æ•°é‡} \times (1 + MMR)}\right)$$</p>
        
        <p style="margin-top: 15px; font-style: italic; color: #6c757d;">ç‰ˆæœ¬ V2.0.1 - åˆçº¦æ ¸å¿ƒåŠŸèƒ½å®ç° (å·²ç§»è‡³æœ€ä¸‹æ–¹)</p>
    </div>
</div>

<script>
    /**
     * åˆçº¦æ¸…ç®—ä»·æ ¼è®¡ç®—å‡½æ•°
     */
    function calculateLiquidationPrice() {
        // 1. è·å–è¾“å…¥å€¼å¹¶è½¬æ¢ä¸ºæ•°å­— (ä½¿ç”¨parseFloatå¤„ç†å°æ•°)
        const entryPrice = parseFloat(document.getElementById('entryPrice').value);
        const leverage = parseFloat(document.getElementById('leverage').value);
        const positionSize = parseFloat(document.getElementById('positionSize').value);
        // å°†ç™¾åˆ†æ¯”è¾“å…¥è½¬æ¢ä¸ºå°æ•°å½¢å¼
        const maintenanceMarginRate = parseFloat(document.getElementById('maintenanceMarginRate').value) / 100;
        const feeRate = parseFloat(document.getElementById('fee').value) / 100;
        const fundingRate = parseFloat(document.getElementById('fundingRate').value) / 100;
        const direction = document.getElementById('direction').value;

        // 2. åŸºæœ¬æ ¡éªŒ
        if (!entryPrice || !leverage || !positionSize || isNaN(maintenanceMarginRate) || isNaN(feeRate) || isNaN(fundingRate) || leverage <= 0) {
            alert('è¯·ç¡®ä¿æ‰€æœ‰è¾“å…¥é¡¹éƒ½å·²å¡«å†™æœ‰æ•ˆæ•°å­—ï¼Œä¸”æ æ†å¤§äº0ã€‚');
            return;
        }

        // 3. è®¡ç®—å…³é”®å‚æ•°
        
        // (1) å¼€ä»“æ€»ä»·å€¼ (åˆçº¦ä»·å€¼)
        const positionValue = entryPrice * positionSize;
        
        // (2) åˆå§‹ä¿è¯é‡‘ç‡ (IMR)
        // IMR = 1 / æ æ†
        const initialMarginRate = 1 / leverage;

        // (3) èµ·å§‹ä¿è¯é‡‘ (Initial Margin) - å®é™…æŠ•å…¥çš„æœ¬é‡‘
        // Initial Margin = å¼€ä»“ä»·å€¼ / æ æ†
        const initialMargin = positionValue / leverage;

        // (4) é¢å¤–æˆæœ¬ (æ‰‹ç»­è´¹å’Œèµ„é‡‘è´¹ - åŸºäºå¼€ä»“ä»·å€¼è®¡ç®—)
        // ç®€åŒ–å¤„ç†ï¼šå°†å¼€ä»“æ‰‹ç»­è´¹å’Œä¸€æœŸèµ„é‡‘è´¹è§†ä¸ºå¼€ä»“æ—¶çš„é¢å¤–æˆæœ¬
        const totalExtraCost = positionValue * (feeRate + fundingRate);
        
        // (5) æ€»ä¿è¯é‡‘ (ç”¨äºè®¡ç®—ç›ˆäºçš„æœ¬é‡‘)
        const totalMargin = initialMargin; 

        // 4. æ¸…ç®—ä»·æ ¼è®¡ç®— (ç®€åŒ–å…¬å¼)

        let liquidationPrice;
        let tolerableChangePercentage;

        // ç”¨äºè®¡ç®—æ¸…ç®—ä»·æ ¼çš„â€œæ€»æˆæœ¬/ä»·å€¼æ¯”â€ (åŒ…æ‹¬æ‰‹ç»­è´¹ç­‰é¢å¤–æˆæœ¬)
        const costFactor = initialMarginRate - maintenanceMarginRate;

        // é¢å¤–æˆæœ¬å åˆçº¦ä»·å€¼çš„æ¯”ç‡
        const extraCostRatio = totalExtraCost / positionValue;

        if (direction === 'long') {
            // åšå¤š: ä»·æ ¼ä¸‹è·Œå¯¼è‡´æ¸…ç®—
            // æ¸…ç®—ä»·æ ¼ = å¼€ä»“ä»·æ ¼ * (1 - (åˆå§‹ä¿è¯é‡‘ç‡ - ç»´æŒä¿è¯é‡‘ç‡ + é¢å¤–æˆæœ¬æ¯”) / (1 - ç»´æŒä¿è¯é‡‘ç‡))
            liquidationPrice = entryPrice * (1 - (costFactor + extraCostRatio) / (1 - maintenanceMarginRate));
            
            // å¯æ‰¿å—çš„è·Œå¹…ç™¾åˆ†æ¯”
            tolerableChangePercentage = (1 - (liquidationPrice / entryPrice)) * 100;

        } else { // direction === 'short'
            // åšç©º: ä»·æ ¼ä¸Šæ¶¨å¯¼è‡´æ¸…ç®—
            // æ¸…ç®—ä»·æ ¼ = å¼€ä»“ä»·æ ¼ * (1 + (åˆå§‹ä¿è¯é‡‘ç‡ - ç»´æŒä¿è¯é‡‘ç‡ + é¢å¤–æˆæœ¬æ¯”) / (1 + ç»´æŒä¿è¯é‡‘ç‡))
            liquidationPrice = entryPrice * (1 + (costFactor + extraCostRatio) / (1 + maintenanceMarginRate));

            // å¯æ‰¿å—çš„æ¶¨å¹…ç™¾åˆ†æ¯”
            tolerableChangePercentage = ((liquidationPrice / entryPrice) - 1) * 100;
        }

        // 5. è®¡ç®—æœ‰æ•ˆæ æ† (åŸºäºå®é™…æŠ•å…¥æœ¬é‡‘)
        // æœ‰æ•ˆæ æ† = å¼€ä»“æ€»ä»·å€¼ / å®é™…æŠ•å…¥æœ¬é‡‘
        const effectiveLeverage = positionValue / totalMargin; 
        
        // 6. ç»“æœè¾“å‡º
        document.getElementById('liquidationPrice').textContent = liquidationPrice.toFixed(4) + ' $';
        document.getElementById('initialMargin').textContent = totalMargin.toFixed(2) + ' $';
        document.getElementById('positionValue').textContent = positionValue.toFixed(2) + ' $';
        document.getElementById('effectiveLeverage').textContent = effectiveLeverage.toFixed(2) + ' X';

        // æ˜¾ç¤ºå¯æ‰¿å—çš„å˜åŠ¨
        const changeText = direction === 'long' 
            ? `ä¸‹è·Œ ${Math.abs(tolerableChangePercentage).toFixed(2)} %`
            : `ä¸Šæ¶¨ ${Math.abs(tolerableChangePercentage).toFixed(2)} %`;
            
        document.getElementById('tolerableChange').textContent = changeText;
        
        // ç¡®ä¿ MathJax é‡æ–°æ¸²æŸ“å…¬å¼
        if (typeof MathJax !== 'undefined') {
            MathJax.typesetPromise();
        }
    }

    // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è®¡ç®—ä¸€æ¬¡ (ä½¿ç”¨é»˜è®¤å€¼)
    document.addEventListener('DOMContentLoaded', calculateLiquidationPrice);
</script>

</body>
</html>
