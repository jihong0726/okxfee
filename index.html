<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆçº¦ä¸æœŸæƒå…¨èƒ½è®¡ç®—å™¨ V3.2</title>
    
    <script type="text/javascript" id="MathJax-script" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
    </script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f8f9fa; color: #333; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background-color: #ffffff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); }
        h1 { color: #004d99; text-align: center; border-bottom: 2px solid #e9ecef; padding-bottom: 15px; margin-bottom: 30px; }
        /* å¸ƒå±€ä¼˜åŒ– */
        .config-row { display: flex; gap: 20px; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px dashed #e9ecef; }
        .input-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .input-group { margin-bottom: 0px; display: flex; flex-direction: column; flex: 1; }
        .input-group label { font-weight: 600; margin-bottom: 8px; color: #007bff; }
        input[type="number"], select { padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 16px; width: 100%; box-sizing: border-box; }
        button { background-color: #28a745; color: white; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 18px; font-weight: 700; width: 100%; margin-top: 10px; transition: background-color 0.3s; }
        button:hover { background-color: #218838; }
        #results { margin-top: 40px; padding: 20px; border-top: 3px solid #007bff; background-color: #f1f7fe; border-radius: 8px; }
        .result-box { margin-bottom: 15px; padding: 10px; border-left: 5px solid #004d99; background-color: #e9f3ff; border-radius: 4px; display: flex; justify-content: space-between;}
        .result-label { font-weight: 700; color: #333; }
        .result-value { font-size: 18px; font-weight: 700; color: #dc3545; }
        .formula-section { margin-top: 30px; padding: 15px; background-color: #e9ecef; border-radius: 8px; font-size: 14px; }
        .hidden { display: none; }
        .note { color: #888; margin-top: 5px; font-size: 0.9em; }
        
        /* æ–°å¢ï¼šå†…å®¹é€‰æ‹©æ ·å¼ */
        .checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .checkbox-group label { font-weight: normal; color: #555; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ§  äº¤æ˜“è®¡ç®—å…¬å¼ç»¼åˆéªŒè¯å™¨ V3.2</h1>
    
    <div class="config-row">
        <div class="input-group" style="flex: 2;">
            <label for="mode">é€‰æ‹©è®¡ç®—æ¨¡å¼</label>
            <select id="mode" onchange="toggleInputs()">
                <option value="usdt_m">1. U æœ¬ä½åˆçº¦ (USDT-M)</option>
                <option value="coin_m">2. å¸æœ¬ä½åˆçº¦ (Coin-M)</option>
                <option value="option">3. æœŸæƒäº¤æ˜“ (Options)</option>
            </select>
        </div>
        <div class="input-group" style="flex: 1;">
            <label for="direction">ä»“ä½æ–¹å‘</label>
            <select id="direction">
                <option value="long">åšå¤š (Long)</option>
                <option value="short">åšç©º (Short)</option>
            </select>
        </div>
        <div class="input-group" style="flex: 1;">
            <label for="marginMode">ä¿è¯é‡‘æ¨¡å¼</label>
            <select id="marginMode">
                <option value="cross">å…¨ä»“ (Cross)</option>
                <option value="isolated">é€ä»“ (Isolated)</option>
            </select>
        </div>
    </div>
    
    <div class="input-group" id="calculationSelection" style="border-bottom: 1px dashed #e9ecef; padding-bottom: 15px; margin-bottom: 25px;">
        <label>ğŸ¯ è®¡ç®—å†…å®¹é€‰æ‹©</label>
        <div class="checkbox-group">
            <input type="checkbox" id="calc_avg" value="avg" checked><label for="calc_avg">å¹³å‡å¼€ä»“ä»·</label>
            <input type="checkbox" id="calc_pnl" value="pnl" checked><label for="calc_pnl">æœªå®ç°ç›ˆäº</label>
            <input type="checkbox" id="calc_liq" value="liq" checked><label for="calc_liq">é¢„ä¼°å¼ºå¹³ä»·</label>
            <input type="checkbox" id="calc_immm" value="immm" checked><label for="calc_immm">åˆå§‹/ç»´æŒä¿è¯é‡‘</label>
            <input type="checkbox" id="calc_value" value="value" checked><label for="calc_value">ä»“ä½ä»·å€¼/èµ„é‡‘è´¹</label>
        </div>
    </div>

    
    <div id="contractInputs">
        <div class="input-grid">
            <div class="input-group">
                <label for="contractFaceValue">åˆçº¦é¢å€¼ (M)</label>
                <input type="number" id="contractFaceValue" value="10" placeholder="USDT-M: 1, Coin-M: 10/100">
                <p class="note" id="faceValueNote">å¸æœ¬ä½ç¤ºä¾‹: 100 (å¼ )/åˆçº¦</p>
            </div>
            <div class="input-group">
                <label for="entryPrice">å½“å‰å¼€ä»“å‡ä»· (P_entry)</label>
                <input type="number" id="entryPrice" value="30000">
            </div>
            <div class="input-group">
                <label for="positionSize">å½“å‰æ€»æŒä»“å¼ æ•° (S_old)</label>
                <input type="number" id="positionSize" value="100">
            </div>
            <div class="input-group">
                <label for="leverage">æ æ†å€æ•° (L)</label>
                <input type="number" id="leverage" value="20">
            </div>
            <div class="input-group">
                <label for="markPrice">æ ‡è®°ä»·æ ¼ (P_mark)</label>
                <input type="number" id="markPrice" value="30500">
            </div>
            <div class="input-group">
                <label for="maintenanceMarginRate">ç»´æŒä¿è¯é‡‘ç‡ (MMR, %)</label>
                <input type="number" id="maintenanceMarginRate" value="0.5">
            </div>
            <div class="input-group">
                <label for="feeRate">æ‰‹ç»­è´¹ç‡ (Fee, %)</label>
                <input type="number" id="feeRate" value="0.05">
            </div>
            <div class="input-group">
                <label for="accountBalance">ä¿è¯é‡‘ä½™é¢</label>
                <input type="number" id="accountBalance" value="1500">
                <p class="note" id="balanceNote">USDT-M: USDT, Coin-M: æ ‡çš„å¸</p>
            </div>
            <div class="input-group">
                <label for="fundingRate">èµ„é‡‘è´¹ç‡ (Funding, %)</label>
                <input type="number" id="fundingRate" value="0.01">
            </div>
        </div>
        
        <div class="input-grid" style="margin-top: 20px;">
            <div class="input-group">
                <label for="newPositionSize">æ–°å¢å¼ æ•° (N)</label>
                <input type="number" id="newPositionSize" value="0" placeholder="è‹¥æ— æ–°å¢ï¼Œè¯·ä¿æŒä¸º 0">
                <p class="note">ç”¨äºè®¡ç®—å¹³å‡å¼€ä»“ä»·ã€‚</p>
            </div>
            <div class="input-group">
                <label for="newEntryPrice">æ–°å¢æˆäº¤ä»· (P_new)</label>
                <input type="number" id="newEntryPrice" value="0" placeholder="æ–°å¢æˆäº¤ä»·æ ¼">
                <p class="note">è‹¥æ— æ–°å¢ï¼Œè¯·ä¿æŒä¸º 0ã€‚</p>
            </div>
            <div class="input-group">
                <label for="oldEntryPrice">åŸä»“ä½å¼€ä»“ä»· (P_old)</label>
                <input type="number" id="oldEntryPrice" value="0" placeholder="åŸä»“ä½å¼€ä»“ä»·æ ¼">
                <p class="note">è‹¥æ— æ–°å¢ï¼Œæ­¤é¡¹ä¸ P_entry ç›¸åŒã€‚</p>
            </div>
        </div>
    </div>
    
    <div id="optionInputs" class="input-grid hidden" style="margin-top: 20px;">
        <div class="input-group">
            <label for="strikePrice">æœŸæƒæ‰§è¡Œä»·æ ¼ (K)</label>
            <input type="number" id="strikePrice" value="30000">
        </div>
        <div class="input-group">
            <label for="optionPremium">æœŸæƒè´¹ (P) / å‡ä»·</label>
            <input type="number" id="optionPremium" value="500">
        </div>
        <div class="input-group">
            <label for="optionMultiplier">åˆçº¦ä¹˜æ•° (é€šå¸¸ä¸º 1)</label>
            <input type="number" id="optionMultiplier" value="1">
        </div>
        </div>

    <button onclick="calculateAll()">æ‰§è¡Œæ‰€æœ‰è®¡ç®—</button>

    <div id="results">
        <h2>âœ… è®¡ç®—ç»“æœ</h2>
        <div id="resultContent">
            è¯·é€‰æ‹©æ¨¡å¼å’Œè®¡ç®—å†…å®¹å¹¶ç‚¹å‡»è®¡ç®—ã€‚
        </div>
    </div>

    <div class="formula-section">
        <h3 style="color: #007bff;">å½“å‰æ¨¡å¼çš„å…³é”®å…¬å¼ ($LaTeX$)</h3>
        <div id="formulaDisplay">
            </div>
        <p style="margin-top: 15px; font-style: italic; color: #6c757d;">ç‰ˆæœ¬ V3.2.0 - æ–°å¢å†…å®¹é€‰æ‹©åŠŸèƒ½</p>
    </div>
</div>

<script>
    // --- æ ¸å¿ƒå…¬å¼å®ç° (æ²¿ç”¨ V3.1) ---

    function calculateUsdtAvgEntry(M, O, P_old, N, P_new) {
        if (O + N === 0) return P_old; 
        const P_old_calc = (O > 0 && P_old > 0) ? P_old : P_new;
        const S_total = O + N;
        const P_new_calc = (P_new === 0) ? P_old_calc : P_new;

        const numerator = (M * O * P_old_calc) + (M * N * P_new_calc);
        const denominator = M * S_total;
        return numerator / denominator;
    }

    function calculateCoinAvgEntry(M, O, P_old, N, P_new) {
        if (O + N === 0) return P_old;
        const P_old_calc = (O > 0 && P_old > 0) ? P_old : P_new;
        const P_new_calc = (P_new === 0) ? P_old_calc : P_new;
        
        const numerator = M * (O + N);
        const denominator = (M * O / P_old_calc) + (M * N / P_new_calc);
        if (denominator === 0) return 0;
        return numerator / denominator;
    }
    
    function calculateContractProfit(mode, M, S, P_entry, P_mark, direction) {
        if (mode === 'usdt_m') {
            const diff = direction === 'long' ? (P_mark - P_entry) : (P_entry - P_mark);
            return M * S * diff;
        } else if (mode === 'coin_m') {
            const factor = direction === 'long' ? (1 / P_mark - 1 / P_entry) : (1 / P_entry - 1 / P_mark);
            return M * S * factor; 
        }
        return 0;
    }

    function calculateInitialMargin(mode, M, S, P_entry, L) {
        if (L === 0 || P_entry === 0) return 0;
        if (mode === 'usdt_m') {
            return (M * P_entry * S) / L;
        } else if (mode === 'coin_m') {
            return (M * S) / (P_entry * L);
        }
        return 0;
    }
    
    function calculateMaintenanceMargin(mode, M, S, MMR, P_mark) {
        const absS = Math.abs(S);
        const mmr = MMR / 100;
        if (mode === 'usdt_m') {
            return M * absS * mmr * P_mark;
        } else if (mode === 'coin_m') {
            if (P_mark === 0) return 0;
            return (M * absS * mmr) / P_mark;
        }
        return 0;
    }

    function calculateLiquidationPrice(mode, direction, M, S, P_entry, MMR, FeeRate, MarginBalance) {
        const fee = FeeRate / 100;
        const mmr = MMR / 100;
        const S_M = M * S;

        if (mode === 'usdt_m') {
            if (direction === 'long') {
                const numerator = (S_M * P_entry) - (MarginBalance + (S_M * P_entry * fee));
                const denominator = S_M * (1 + mmr);
                return P_entry - (numerator / denominator);
            } else { // short
                const numerator = (S_M * P_entry) + (MarginBalance - (S_M * P_entry * fee));
                const denominator = S_M * (1 - mmr);
                return P_entry + (numerator / denominator);
            }
        }
        
        else if (mode === 'coin_m') {
            if (direction === 'long') {
                const numerator = S_M * (1 + mmr + fee);
                const denominator = (S_M / P_entry) + MarginBalance;
                return numerator / denominator;
            } else { // short
                const numerator = S_M * (1 - mmr - fee);
                const denominator = (S_M / P_entry) - MarginBalance;
                if (denominator <= 0) return Infinity;
                return numerator / denominator;
            }
        }
        return 0;
    }


    function calculateOptionBreakEven(direction, StrikePrice, Premium) {
        if (direction === 'long') {
            return StrikePrice + Premium; 
        } else {
            return StrikePrice - Premium;
        }
    }


    // --- UI æ§åˆ¶ä¸æ€»è®¡ç®—å‡½æ•° ---

    function toggleInputs() {
        const mode = document.getElementById('mode').value;
        const contractInputs = document.getElementById('contractInputs');
        const optionInputs = document.getElementById('optionInputs');
        const calculationSelection = document.getElementById('calculationSelection');
        const faceValueNote = document.getElementById('faceValueNote');
        const balanceNote = document.getElementById('balanceNote');

        // åˆ‡æ¢ä¸»è¾“å…¥åŒºå’Œè®¡ç®—å†…å®¹é€‰æ‹©çš„å¯è§æ€§
        if (mode === 'option') {
            contractInputs.classList.add('hidden');
            optionInputs.classList.remove('hidden');
            calculationSelection.classList.add('hidden'); // æœŸæƒæ¨¡å¼ä¸ä½¿ç”¨æ­¤é€‰æ‹©å™¨
        } else {
            contractInputs.classList.remove('hidden');
            optionInputs.classList.add('hidden');
            calculationSelection.classList.remove('hidden'); 
        }
        
        // åŠ¨æ€æ›´æ–°æç¤º
        if (mode === 'usdt_m') {
            faceValueNote.textContent = 'USDT-Mç¤ºä¾‹: 0.001 BTC/å¼  æˆ– 1 USDT/å¼ ';
            balanceNote.textContent = 'USDT-M: ä¿è¯é‡‘ä½™é¢ä»¥ USDT è®¡ä»·';
        } else if (mode === 'coin_m') {
            faceValueNote.textContent = 'å¸æœ¬ä½ç¤ºä¾‹: 100 (å¼ )/åˆçº¦';
            balanceNote.textContent = 'Coin-M: ä¿è¯é‡‘ä½™é¢ä»¥æ ‡çš„å¸è®¡ä»· (å¦‚ BTC)';
        }
        
        // æ¨¡å¼åˆ‡æ¢æ—¶è‡ªåŠ¨è®¡ç®—ä¸€æ¬¡
        calculateAll();
    }


    function calculateAll() {
        const mode = document.getElementById('mode').value;
        const direction = document.getElementById('direction').value;
        
        // è·å–é€‰ä¸­çš„è®¡ç®—å†…å®¹
        const selectedCalculations = Array.from(document.querySelectorAll('#calculationSelection input:checked')).map(cb => cb.value);

        // é€šç”¨è¾“å…¥
        const M = parseFloat(document.getElementById('contractFaceValue').value);
        const P_entry_old = parseFloat(document.getElementById('entryPrice').value);
        const S_old = parseFloat(document.getElementById('positionSize').value);
        const L = parseFloat(document.getElementById('leverage').value);
        const P_mark = parseFloat(document.getElementById('markPrice').value);
        const MMR = parseFloat(document.getElementById('maintenanceMarginRate').value);
        const FeeRate = parseFloat(document.getElementById('feeRate').value);
        const MarginBalance = parseFloat(document.getElementById('accountBalance').value);
        const FundingRate = parseFloat(document.getElementById('fundingRate').value);
        
        // è¡¥ä»“è¾“å…¥
        const S_new = parseFloat(document.getElementById('newPositionSize').value) || 0;
        const P_entry_new = parseFloat(document.getElementById('newEntryPrice').value) || 0;
        const P_old = parseFloat(document.getElementById('oldEntryPrice').value) || P_entry_old;

        if (isNaN(M) || isNaN(P_entry_old) || isNaN(S_old) || isNaN(P_mark)) {
            document.getElementById('resultContent').innerHTML = "<p style='color:red;'>è¯·è¾“å…¥æœ‰æ•ˆçš„åŸºæœ¬æ•°æ®!</p>";
            document.getElementById('formulaDisplay').innerHTML = "";
            return;
        }

        let resultsHTML = '';
        let formulasHTML = '';

        if (mode === 'usdt_m' || mode === 'coin_m') {
            // --- åˆçº¦æ¨¡å¼è®¡ç®—åŠç»“æœæ”¶é›† ---
            const S_total = S_old + S_new;
            const P_used = (S_new > 0) ? (mode === 'usdt_m' ? calculateUsdtAvgEntry(M, S_old, P_old, S_new, P_entry_new) : calculateCoinAvgEntry(M, S_old, P_old, S_new, P_entry_new)) : P_entry_old;
            
            const P_avg = mode === 'usdt_m' ? calculateUsdtAvgEntry(M, S_old, P_old, S_new, P_entry_new) : calculateCoinAvgEntry(M, S_old, P_old, S_new, P_entry_new);
            const I_Margin = calculateInitialMargin(mode, M, S_total, P_used, L);
            const M_Margin = calculateMaintenanceMargin(mode, M, S_total, MMR, P_mark);
            const PnL = calculateContractProfit(mode, M, S_total, P_used, P_mark, direction);
            const V_position = mode === 'usdt_m' ? (M * S_total * P_mark) : (M * S_total / P_mark);
            const F_cost = V_position * (FundingRate / 100); 
            const P_liq = calculateLiquidationPrice(mode, direction, M, S_total, P_used, MMR, FeeRate, MarginBalance);

            const Equity = MarginBalance + PnL;
            const MarginRatio = (Equity / V_position) * 100;

            const currency = mode === 'usdt_m' ? 'USDT' : 'æ ‡çš„å¸';
            const priceUnit = ' $/å¸';
            const PnL_text = mode === 'coin_m' ? `${PnL.toFixed(6)} ${currency} â‰ˆ ${(PnL * P_mark).toFixed(2)} USDT` : `${PnL.toFixed(2)} ${currency}`;
            const V_text = mode === 'coin_m' ? `${V_position.toFixed(6)} ${currency} â‰ˆ ${(V_position * P_mark).toFixed(2)} USDT` : `${V_position.toFixed(2)} ${currency}`;

            // 1. æ ¹æ®é€‰æ‹©åŠ¨æ€æ·»åŠ ç»“æœ
            if (selectedCalculations.includes('avg')) {
                 resultsHTML += `<div class="result-box"><span class="result-label">å¹³å‡å¼€ä»“ä»· (P_avg):</span> <span class="result-value">${P_avg.toFixed(4)} ${priceUnit}</span></div>`;
            }
            if (selectedCalculations.includes('pnl')) {
                resultsHTML += `<div class="result-box"><span class="result-label">æœªå®ç°ç›ˆäº (PnL):</span> <span class="result-value" style="color:${PnL >= 0 ? 'green' : 'red'};">${PnL_text}</span></div>`;
            }
            if (selectedCalculations.includes('immm')) {
                resultsHTML += `
                    <div class="result-box"><span class="result-label">åˆå§‹ä¿è¯é‡‘ (IM):</span> <span class="result-value">${I_Margin.toFixed(4)} ${currency}</span></div>
                    <div class="result-box"><span class="result-label">ç»´æŒä¿è¯é‡‘ (MM):</span> <span class="result-value">${M_Margin.toFixed(4)} ${currency}</span></div>
                    <div class="result-box"><span class="result-label">å½“å‰ä¿è¯é‡‘ç‡ (å…¨ä»“):</span> <span class="result-value" style="color:${MarginRatio > MMR ? 'green' : 'orange'};">${MarginRatio.toFixed(2)}%</span></div>
                `;
            }
            if (selectedCalculations.includes('liq')) {
                resultsHTML += `<div class="result-box"><span class="result-label">é¢„ä¼°å¼ºå¹³ä»· (P_liq):</span> <span class="result-value" style="color:#dc3545;">${P_liq.toFixed(4)} ${priceUnit}</span></div>`;
            }
            if (selectedCalculations.includes('value')) {
                resultsHTML += `
                    <div class="result-box"><span class="result-label">ä»“ä½ä»·å€¼ (V):</span> <span class="result-value">${V_text}</span></div>
                    <div class="result-box"><span class="result-label">é¢„ä¼°èµ„é‡‘è´¹ç”¨ (FF):</span> <span class="result-value">${F_cost.toFixed(4)} ${currency}</span></div>
                `;
            }


            // 2. å…¬å¼å±•ç¤º (å§‹ç»ˆæ˜¾ç¤ºæ‰€æœ‰ç›¸å…³å…¬å¼)
            if (mode === 'usdt_m') {
                formulasHTML += `
                    $$ P_{\\text{avg}} = \\frac{M \\cdot O \\cdot P_{\\text{old}} + M \\cdot N \\cdot P_{\\text{new}}}{M \\cdot (O + N)} $$
                    $$ \\text{PnL} = M \\cdot S \\cdot (P_{\\text{mark}} - P_{\\text{entry}}) $$
                    $$ \\text{MM} = M \\cdot S \\cdot MMR \\cdot P_{\\text{mark}} $$
                    $$ P_{\\text{liq}} \\approx P_{\\text{entry}} + \\frac{M \\cdot S \\cdot P_{\\text{entry}} \\cdot (\\text{Fee}) - \\text{MarginBalance}}{M \\cdot S \\cdot (1 + MMR)} \\quad (\\text{Long}) $$
                `;
            } else { // coin_m
                formulasHTML += `
                    $$ P_{\\text{avg}} = \\frac{M \\cdot (O + N)}{M \\cdot O/P_{\\text{old}} + M \\cdot N/P_{\\text{new}}} $$
                    $$ \\text{PnL} = M \\cdot S \\cdot \\left(\\frac{1}{P_{\\text{mark}}} - \\frac{1}{P_{\\text{entry}}}\\right) \\quad (\\text{Short}) $$
                    $$ \\text{MM} = \\frac{M \\cdot S \\cdot MMR}{P_{\\text{mark}}} $$
                    $$ P_{\\text{liq\\_long}} = \\frac{M \\cdot S \\cdot (1 + MMR + \\text{Fee})}{\\frac{M \\cdot S}{P_{\\text{entry}}} + \\text{MarginBalance}} $$
                `;
            }
            if (resultsHTML === '') {
                 resultsHTML = '<p style="color:orange;">è¯·å‹¾é€‰æ‚¨æƒ³è¦è®¡ç®—å’Œæ˜¾ç¤ºçš„å†…å®¹ã€‚</p>';
            }

        } else if (mode === 'option') {
            // --- æœŸæƒæ¨¡å¼è®¡ç®— (æ— é€‰æ‹©å™¨ï¼Œå…¨æ˜¾ç¤º) ---
            const TotalPremium = OptionPremium * Multiplier * S_old; 
            const BEP = calculateOptionBreakEven(direction, StrikePrice, OptionPremium);
            const OptionValue = StrikePrice * Multiplier * S_old; 
            
            resultsHTML += `
                <div class="result-box"><span class="result-label">æ€»æœŸæƒè´¹æ”¯å‡º/æ”¶å…¥:</span> <span class="result-value" style="color:${direction === 'long' ? 'red' : 'green'};">${TotalPremium.toFixed(4)} $</span></div>
                <div class="result-box"><span class="result-label">ç›ˆäºå¹³è¡¡ç‚¹ (BEP):</span> <span class="result-value" style="color:#007bff;">${BEP.toFixed(4)} $</span></div>
                <div class="result-box"><span class="result-label">æœŸæƒåä¹‰å¸‚å€¼:</span> <span class="result-value">${OptionValue.toFixed(4)} $</span></div>
                <div class="result-box"><span class="result-label">æ‰§è¡Œä»·æ ¼ (K):</span> <span class="result-value">${StrikePrice.toFixed(4)} $</span></div>
                <div class="result-box"><span class="result-label">æœŸæƒè´¹/å¼  (P):</span> <span class="result-value">${OptionPremium.toFixed(4)} $</span></div>
            `;
            
            formulasHTML += `
                $$ \\text{æ€»æœŸæƒè´¹} = P \\cdot \\text{ä¹˜æ•°} \\cdot \\text{å¼ æ•°} $$
                $$ P_{\\text{BEP\_ä¹°å…¥}} = K + P $$
                $$ P_{\\text{BEP\_å–å‡º}} = K - P $$
            `;
        }

        document.getElementById('resultContent').innerHTML = resultsHTML;
        document.getElementById('formulaDisplay').innerHTML = formulasHTML;
        
        // é‡æ–°æ¸²æŸ“ MathJax å…¬å¼
        if (typeof MathJax !== 'undefined') {
            MathJax.typesetPromise();
        }
    }

    // åˆå§‹åŒ–è°ƒç”¨
    document.addEventListener('DOMContentLoaded', () => {
        toggleInputs(); 
        calculateAll();
        // ç»‘å®šè®¡ç®—å†…å®¹é€‰æ‹©çš„ change äº‹ä»¶
        document.getElementById('calculationSelection').addEventListener('change', calculateAll);
    });
</script>

</body>
</html>
