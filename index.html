<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆçº¦æ¸…ç®—ä»·æ ¼è®¡ç®—å™¨ (å®Œæ•´ç‰ˆ)</title>
    
    <script type="text/javascript" id="MathJax-script" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
    </script>

    <style>
        /* å…¨å±€æ ·å¼å’Œæµ…è‰²ä¸»é¢˜åŸºç¡€ */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa; /* ææµ…ç°èƒŒæ™¯ */
            color: #333333; /* ç¢³ç°æ–‡å­— */
            padding: 20px;
            margin: 0;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #ffffff; /* çº¯ç™½å†…å®¹åŒºåŸŸèƒŒæ™¯ */
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); /* æŸ”å’Œé˜´å½± */
        }

        /* æ ‡é¢˜æ ·å¼ */
        h1 {
            color: #004d99; /* ä¸“ä¸šé‡‘èè“ */
            text-align: center;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 15px;
            margin-top: 0;
            margin-bottom: 30px;
        }
        
        /* é…ç½®åŒºåŸŸï¼Œç”¨äºåˆçº¦ç±»å‹å’Œä¿è¯é‡‘æ¨¡å¼ */
        .config-row {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px dashed #e9ecef;
        }

        /* è¾“å…¥ç»„æ ·å¼ */
        .input-group {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
        }

        .input-group label, .config-row label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #007bff; /* å®è“è‰²æ ‡ç­¾ */
        }

        .input-group input[type="number"],
        .input-group select,
        .config-row select {
            padding: 12px;
            border: 1px solid #ced4da; /* æµ…è¾¹æ¡† */
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .input-group input[type="number"]:focus,
        .input-group select:focus,
        .config-row select:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
            outline: none;
        }
        
        /* é’ˆå¯¹é€ä»“/å…¨ä»“æ¨¡å¼ä¸‹è¾“å…¥é¡¹çš„æ˜¾ç¤º/éšè— */
        .mode-specific {
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        
        .mode-specific.active {
            display: flex;
            opacity: 1;
        }


        /* æŒ‰é’®æ ·å¼ */
        button {
            background-color: #28a745; /* ç»¿è‰²æŒ‰é’® */
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 700;
            transition: background-color 0.3s, transform 0.1s;
            width: 100%;
            margin-top: 10px;
        }

        button:hover {
            background-color: #218838; /* é¼ æ ‡æ‚¬åœå˜æ·± */
        }

        /* ç»“æœåŒºåŸŸæ ·å¼ */
        #results {
            margin-top: 40px;
            padding: 20px;
            border-top: 3px dashed #e9ecef;
        }

        .result-box {
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 8px;
            border-left: 5px solid #007bff; /* å®è“è‰²å·¦ä¾§ç‚¹ç¼€ */
            background-color: #f1f7fe; /* ææµ…è“è‰²èƒŒæ™¯ */
        }

        .result-box p {
            margin: 0;
            font-size: 16px;
        }

        .result-label {
            font-weight: 600;
            color: #004d99;
            margin-right: 10px;
        }

        .result-value {
            font-size: 18px;
            font-weight: 700;
        }

        /* æ¸…ç®—ä»·æ ¼å’Œæ æ†é«˜äº® */
        #liquidationPrice {
            color: #dc3545; /* çº¢è‰²é«˜äº®æ¸…ç®—ä»· */
            font-size: 24px;
        }

        /* å…¬å¼åŒºåŸŸæ ·å¼ */
        .formula-section {
            margin-top: 30px;
            padding: 15px;
            background-color: #e9ecef; /* æµ…ç°èƒŒæ™¯ */
            border-radius: 8px;
            font-size: 14px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ“ åŠ å¯†è´§å¸åˆçº¦æ¸…ç®—ä»·æ ¼è®¡ç®—å™¨</h1>
    
    <div class="config-row">
        <div class="input-group" style="flex: 1;">
            <label for="contractType">åˆçº¦ç±»å‹</label>
            <select id="contractType">
                <option value="usdt">U æœ¬ä½ (USDT-M)</option>
                <option value="coin">å¸ æœ¬ä½ (Coin-M)</option>
            </select>
        </div>
        <div class="input-group" style="flex: 1;">
            <label for="marginMode">ä¿è¯é‡‘æ¨¡å¼</label>
            <select id="marginMode" onchange="toggleMarginInputs()">
                <option value="isolated">é€ä»“ (Isolated)</option>
                <option value="cross">å…¨ä»“ (Cross)</option>
            </select>
        </div>
    </div>
    
    <div class="input-group">
        <label for="direction">ä»“ä½æ–¹å‘</label>
        <select id="direction">
            <option value="long">åšå¤š (Long)</option>
            <option value="short">åšç©º (Short)</option>
        </select>
    </div>
    
    <div class="input-group">
        <label for="entryPrice">å¼€ä»“ä»·æ ¼ ($/å¸)</label>
        <input type="number" id="entryPrice" placeholder="ä¾‹å¦‚: 30000" value="30000">
    </div>

    <div class="input-group">
        <label for="currentMarkPrice">å½“å‰æ ‡è®°ä»·æ ¼ ($/å¸)</label>
        <input type="number" id="currentMarkPrice" placeholder="ç”¨äºè®¡ç®—æµ®åŠ¨ç›ˆäº, ä¾‹å¦‚: 30500" value="30500">
    </div>

    <div class="input-group">
        <label for="positionSize">å¼€ä»“æ•°é‡ (å¸)</label>
        <input type="number" id="positionSize" placeholder="ä¾‹å¦‚: 1" value="1">
    </div>
    
    <div id="isolatedInputs" class="mode-specific active">
        <div class="input-group">
            <label for="initialMargin">èµ·å§‹ä¿è¯é‡‘ (USDT/å¸)</label>
            <input type="number" id="initialMargin" placeholder="è¯¥ä»“ä½æŠ•å…¥çš„æœ¬é‡‘ (é»˜è®¤: ä»·å€¼/æ æ†)" value="1500">
        </div>
    </div>
    
    <div id="crossInputs" class="mode-specific">
        <div class="input-group">
            <label for="accountBalance">è´¦æˆ·å¯ç”¨ä½™é¢ (USDT/å¸)</label>
            <input type="number" id="accountBalance" placeholder="å…¨ä»“ä¸‹å‰©ä½™å¯ç”¨äºåˆ†æ‘ŠäºæŸçš„èµ„é‡‘" value="5000">
        </div>
    </div>
    
    <div class="input-group">
        <label for="unrealizedPnl">æœªå®ç°ç›ˆäº (USDT/å¸)</label>
        <input type="number" id="unrealizedPnl" placeholder="æµ®åŠ¨ç›ˆäºï¼Œé»˜è®¤æ ¹æ®å¼€ä»“ä»·å’Œæ ‡è®°ä»·è®¡ç®—" value="0" disabled>
    </div>

    <div class="input-group">
        <label for="leverage">åä¹‰æ æ†å€æ•° (X)</label>
        <input type="number" id="leverage" placeholder="ä¾‹å¦‚: 20" value="20">
    </div>

    <div class="input-group">
        <label for="maintenanceMarginRate">ç»´æŒä¿è¯é‡‘ç‡ (%)</label>
        <input type="number" id="maintenanceMarginRate" placeholder="ä¾‹å¦‚: 0.5" value="0.5">
    </div>

    <div class="input-group">
        <label for="fee">å¼€ä»“/å¹³ä»“æ‰‹ç»­è´¹ç‡ (%)</label>
        <input type="number" id="fee" placeholder="ä¾‹å¦‚: 0.05" value="0.05">
    </div>

    <div class="input-group">
        <label for="fundingRate">é¢„è®¡èµ„é‡‘è´¹ç‡ (%) (ä»…ä½œä¼°ç®—)</label>
        <input type="number" id="fundingRate" placeholder="ä¾‹å¦‚: 0.01" value="0.01">
    </div>

    <button onclick="calculateLiquidationPrice()">è®¡ç®—æ¸…ç®—ä»·æ ¼</button>

    <div id="results">
        <div class="result-box">
            <p><span class="result-label">æ¸…ç®—ä»·æ ¼:</span> <span class="result-value" id="liquidationPrice">--</span></p>
        </div>
        <div class="result-box">
            <p><span class="result-label">æ€»ä¿è¯é‡‘ (å« P&L):</span> <span class="result-value" id="totalMargin">--</span></p>
        </div>
        <div class="result-box">
            <p><span class="result-label">ç»´æŒä¿è¯é‡‘è¦æ±‚:</span> <span class="result-value" id="maintenanceMarginRequired">--</span></p>
        </div>
        <div class="result-box">
            <p><span class="result-label">è·ç¦»æ¸…ç®—ç™¾åˆ†æ¯”:</span> <span class="result-value" id="distanceToLiquidation">--</span></p>
        </div>
    </div>

    <div class="formula-section">
        <p>ä½¿ç”¨çš„è®¡ç®—å…¬å¼ (åŸºäº **USDT-M é€ä»“** ç®€åŒ–):</p>
        <p>å¯ç”¨ä¿è¯é‡‘ = èµ·å§‹ä¿è¯é‡‘ + æœªå®ç°ç›ˆäº - èµ„é‡‘è´¹ - å¹³ä»“æ‰‹ç»­è´¹</p>
        <p>æ¸…ç®—æ—¶ç›ˆäº = ç»´æŒä¿è¯é‡‘è¦æ±‚ - æ€»ä¿è¯é‡‘</p>
        <p>æ¸…ç®—ä»·æ ¼æœ€ç»ˆç”±æ¸…ç®—æ—¶ç›ˆäº $ / \text{åˆçº¦ä»·å€¼å˜åŠ¨}$ å†³å®šã€‚</p>
        <p style="margin-top: 15px; font-style: italic; color: #6c757d;">ç‰ˆæœ¬ V2.0.2 - å®Œæ•´åˆçº¦åŠŸèƒ½å®ç°</p>
    </div>
</div>

<script>
    /**
     * åˆ‡æ¢ä¿è¯é‡‘æ¨¡å¼æ—¶ï¼Œæ˜¾ç¤º/éšè—å¯¹åº”çš„è¾“å…¥æ¡†
     */
    function toggleMarginInputs() {
        const mode = document.getElementById('marginMode').value;
        const isolatedDiv = document.getElementById('isolatedInputs');
        const crossDiv = document.getElementById('crossInputs');

        if (mode === 'isolated') {
            isolatedDiv.classList.add('active');
            crossDiv.classList.remove('active');
        } else { // cross
            crossDiv.classList.add('active');
            isolatedDiv.classList.remove('active');
        }
        // æ¨¡å¼åˆ‡æ¢åé‡æ–°è®¡ç®—ï¼Œä»¥æ›´æ–°é»˜è®¤å€¼
        calculateLiquidationPrice(); 
    }

    /**
     * è®¡ç®—æœªå®ç°ç›ˆäº (Unrealized P&L)
     * @param {number} entryPrice - å¼€ä»“ä»·æ ¼
     * @param {number} markPrice - å½“å‰æ ‡è®°ä»·æ ¼
     * @param {number} positionSize - ä»“ä½æ•°é‡
     * @param {string} direction - ä»“ä½æ–¹å‘ ('long'/'short')
     * @param {string} contractType - åˆçº¦ç±»å‹ ('usdt'/'coin')
     * @returns {number} æœªå®ç°ç›ˆäºé‡‘é¢
     */
    function calculatePnl(entryPrice, markPrice, positionSize, direction, contractType) {
        if (contractType === 'usdt') {
            // Uæœ¬ä½: ç›ˆäº = (å¹³ä»“ä»· - å¼€ä»“ä»·) * æ•°é‡ * æ–¹å‘
            const diff = direction === 'long' ? (markPrice - entryPrice) : (entryPrice - markPrice);
            return diff * positionSize;
        } else {
            // å¸æœ¬ä½: ç›ˆäº = (1/å¼€ä»“ä»· - 1/å¹³ä»“ä»·) * æ•°é‡ * åˆçº¦ä¹˜æ•°
            // ç®€åŒ–ä¸º (1/å¼€ä»“ä»· - 1/æ ‡è®°ä»·) * æ•°é‡ (USDTè®¡ä»·)
            const diff = direction === 'long' ? (1 / entryPrice - 1 / markPrice) : (1 / markPrice - 1 / entryPrice);
            return diff * positionSize * markPrice * entryPrice; // è¿‘ä¼¼è®¡ç®—ï¼Œå®é™…åº”æ ¹æ®åˆçº¦é¢å€¼
        }
    }


    /**
     * æ ¸å¿ƒæ¸…ç®—ä»·æ ¼è®¡ç®—å‡½æ•°
     */
    function calculateLiquidationPrice() {
        // 1. è·å–è¾“å…¥å€¼
        const contractType = document.getElementById('contractType').value;
        const marginMode = document.getElementById('marginMode').value;
        const direction = document.getElementById('direction').value;
        
        const entryPrice = parseFloat(document.getElementById('entryPrice').value);
        const currentMarkPrice = parseFloat(document.getElementById('currentMarkPrice').value);
        const positionSize = parseFloat(document.getElementById('positionSize').value);
        const leverage = parseFloat(document.getElementById('leverage').value);

        const mmRate = parseFloat(document.getElementById('maintenanceMarginRate').value) / 100;
        const totalFeeRate = (parseFloat(document.getElementById('fee').value) * 2 + parseFloat(document.getElementById('fundingRate').value)) / 100; // å¼€+å¹³æ‰‹ç»­è´¹ + èµ„é‡‘è´¹

        // 2. åŸºæœ¬æ ¡éªŒ
        if (!entryPrice || !currentMarkPrice || !positionSize || !leverage || isNaN(mmRate)) {
            document.getElementById('liquidationPrice').textContent = "æ•°æ®ä¸å®Œæ•´";
            return;
        }
        
        // 3. è®¡ç®—æœªå®ç°ç›ˆäº (P&L) å¹¶æ›´æ–°è¾“å…¥æ¡†
        const unrealizedPnl = calculatePnl(entryPrice, currentMarkPrice, positionSize, direction, contractType);
        document.getElementById('unrealizedPnl').value = unrealizedPnl.toFixed(4);


        // 4. è®¡ç®—ä¿è¯é‡‘åŸºæ•°
        
        // (1) åä¹‰ä»“ä½ä»·å€¼ (Value) - ç»Ÿä¸€ä»¥ USD è®¡ä»·
        const positionValue = entryPrice * positionSize;
        
        // (2) ç»´æŒä¿è¯é‡‘ (MMR) - è§¦å‘æ¸…ç®—çš„é—¨æ§›
        // MMR = æ ‡è®°ä»·æ ¼ * ä»“ä½æ•°é‡ * ç»´æŒä¿è¯é‡‘ç‡
        const maintenanceMarginRequired = currentMarkPrice * positionSize * mmRate;
        
        // (3) æ€»å¯ç”¨ä¿è¯é‡‘ (Total Equity) - ç”¨äºæŠµæŠ—äºæŸçš„èµ„é‡‘
        let totalEquity;
        let initialMargin;

        if (marginMode === 'isolated') {
            // é€ä»“æ¨¡å¼: æŠ•å…¥çš„èµ·å§‹ä¿è¯é‡‘ + æœªå®ç°ç›ˆäº - æˆæœ¬
            initialMargin = parseFloat(document.getElementById('initialMargin').value) || (positionValue / leverage);
            totalEquity = initialMargin + unrealizedPnl;
        } else { // cross (å…¨ä»“)
            // å…¨ä»“æ¨¡å¼: è´¦æˆ·å¯ç”¨ä½™é¢ + æ‰€æœ‰ä»“ä½çš„åˆå§‹ä¿è¯é‡‘ + æ‰€æœ‰ä»“ä½çš„æœªå®ç°ç›ˆäº
            // ç®€åŒ–ä¸ºï¼šè´¦æˆ·å¯ç”¨ä½™é¢ + å½“å‰ä»“ä½çš„èµ·å§‹ä¿è¯é‡‘ (Value/Leverage) + å½“å‰ä»“ä½çš„æœªå®ç°ç›ˆäº
            const accountBalance = parseFloat(document.getElementById('accountBalance').value);
            initialMargin = positionValue / leverage;
            totalEquity = accountBalance + initialMargin + unrealizedPnl;
        }

        // 5. æ ¸å¿ƒæ¸…ç®—ä»·æ ¼è®¡ç®—

        // æ¸…ç®—éœ€è¦çš„äºæŸé‡‘é¢ (LossNeeded)
        // LossNeeded = æ€»å¯ç”¨ä¿è¯é‡‘ - ç»´æŒä¿è¯é‡‘è¦æ±‚ - äº¤æ˜“æˆæœ¬ (æ‰‹ç»­è´¹+èµ„é‡‘è´¹)
        const totalCost = positionValue * totalFeeRate;
        const lossNeeded = totalEquity - maintenanceMarginRequired - totalCost;
        
        let liquidationPrice;
        let percentageChange;

        if (contractType === 'usdt') {
            // Uæœ¬ä½: PnL = (P_æ¸…ç®— - P_å¼€ä»“) * Size
            // å˜åŠ¨ä»·æ ¼ = LossNeeded / Size
            const priceChange = lossNeeded / positionSize;

            if (direction === 'long') {
                // æ¸…ç®—ä»·æ ¼ = P_å¼€ä»“ - å˜åŠ¨ä»·æ ¼
                liquidationPrice = entryPrice - priceChange;
                percentageChange = (entryPrice - liquidationPrice) / entryPrice * 100;
            } else { // short
                // æ¸…ç®—ä»·æ ¼ = P_å¼€ä»“ + å˜åŠ¨ä»·æ ¼
                liquidationPrice = entryPrice + priceChange;
                percentageChange = (liquidationPrice - entryPrice) / entryPrice * 100;
            }
        } else {
            // å¸æœ¬ä½: PnL = Size * (1/P_å¼€ä»“ - 1/P_æ¸…ç®—) * åˆçº¦ä¹˜æ•°
            // å¸æœ¬ä½è®¡ç®—éå¸¸å¤æ‚ï¼Œè¿™é‡Œé‡‡ç”¨ç®€åŒ– Uæœ¬ä½é€»è¾‘ï¼Œä½†å»ºè®®ç”¨æˆ·åœ¨å¸æœ¬ä½ä¸‹ä½¿ç”¨äº¤æ˜“æ‰€æ•°æ®
            // è­¦å‘Š: å¸æœ¬ä½æ¸…ç®—ä»·è®¡ç®—å› åˆçº¦é¢å€¼å’Œä¹˜æ•°ä¸åŒè€Œå¤æ‚ï¼Œæ­¤å¤„ä¸ºè¿‘ä¼¼å€¼
            const priceChange = lossNeeded / positionSize;
            if (direction === 'long') {
                liquidationPrice = entryPrice - priceChange;
                percentageChange = (entryPrice - liquidationPrice) / entryPrice * 100;
            } else {
                liquidationPrice = entryPrice + priceChange;
                percentageChange = (liquidationPrice - entryPrice) / entryPrice * 100;
            }
        }
        
        // 6. ç»“æœè¾“å‡º
        const currencySymbol = contractType === 'usdt' ? 'USDT' : 'å¸';
        
        document.getElementById('liquidationPrice').textContent = liquidationPrice.toFixed(4) + ' $';
        document.getElementById('totalMargin').textContent = totalEquity.toFixed(2) + ' ' + currencySymbol;
        document.getElementById('maintenanceMarginRequired').textContent = maintenanceMarginRequired.toFixed(2) + ' ' + currencySymbol;

        const changeDirection = direction === 'long' ? "ä¸‹è·Œ" : "ä¸Šæ¶¨";
        document.getElementById('distanceToLiquidation').textContent = `${changeDirection} ${Math.abs(percentageChange).toFixed(2)} %`;
        
        // ç¡®ä¿ MathJax é‡æ–°æ¸²æŸ“å…¬å¼
        if (typeof MathJax !== 'undefined') {
            MathJax.typesetPromise();
        }
    }

    // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æ‰§è¡Œ
    document.addEventListener('DOMContentLoaded', () => {
        toggleMarginInputs(); // åˆå§‹åŒ–è¾“å…¥æ¡†æ˜¾ç¤º
        calculateLiquidationPrice(); // ä½¿ç”¨é»˜è®¤å€¼è®¡ç®—
    });
</script>

</body>
</html>
