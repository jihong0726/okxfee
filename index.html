<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº¤æ˜“è®¡ç®—å…¬å¼å…¨èƒ½å·¥å…·ç®± V4.0</title>
    
    <script type="text/javascript" id="MathJax-script" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
    </script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f8f9fa; color: #333; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background-color: #ffffff; padding: 30px; border-radius: 12px; box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1); }
        h1 { color: #004d99; text-align: center; border-bottom: 3px solid #007bff; padding-bottom: 15px; margin-bottom: 30px; }
        
        /* é¡¶éƒ¨é…ç½®åŒº */
        .config-row { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 20px; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px dashed #ced4da; }
        
        /* è®¡ç®—å†…å®¹é€‰æ‹©åŒº */
        #calculationSelection { background-color: #f0f8ff; padding: 15px; border-radius: 8px; margin-bottom: 25px; border: 1px solid #cceeff; }
        #calculationSelection h3 { margin-top: 0; color: #007bff; font-size: 1.1em; }
        .checkbox-group { display: flex; flex-wrap: wrap; gap: 10px 20px; }
        .checkbox-group input[type="checkbox"] { margin-right: 5px; }
        .checkbox-group label { font-weight: normal; color: #333; cursor: pointer; display: flex; align-items: center; }

        /* è¾“å…¥åŒº */
        #inputArea { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
        .input-group { display: flex; flex-direction: column; }
        .input-group label { font-weight: 600; margin-bottom: 6px; color: #007bff; font-size: 0.95em; }
        input[type="number"], select { padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 15px; width: 100%; box-sizing: border-box; }
        
        button { background-color: #28a745; color: white; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 18px; font-weight: 700; width: 100%; margin-top: 25px; transition: background-color 0.3s; }
        button:hover { background-color: #218838; }
        
        /* ç»“æœåŒº */
        #results { margin-top: 40px; padding: 20px; border-top: 3px solid #007bff; background-color: #f1f7fe; border-radius: 8px; }
        .result-box { margin-bottom: 10px; padding: 10px; border-left: 5px solid #004d99; background-color: #e9f3ff; border-radius: 4px; display: flex; justify-content: space-between; }
        .result-label { font-weight: 700; color: #333; }
        .result-value { font-size: 18px; font-weight: 700; color: #dc3545; }
        .formula-section { margin-top: 30px; padding: 15px; background-color: #e9ecef; border-radius: 8px; font-size: 14px; }
        
        .hidden { display: none !important; }
        .note { color: #888; margin-top: 3px; font-size: 0.8em; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ§® äº¤æ˜“è®¡ç®—å…¬å¼å…¨èƒ½å·¥å…·ç®± V4.0</h1>
    
    <div class="config-row">
        <div class="input-group">
            <label for="mode">é€‰æ‹©äº¤æ˜“åŒº</label>
            <select id="mode" onchange="toggleInputs()">
                <option value="usdt_m" selected>1. U æœ¬ä½åˆçº¦ (USDT-M)</option>
                <option value="coin_m">2. å¸æœ¬ä½åˆçº¦ (Coin-M)</option>
                <option value="avg_price">3. å¼€ä»“å‡ä»·è®¡ç®—</option>
                <option value="spot_leverage">4. ç°è´§æ æ†/å€Ÿè´·</option>
                <option value="option">5. æœŸæƒäº¤æ˜“ (Options)</option>
            </select>
        </div>
        <div class="input-group" id="directionGroup">
            <label for="direction">ä»“ä½æ–¹å‘</label>
            <select id="direction">
                <option value="long">åšå¤š (Long)</option>
                <option value="short">åšç©º (Short)</option>
            </select>
        </div>
        <div class="input-group" id="marginModeGroup">
            <label for="marginMode">ä¿è¯é‡‘æ¨¡å¼</label>
            <select id="marginMode">
                <option value="cross">å…¨ä»“ (Cross)</option>
                <option value="isolated">é€ä»“ (Isolated)</option>
            </select>
        </div>
    </div>
    
    <div id="calculationSelection">
        <h3>ğŸ¯ è¯·é€‰æ‹©è®¡ç®—ç»†é¡¹:</h3>
        <div class="checkbox-group" id="calculationCheckboxes">
            </div>
    </div>
    
    <div id="inputArea">
        </div>

    <button onclick="calculateAll()">æ‰§è¡Œè®¡ç®—</button>

    <div id="results">
        <h2>âœ… è®¡ç®—ç»“æœ</h2>
        <div id="resultContent">
            è¯·é€‰æ‹©æ¨¡å¼å’Œè®¡ç®—ç»†é¡¹å¹¶ç‚¹å‡»æ‰§è¡Œè®¡ç®—ã€‚
        </div>
    </div>

    <div class="formula-section">
        <h3 style="color: #007bff;">å½“å‰æ¨¡å¼çš„å…³é”®å…¬å¼ ($LaTeX$)</h3>
        <div id="formulaDisplay">
            </div>
        <p style="margin-top: 15px; font-style: italic; color: #6c757d;">ç‰ˆæœ¬ V4.0.0 - å®ç°ä¸¤çº§åŠ¨æ€é€‰æ‹©</p>
    </div>
</div>

<script>
    // --- ç»†é¡¹é…ç½®è¡¨ ---
    const CALC_ITEMS_CONFIG = {
        'usdt_m': {
            title: 'Uæœ¬ä½åˆçº¦è®¡ç®—',
            items: {
                'avg': 'å¼€ä»“å‡ä»·',
                'pnl': 'åˆçº¦æ”¶ç›Š/æ”¶ç›Šç‡',
                'fee': 'æ‰‹ç»­è´¹',
                'immm': 'å¼€ä»“/ç»´æŒä¿è¯é‡‘',
                'mmr': 'ç»´æŒä¿è¯é‡‘ç‡/è·¨å¸ç§MMR',
                'value': 'ä»“ä½ä»·å€¼/èµ„é‡‘è´¹ç”¨',
                'liq': 'é¢„ä¼°å¼ºå¹³ä»·'
            }
        },
        'coin_m': {
            title: 'å¸æœ¬ä½åˆçº¦è®¡ç®—',
            items: {
                'avg': 'å¼€ä»“å‡ä»·',
                'pnl': 'åˆçº¦æ”¶ç›Š/æ”¶ç›Šç‡',
                'fee': 'æ‰‹ç»­è´¹',
                'immm': 'å¼€ä»“/ç»´æŒä¿è¯é‡‘',
                'value': 'ä»“ä½ä»·å€¼/èµ„é‡‘è´¹ç”¨',
                'liq': 'é¢„ä¼°å¼ºå¹³ä»·'
            }
        },
        'avg_price': {
            title: 'å¼€ä»“å‡ä»·è®¡ç®—',
            items: {
                'usdt_avg': 'Uæœ¬ä½å¼€ä»“å‡ä»·',
                'coin_avg': 'å¸æœ¬ä½å¼€ä»“å‡ä»·'
            }
        },
        'spot_leverage': {
            title: 'ç°è´§æ æ†è®¡ç®—',
            items: {
                'liquidation_price': 'é¢„ä¼°çˆ†ä»“ä»·',
                'interest_cost': 'åˆ©æ¯è´¹ç”¨',
                'max_leverage': 'æœ€é«˜å¯å€Ÿ/æœ€å¤§æ æ†'
            }
        },
        'option': {
            title: 'æœŸæƒè®¡ç®—',
            items: {
                'premium_fee': 'æ€»æœŸæƒè´¹',
                'bep': 'ç›ˆäºå¹³è¡¡ç‚¹',
                'value': 'æœŸæƒåä¹‰å¸‚å€¼'
            }
        }
    };

    // --- è¾“å…¥å­—æ®µé…ç½®è¡¨ ---
    // key: è¾“å…¥æ¡†ID, value: { label: æ ‡ç­¾, default: é»˜è®¤å€¼, note: æç¤º, visibleModes: éœ€æ˜¾ç¤ºçš„æ¨¡å¼/ç»†é¡¹ (æ•°ç»„)}
    const INPUT_FIELDS_CONFIG = {
        // é€šç”¨å­—æ®µ
        'contractFaceValue': { label: 'åˆçº¦é¢å€¼ (M)', default: '10', note: 'å¸æœ¬ä½: 10/100, Uæœ¬ä½: 1/0.001', visibleModes: ['usdt_m', 'coin_m', 'option'] },
        'entryPrice': { label: 'å½“å‰å¼€ä»“å‡ä»· (P_entry)', default: '30000', visibleModes: ['usdt_m', 'coin_m', 'option', 'spot_leverage'] },
        'positionSize': { label: 'å½“å‰æ€»æŒä»“å¼ æ•° (S)', default: '100', visibleModes: ['usdt_m', 'coin_m', 'option'] },
        'leverage': { label: 'æ æ†å€æ•° (L)', default: '20', visibleModes: ['usdt_m', 'coin_m', 'spot_leverage'] },
        'markPrice': { label: 'æ ‡è®°ä»·æ ¼ (P_mark)', default: '30500', visibleModes: ['usdt_m', 'coin_m', 'option'] },
        
        // ä¿è¯é‡‘/è´¹ç”¨/å¼ºå¹³ç›¸å…³
        'maintenanceMarginRate': { label: 'ç»´æŒä¿è¯é‡‘ç‡ (MMR, %)', default: '0.5', visibleModes: ['usdt_m', 'coin_m', 'spot_leverage'] },
        'feeRate': { label: 'æ‰‹ç»­è´¹ç‡ (Fee, %)', default: '0.05', visibleModes: ['usdt_m', 'coin_m'] },
        'accountBalance': { label: 'ä¿è¯é‡‘ä½™é¢', default: '1500', note: 'Uæœ¬ä½: USDT, å¸æœ¬ä½: æ ‡çš„å¸', visibleModes: ['usdt_m', 'coin_m', 'spot_leverage'] },
        'fundingRate': { label: 'èµ„é‡‘è´¹ç‡ (Funding, %)', default: '0.01', visibleModes: ['usdt_m', 'coin_m'] },
        'loanAmount': { label: 'å€Ÿå…¥é‡‘é¢/æ•°é‡', default: '0', note: 'ç°è´§æ æ†æ¨¡å¼ä¸‹ä½¿ç”¨', visibleModes: ['spot_leverage'] },

        // å‡ä»·è®¡ç®—ç›¸å…³
        'newPositionSize': { label: 'æ–°å¢å¼ æ•° (N)', default: '0', visibleModes: ['usdt_m', 'coin_m', 'avg_price'] },
        'newEntryPrice': { label: 'æ–°å¢æˆäº¤ä»· (P_new)', default: '0', visibleModes: ['usdt_m', 'coin_m', 'avg_price'] },
        'oldPositionSize': { label: 'åŸä»“ä½å¼ æ•° (O)', default: '100', visibleModes: ['avg_price'] },
        'oldEntryPrice': { label: 'åŸä»“ä½å¼€ä»“ä»· (P_old)', default: '30000', visibleModes: ['avg_price'] },

        // æœŸæƒç›¸å…³
        'strikePrice': { label: 'æœŸæƒæ‰§è¡Œä»·æ ¼ (K)', default: '30000', visibleModes: ['option'] },
        'optionPremium': { label: 'æœŸæƒè´¹ (P) / å‡ä»·', default: '500', visibleModes: ['option'] },
        'optionMultiplier': { label: 'åˆçº¦ä¹˜æ•°', default: '1', visibleModes: ['option'] },
    };


    // --- æ ¸å¿ƒå…¬å¼å®ç° (æ²¿ç”¨ V3.1/3.2) ---
    function calculateUsdtAvgEntry(M, O, P_old, N, P_new) {
        if (O + N === 0) return P_old; 
        const P_old_calc = (O > 0 && P_old > 0) ? P_old : P_new;
        const S_total = O + N;
        const P_new_calc = (P_new === 0) ? P_old_calc : P_new;

        const numerator = (M * O * P_old_calc) + (M * N * P_new_calc);
        const denominator = M * S_total;
        return numerator / denominator;
    }
    // ... å…¶ä»–æ ¸å¿ƒè®¡ç®—å‡½æ•° (calculateCoinAvgEntry, calculateContractProfit, calculateInitialMargin, etc. ä¿æŒä¸å˜) ...

    function calculateCoinAvgEntry(M, O, P_old, N, P_new) {
        if (O + N === 0) return P_old;
        const P_old_calc = (O > 0 && P_old > 0) ? P_old : P_new;
        const P_new_calc = (P_new === 0) ? P_old_calc : P_new;
        
        const numerator = M * (O + N);
        const denominator = (M * O / P_old_calc) + (M * N / P_new_calc);
        if (denominator === 0) return 0;
        return numerator / denominator;
    }
    
    function calculateContractProfit(mode, M, S, P_entry, P_mark, direction) {
        if (mode === 'usdt_m') {
            const diff = direction === 'long' ? (P_mark - P_entry) : (P_entry - P_mark);
            return M * S * diff;
        } else if (mode === 'coin_m') {
            const factor = direction === 'long' ? (1 / P_mark - 1 / P_entry) : (1 / P_entry - 1 / P_mark);
            return M * S * factor; 
        }
        return 0;
    }

    function calculateInitialMargin(mode, M, S, P_entry, L) {
        if (L === 0 || P_entry === 0) return 0;
        if (mode === 'usdt_m') {
            return (M * P_entry * S) / L;
        } else if (mode === 'coin_m') {
            return (M * S) / (P_entry * L);
        }
        return 0;
    }
    
    function calculateMaintenanceMargin(mode, M, S, MMR, P_mark) {
        const absS = Math.abs(S);
        const mmr = MMR / 100;
        if (mode === 'usdt_m') {
            return M * absS * mmr * P_mark;
        } else if (mode === 'coin_m') {
            if (P_mark === 0) return 0;
            return (M * absS * mmr) / P_mark;
        }
        return 0;
    }

    // å‡è®¾å…¨ä»“å¼ºå¹³å…¬å¼ (é€‚ç”¨äºé€ä»“éœ€ä½¿ç”¨ åˆå§‹ä¿è¯é‡‘ æ›¿ä»£ MarginBalance)
    function calculateLiquidationPrice(mode, direction, M, S, P_entry, MMR, FeeRate, MarginBalance) {
        const fee = FeeRate / 100;
        const mmr = MMR / 100;
        const S_M = M * S;

        if (mode === 'usdt_m') {
            if (direction === 'long') {
                const numerator = (S_M * P_entry) - (MarginBalance + (S_M * P_entry * fee));
                const denominator = S_M * (1 + mmr);
                return P_entry - (numerator / denominator);
            } else { // short
                const numerator = (S_M * P_entry) + (MarginBalance - (S_M * P_entry * fee));
                const denominator = S_M * (1 - mmr);
                return P_entry + (numerator / denominator);
            }
        }
        
        else if (mode === 'coin_m') {
            if (direction === 'long') {
                const numerator = S_M * (1 + mmr + fee);
                const denominator = (S_M / P_entry) + MarginBalance;
                return numerator / denominator;
            } else { // short
                const numerator = S_M * (1 - mmr - fee);
                const denominator = (S_M / P_entry) - MarginBalance;
                if (denominator <= 0) return Infinity;
                return numerator / denominator;
            }
        }
        return 0;
    }

    function calculateOptionBreakEven(direction, StrikePrice, Premium) {
        return direction === 'long' ? StrikePrice + Premium : StrikePrice - Premium;
    }
    
    /** ç°è´§æ æ†çˆ†ä»“ä»· (P_liq_spot) */
    function calculateSpotLiquidation(Direction, Leverage, MMR, P_entry, MarginBalance, LoanAmount) {
        const mmr = MMR / 100;
        // ç®€åŒ–å…¬å¼ï¼Œå‡è®¾å€Ÿè´·å’Œä¿è¯é‡‘éƒ½æ˜¯ä»¥ USDT è®¡ä»· (å¦‚ ETH/USDT äº¤æ˜“å¯¹ï¼Œå€Ÿå…¥ USDT)
        // çˆ†ä»“ä»· = (å€Ÿæ¬¾é¢ * (1+mmr)) / (èµ„äº§ä»·å€¼ / ä»·æ ¼ - å€Ÿæ¬¾é¢ / ä»·æ ¼ * mmr)
        
        if (Direction === 'long') {
             // ä¹°å…¥ (å€Ÿ USDT æ¢å¸): P_liq = (å€Ÿå…¥USDT * (1+MMR)) / (å¸èµ„äº§ - å¸ä¿è¯é‡‘ * MMR)
             // ç®€åŒ–ä¸ºï¼šçˆ†ä»“çº¿ = P_entry * (1 - ä¿è¯é‡‘ç‡ / (1 + æ æ†) / æ æ†)
             // ä½¿ç”¨æ›´æ ‡å‡†çš„å…¬å¼ï¼š
             const borrowed_asset = LoanAmount / P_entry;
             const total_asset = MarginBalance / P_entry + borrowed_asset;
             return LoanAmount * (1 + mmr) / (total_asset - MarginBalance / P_entry);
        } else {
             // å–å‡º (å€Ÿ BTC æ¢ USDT): P_liq = (å¸èµ„äº§ - ä¿è¯é‡‘å¸) * P_entry / (å€Ÿå…¥å¸ - å¸èµ„äº§ * MMR)
             return 0; // ç°è´§æ æ†åšç©ºè®¡ç®—å¤æ‚ï¼Œæš‚ä¸å®ç°
        }
    }


    // --- UI åŠ¨æ€æ§åˆ¶ ---

    function toggleInputs() {
        const mode = document.getElementById('mode').value;
        const directionGroup = document.getElementById('directionGroup');
        const marginModeGroup = document.getElementById('marginModeGroup');
        const inputArea = document.getElementById('inputArea');
        const checkboxesContainer = document.getElementById('calculationCheckboxes');

        // 1. åŠ¨æ€åŠ è½½ç»†é¡¹å¤é€‰æ¡†
        const config = CALC_ITEMS_CONFIG[mode];
        if (config) {
            checkboxesContainer.innerHTML = Object.entries(config.items).map(([key, label]) => 
                `<input type="checkbox" id="calc_${key}" value="${key}" checked><label for="calc_${key}">${label}</label>`
            ).join('');
        } else {
            checkboxesContainer.innerHTML = '<p>æ— å¯é€‰è®¡ç®—ç»†é¡¹ã€‚</p>';
        }
        
        // 2. æ§åˆ¶å…¨å±€é€‰é¡¹çš„å¯è§æ€§
        const isContract = mode === 'usdt_m' || mode === 'coin_m';
        const isOption = mode === 'option';
        const isAvgPrice = mode === 'avg_price';
        
        directionGroup.classList.toggle('hidden', isAvgPrice);
        marginModeGroup.classList.toggle('hidden', isOption || isAvgPrice);

        // 3. åŠ¨æ€åŠ è½½è¾“å…¥å­—æ®µ
        inputArea.innerHTML = '';
        Object.entries(INPUT_FIELDS_CONFIG).forEach(([id, config]) => {
            // æ£€æŸ¥å­—æ®µæ˜¯å¦åº”åœ¨å½“å‰æ¨¡å¼ä¸‹æ˜¾ç¤º
            if (config.visibleModes.includes(mode)) {
                let html = `
                    <div class="input-group ${id}">
                        <label for="${id}">${config.label}</label>
                        <input type="number" id="${id}" value="${config.default}" placeholder="${config.note || ''}">
                        ${config.note ? `<p class="note" id="${id}Note">${config.note}</p>` : ''}
                    </div>
                `;
                inputArea.insertAdjacentHTML('beforeend', html);
            }
        });

        // 4. ç»‘å®šäº‹ä»¶å¹¶é‡æ–°è®¡ç®—
        const calculationSelection = document.getElementById('calculationSelection');
        if (isContract || isAvgPrice) {
            calculationSelection.classList.remove('hidden');
            document.querySelectorAll('#calculationCheckboxes input').forEach(checkbox => {
                checkbox.addEventListener('change', calculateAll);
            });
        } else {
            calculationSelection.classList.add('hidden');
        }

        calculateAll();
    }


    // --- æ€»è®¡ç®—å‡½æ•° ---

    function calculateAll() {
        const mode = document.getElementById('mode').value;
        const direction = document.getElementById('direction')?.value || 'long';
        
        // 1. è·å–é€‰ä¸­çš„ç»†é¡¹ï¼ˆä»…åœ¨åˆçº¦/å‡ä»·æ¨¡å¼ä¸‹æœ‰æ•ˆï¼‰
        const selectedCalculations = Array.from(document.querySelectorAll('#calculationCheckboxes input:checked')).map(cb => cb.value);

        const getValue = id => parseFloat(document.getElementById(id)?.value) || 0;
        
        // --- æ ¸å¿ƒæ•°æ®è·å– ---
        const M = getValue('contractFaceValue');
        const P_entry = getValue('entryPrice'); // ç°è´§/æœŸæƒç”¨
        const S_old = getValue('positionSize'); // åˆçº¦/æœŸæƒç”¨
        const L = getValue('leverage');
        const P_mark = getValue('markPrice');
        const MMR = getValue('maintenanceMarginRate');
        const FeeRate = getValue('feeRate');
        const MarginBalance = getValue('accountBalance');
        const FundingRate = getValue('fundingRate');
        
        const S_new = getValue('newPositionSize');
        const P_new = getValue('newEntryPrice');
        const O_old = getValue('oldPositionSize'); // å‡ä»·æ¨¡å¼ç”¨
        const P_old = getValue('oldEntryPrice'); // å‡ä»·æ¨¡å¼ç”¨

        const StrikePrice = getValue('strikePrice');
        const OptionPremium = getValue('optionPremium');
        const Multiplier = getValue('optionMultiplier');
        
        const LoanAmount = getValue('loanAmount'); // ç°è´§æ æ†ç”¨

        let resultsHTML = '';
        let formulasHTML = '';
        
        const currency = mode === 'usdt_m' ? 'USDT' : 'æ ‡çš„å¸';
        const priceUnit = ' $/å¸';
        const P_used = (S_new > 0) ? (mode === 'usdt_m' ? calculateUsdtAvgEntry(M, S_old, P_old, S_new, P_new) : calculateCoinAvgEntry(M, S_old, P_old, S_new, P_new)) : P_entry;
        const S_total = S_old + S_new;
        
        if (mode === 'avg_price') {
            // --- æ¨¡å¼ 3: å¼€ä»“å‡ä»·è®¡ç®— ---
            if (selectedCalculations.includes('usdt_avg')) {
                const P_avg_usdt = calculateUsdtAvgEntry(M, O_old, P_old, S_new, P_new);
                resultsHTML += `<div class="result-box"><span class="result-label">Uæœ¬ä½å¹³å‡å¼€ä»“ä»·:</span> <span class="result-value">${P_avg_usdt.toFixed(4)} ${priceUnit}</span></div>`;
                formulasHTML += `$$ P_{\\text{avg\\_U}} = \\frac{M \\cdot O \\cdot P_{\\text{old}} + M \\cdot N \\cdot P_{\\text{new}}}{M \\cdot (O + N)} $$`;
            }
            if (selectedCalculations.includes('coin_avg')) {
                const P_avg_coin = calculateCoinAvgEntry(M, O_old, P_old, S_new, P_new);
                resultsHTML += `<div class="result-box"><span class="result-label">å¸æœ¬ä½å¹³å‡å¼€ä»“ä»·:</span> <span class="result-value">${P_avg_coin.toFixed(4)} ${priceUnit}</span></div>`;
                formulasHTML += `$$ P_{\\text{avg\\_Coin}} = \\frac{M \\cdot (O + N)}{M \\cdot O/P_{\\text{old}} + M \\cdot N/P_{\\text{new}}} $$`;
            }

        } else if (mode === 'usdt_m' || mode === 'coin_m') {
            // --- æ¨¡å¼ 1/2: åˆçº¦è®¡ç®— ---

            // é¢„å…ˆè®¡ç®—æ‰€æœ‰ç»“æœ
            const P_avg = mode === 'usdt_m' ? calculateUsdtAvgEntry(M, S_old, P_entry, S_new, P_new) : calculateCoinAvgEntry(M, S_old, P_entry, S_new, P_new);
            const I_Margin = calculateInitialMargin(mode, M, S_total, P_used, L);
            const M_Margin = calculateMaintenanceMargin(mode, M, S_total, MMR, P_mark);
            const PnL = calculateContractProfit(mode, M, S_total, P_used, P_mark, direction);
            const V_position = mode === 'usdt_m' ? (M * S_total * P_mark) : (M * S_total / P_mark);
            const Fee = mode === 'usdt_m' ? (M * S_total * P_used * (FeeRate/100)) : (M * S_total / P_used * (FeeRate/100)); // ä»¥ä¿è¯é‡‘è®¡ä»·çš„å¼€ä»“æ‰‹ç»­è´¹
            const F_cost = V_position * (FundingRate / 100); 
            const P_liq = calculateLiquidationPrice(mode, direction, M, S_total, P_used, MMR, FeeRate, MarginBalance);
            const PnL_text = mode === 'coin_m' ? `${PnL.toFixed(6)} ${currency} â‰ˆ ${(PnL * P_mark).toFixed(2)} USDT` : `${PnL.toFixed(2)} ${currency}`;
            const V_text = mode === 'coin_m' ? `${V_position.toFixed(6)} ${currency} â‰ˆ ${(V_position * P_mark).toFixed(2)} USDT` : `${V_position.toFixed(2)} ${currency}`;
            const Equity = MarginBalance + PnL;
            const PnL_Ratio = (PnL / MarginBalance) * 100;
            const MarginRatio = (Equity / (V_position * (MMR/100))) * 100; // é£é™©ç‡è¿‘ä¼¼å€¼
            const CrossMMR = (M_Margin / V_position) * 100; // ç»´æŒä¿è¯é‡‘ / ä»“ä½ä»·å€¼

            if (selectedCalculations.includes('avg')) {
                 resultsHTML += `<div class="result-box"><span class="result-label">å¹³å‡å¼€ä»“ä»· (P_avg):</span> <span class="result-value">${P_avg.toFixed(4)} ${priceUnit}</span></div>`;
                 formulasHTML += `$$ P_{\\text{avg}} = ${mode === 'usdt_m' ? '\\frac{M \\cdot O \\cdot P_{\\text{old}} + M \\cdot N \\cdot P_{\\text{new}}}{M \\cdot (O + N)}' : '\\frac{M \\cdot (O + N)}{M \\cdot O/P_{\\text{old}} + M \\cdot N/P_{\\text{new}}}'} $$`;
            }
            if (selectedCalculations.includes('fee')) {
                resultsHTML += `<div class="result-box"><span class="result-label">å¼€ä»“æ‰‹ç»­è´¹:</span> <span class="result-value">${Fee.toFixed(4)} ${currency}</span></div>`;
            }
            if (selectedCalculations.includes('pnl')) {
                resultsHTML += `
                    <div class="result-box"><span class="result-label">åˆçº¦æ”¶ç›Š (PnL):</span> <span class="result-value" style="color:${PnL >= 0 ? 'green' : 'red'};">${PnL_text}</span></div>
                    <div class="result-box"><span class="result-label">æœªå®ç°æ”¶ç›Šç‡:</span> <span class="result-value" style="color:${PnL >= 0 ? 'green' : 'red'};">${PnL_Ratio.toFixed(2)}%</span></div>
                `;
                 formulasHTML += `$$ \\text{PnL} = ${mode === 'usdt_m' ? 'M \\cdot S \\cdot (P_{\\text{mark}} - P_{\\text{entry}})' : 'M \\cdot S \\cdot \\left(\\frac{1}{P_{\\text{mark}}} - \\frac{1}{P_{\\text{entry}}}\\right)'} $$`;
            }
            if (selectedCalculations.includes('immm')) {
                resultsHTML += `
                    <div class="result-box"><span class="result-label">å¼€ä»“ä¿è¯é‡‘ (IM):</span> <span class="result-value">${I_Margin.toFixed(4)} ${currency}</span></div>
                    <div class="result-box"><span class="result-label">ç»´æŒä¿è¯é‡‘ (MM):</span> <span class="result-value">${M_Margin.toFixed(4)} ${currency}</span></div>
                `;
                 formulasHTML += `$$ \\text{IM} = \\frac{\\text{åä¹‰ä»·å€¼}}{L} \\quad \\text{MM} = \\text{åä¹‰ä»·å€¼} \\cdot MMR $$`;
            }
            if (selectedCalculations.includes('mmr')) {
                resultsHTML += `
                    <div class="result-box"><span class="result-label">ç»´æŒä¿è¯é‡‘ç‡ (MMR, %):</span> <span class="result-value">${MMR.toFixed(2)}%</span></div>
                    <div class="result-box"><span class="result-label">è·¨å¸ç§ç»´æŒä¿è¯é‡‘ç‡:</span> <span class="result-value">${CrossMMR.toFixed(4)}% (åŸºäºä»“ä½ä»·å€¼)</span></div>
                    <div class="result-box"><span class="result-label">ä¿è¯é‡‘é£é™©ç‡:</span> <span class="result-value" style="color:${MarginRatio > 100 ? 'green' : 'red'};">${MarginRatio.toFixed(2)}%</span></div>
                `;
            }
            if (selectedCalculations.includes('value')) {
                resultsHTML += `
                    <div class="result-box"><span class="result-label">ä»“ä½ä»·å€¼ (V):</span> <span class="result-value">${V_text}</span></div>
                    <div class="result-box"><span class="result-label">é¢„ä¼°èµ„é‡‘è´¹ç”¨ (FF):</span> <span class="result-value">${F_cost.toFixed(4)} ${currency}</span></div>
                `;
            }
            if (selectedCalculations.includes('liq')) {
                resultsHTML += `<div class="result-box"><span class="result-label">é¢„ä¼°å¼ºå¹³ä»· (P_liq):</span> <span class="result-value" style="color:#dc3545;">${P_liq.toFixed(4)} ${priceUnit}</span></div>`;
                 formulasHTML += `$$ P_{\\text{liq\\_long}} = \\frac{M \\cdot S \\cdot (1 + MMR + \\text{Fee})}{\\frac{M \\cdot S}{P_{\\text{entry}}} + \\text{MarginBalance}} \\quad (\\text{Coin-M Cross}) $$`;
            }


        } else if (mode === 'spot_leverage') {
            // --- æ¨¡å¼ 4: ç°è´§æ æ†è®¡ç®— ---
            const LoanCost = LoanAmount * (0.0001 / 24); // å‡è®¾å°æ—¶è´¹ç‡ 0.01% / 24
            const P_liq_spot = calculateSpotLiquidation(direction, L, MMR, P_entry, MarginBalance, LoanAmount);
            
            if (selectedCalculations.includes('liquidation_price')) {
                 resultsHTML += `<div class="result-box"><span class="result-label">é¢„ä¼°çˆ†ä»“ä»·:</span> <span class="result-value" style="color:#dc3545;">${P_liq_spot.toFixed(4)} ${priceUnit}</span></div>`;
            }
            if (selectedCalculations.includes('interest_cost')) {
                 resultsHTML += `<div class="result-box"><span class="result-label">é¢„ä¼°æ¯å°æ—¶åˆ©æ¯è´¹ç”¨:</span> <span class="result-value">${LoanCost.toFixed(6)} USDT</span></div>`;
            }
            if (selectedCalculations.includes('max_leverage')) {
                 resultsHTML += `<div class="result-box"><span class="result-label">æœ€å¤§å¯å€Ÿé¢åº¦ï¼ˆç†è®ºå€¼ï¼‰:</span> <span class="result-value">${(MarginBalance * (L - 1)).toFixed(2)} USDT</span></div>`;
            }

             formulasHTML += `$$ P_{\\text{liq\\_Spot}} \\approx \\frac{\\text{å€Ÿæ¬¾é¢} \\cdot (1+MMR)}{\\text{æ€»èµ„äº§ä»·å€¼}/P_{\\text{entry}} - \\text{ä¿è¯é‡‘}/P_{\\text{entry}}} $$`;

        } else if (mode === 'option') {
            // --- æ¨¡å¼ 5: æœŸæƒè®¡ç®— (å¼ºåˆ¶æ˜¾ç¤ºæ‰€æœ‰ç»“æœ) ---
            const TotalPremium = OptionPremium * Multiplier * S_old; 
            const BEP = calculateOptionBreakEven(direction, StrikePrice, OptionPremium);
            const OptionValue = StrikePrice * Multiplier * S_old; 
            
            resultsHTML += `
                <div class="result-box"><span class="result-label">æ€»æœŸæƒè´¹æ”¯å‡º/æ”¶å…¥:</span> <span class="result-value" style="color:${direction === 'long' ? 'red' : 'green'};">${TotalPremium.toFixed(4)} $</span></div>
                <div class="result-box"><span class="result-label">ç›ˆäºå¹³è¡¡ç‚¹ (BEP):</span> <span class="result-value" style="color:#007bff;">${BEP.toFixed(4)} $</span></div>
                <div class="result-box"><span class="result-label">æœŸæƒåä¹‰å¸‚å€¼:</span> <span class="result-value">${OptionValue.toFixed(4)} $</span></div>
            `;
            
            formulasHTML += `
                $$ \\text{æ€»æœŸæƒè´¹} = P \\cdot \\text{ä¹˜æ•°} \\cdot \\text{å¼ æ•°} $$
                $$ P_{\\text{BEP}} = K \\pm P $$
            `;
        }

        if (resultsHTML === '') {
             resultsHTML = '<p style="color:orange;">è¯·å‹¾é€‰æ‚¨æƒ³è¦è®¡ç®—å’Œæ˜¾ç¤ºçš„å†…å®¹ã€‚</p>';
        }


        document.getElementById('resultContent').innerHTML = resultsHTML;
        document.getElementById('formulaDisplay').innerHTML = formulasHTML;
        
        // é‡æ–°æ¸²æŸ“ MathJax å…¬å¼
        if (typeof MathJax !== 'undefined') {
            MathJax.typesetPromise();
        }
    }

    // åˆå§‹åŒ–è°ƒç”¨
    document.addEventListener('DOMContentLoaded', () => {
        // ç¬¬ä¸€æ¬¡åŠ è½½æ—¶æ‰‹åŠ¨æ¸²æŸ“å…¬å¼ï¼Œé˜²æ­¢ UI é—ªçƒ
        if (typeof MathJax !== 'undefined') {
             MathJax.typesetPromise().then(() => {
                toggleInputs();
             });
        } else {
             toggleInputs();
        }
    });
</script>

</body>
</html>
