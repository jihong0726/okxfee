<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆçº¦ä¸æœŸæƒå…¨èƒ½è®¡ç®—å™¨</title>
    
    <script type="text/javascript" id="MathJax-script" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
    </script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f8f9fa; color: #333; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background-color: #ffffff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); }
        h1 { color: #004d99; text-align: center; border-bottom: 2px solid #e9ecef; padding-bottom: 15px; margin-bottom: 30px; }
        .config-row { display: flex; gap: 20px; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px dashed #e9ecef; }
        .input-group { margin-bottom: 20px; display: flex; flex-direction: column; flex: 1; }
        .input-group label { font-weight: 600; margin-bottom: 8px; color: #007bff; }
        input[type="number"], select { padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 16px; width: 100%; box-sizing: border-box; }
        button { background-color: #28a745; color: white; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 18px; font-weight: 700; width: 100%; margin-top: 10px; }
        #results { margin-top: 40px; padding: 20px; border-top: 3px solid #007bff; background-color: #f1f7fe; border-radius: 8px; }
        .result-box { margin-bottom: 15px; padding: 10px; border-left: 5px solid #004d99; background-color: #e9f3ff; border-radius: 4px; }
        .result-label { font-weight: 700; color: #333; margin-right: 10px; }
        .result-value { font-size: 18px; font-weight: 700; color: #dc3545; }
        .formula-section { margin-top: 30px; padding: 15px; background-color: #e9ecef; border-radius: 8px; font-size: 14px; }
        .hidden { display: none !important; opacity: 0; transition: opacity 0.5s; }
        .input-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ§  äº¤æ˜“è®¡ç®—å…¬å¼ç»¼åˆéªŒè¯å™¨</h1>
    
    <div class="config-row">
        <div class="input-group" style="flex: 2;">
            <label for="mode">é€‰æ‹©è®¡ç®—æ¨¡å¼</label>
            <select id="mode" onchange="toggleInputs()">
                <option value="usdt_m">1. U æœ¬ä½åˆçº¦ (USDT-M)</option>
                <option value="coin_m">2. å¸æœ¬ä½åˆçº¦ (Coin-M)</option>
                <option value="option">3. æœŸæƒäº¤æ˜“ (Options)</option>
            </select>
        </div>
        <div class="input-group" style="flex: 1;">
            <label for="direction">ä»“ä½æ–¹å‘</label>
            <select id="direction">
                <option value="long">åšå¤š (Long)</option>
                <option value="short">åšç©º (Short)</option>
            </select>
        </div>
        <div class="input-group" style="flex: 1;">
            <label for="marginMode">ä¿è¯é‡‘æ¨¡å¼</label>
            <select id="marginMode">
                <option value="isolated">é€ä»“</option>
                <option value="cross">å…¨ä»“</option>
            </select>
        </div>
    </div>
    
    <div class="input-grid">
        <div class="input-group">
            <label for="contractFaceValue">åˆçº¦é¢å€¼ (M)</label>
            <input type="number" id="contractFaceValue" value="10" placeholder="USDT-M: 1, Coin-M: 10/100">
        </div>
        <div class="input-group">
            <label for="entryPrice">å¼€ä»“å‡ä»· ($/å¸)</label>
            <input type="number" id="entryPrice" value="30000">
        </div>
        <div class="input-group">
            <label for="positionSize">æŒä»“å¼ æ•° (å¼ )</label>
            <input type="number" id="positionSize" value="100">
        </div>
        <div class="input-group">
            <label for="leverage">æ æ†å€æ•° (L)</label>
            <input type="number" id="leverage" value="20">
        </div>
        <div class="input-group">
            <label for="markPrice">æ ‡è®°ä»·æ ¼ ($/å¸)</label>
            <input type="number" id="markPrice" value="30500">
        </div>
        <div class="input-group">
            <label for="maintenanceMarginRate">ç»´æŒä¿è¯é‡‘ç‡ (MMR, %)</label>
            <input type="number" id="maintenanceMarginRate" value="0.5">
        </div>
        <div class="input-group">
            <label for="feeRate">æ‰‹ç»­è´¹ç‡ (Fee, %)</label>
            <input type="number" id="feeRate" value="0.05">
        </div>
        <div class="input-group">
            <label for="accountBalance">ä¿è¯é‡‘ä½™é¢ (USDT/å¸)</label>
            <input type="number" id="accountBalance" value="1500">
        </div>
        
        <div class="input-group hidden" id="reentryInputs">
            <label for="newPositionSize">æ–°å¼€ä»“æ•° (å¼ )</label>
            <input type="number" id="newPositionSize" value="50">
        </div>
        <div class="input-group hidden" id="reentryPriceInputs">
            <label for="newEntryPrice">æ–°æˆäº¤å‡ä»· ($/å¸)</label>
            <input type="number" id="newEntryPrice" value="30100">
        </div>
    </div>
    
    <div id="optionInputs" class="input-grid hidden">
        <div class="input-group">
            <label for="strikePrice">æœŸæƒæ‰§è¡Œä»·æ ¼ ($)</label>
            <input type="number" id="strikePrice" value="30000">
        </div>
        <div class="input-group">
            <label for="optionPremium">æœŸæƒè´¹ (P)</label>
            <input type="number" id="optionPremium" value="500">
        </div>
        <div class="input-group">
            <label for="optionMultiplier">åˆçº¦ä¹˜æ•°</label>
            <input type="number" id="optionMultiplier" value="1">
        </div>
    </div>

    <button onclick="calculateAll()">æ‰§è¡Œæ‰€æœ‰è®¡ç®—</button>

    <div id="results">
        <h2>è®¡ç®—ç»“æœ</h2>
        <div id="resultContent">
            è¯·é€‰æ‹©æ¨¡å¼å¹¶ç‚¹å‡»è®¡ç®—ã€‚
        </div>
    </div>

    <div class="formula-section">
        <h3 style="color: #007bff;">å½“å‰æ¨¡å¼çš„å…³é”®å…¬å¼ (MathJax æ¸²æŸ“)</h3>
        <div id="formulaDisplay">
            </div>
        <p style="margin-top: 15px; font-style: italic; color: #6c757d;">ç‰ˆæœ¬ V3.0.0 - ç»¼åˆåˆçº¦ä¸æœŸæƒè®¡ç®—å®ç°</p>
    </div>
</div>

<script>
    // --- æ ¸å¿ƒå…¬å¼å®ç° ---

    /**
     * Uæœ¬ä½å¼€ä»“å‡ä»· (U-M Average Entry Price)
     * å…¬å¼: ( M*O*P_old + M*N*P_new ) / ( M*(O+N) )
     */
    function calculateUsdtAvgEntry(M, O, P_old, N, P_new) {
        if (O + N === 0) return 0;
        return ((M * O * P_old) + (M * N * P_new)) / (M * (O + N));
    }

    /**
     * å¸æœ¬ä½å¼€ä»“å‡ä»· (Coin-M Average Entry Price)
     * å…¬å¼: ( M*(O+N) ) / ( M*O/P_old + M*N/P_new )
     */
    function calculateCoinAvgEntry(M, O, P_old, N, P_new) {
        if ((M * O / P_old) + (M * N / P_new) === 0) return 0;
        return (M * (O + N)) / ((M * O / P_old) + (M * N / P_new));
    }
    
    /**
     * åˆçº¦æ”¶ç›Š (Profit/Loss) - å‡è®¾å¹³ä»“ä»·ä¸ºæ ‡è®°ä»·æ ¼ (P_mark)
     */
    function calculateContractProfit(mode, M, S, P_entry, P_mark, direction) {
        if (mode === 'usdt_m') {
            const diff = direction === 'long' ? (P_mark - P_entry) : (P_entry - P_mark);
            return M * S * diff;
        } else if (mode === 'coin_m') {
            // å¸æœ¬ä½ï¼šæ”¶ç›Š = M*S * (1/P_entry - 1/P_mark) * ä¹˜æ•°/1 ï¼ˆç®€åŒ–ï¼‰
            const factor = direction === 'long' ? (1 / P_entry - 1 / P_mark) : (1 / P_mark - 1 / P_entry);
            return M * S * factor * P_entry * P_mark; // ç®€åŒ–ä¸ºUSDTè®¡ä»·è¿‘ä¼¼å€¼
        }
        return 0;
    }

    /**
     * åˆå§‹ä¿è¯é‡‘ (Initial Margin)
     * å…¬å¼: (M * S * P_entry) / L (Uæœ¬ä½) æˆ– (M*S) / (P_entry * L) (å¸æœ¬ä½)
     */
    function calculateInitialMargin(mode, M, S, P_entry, L) {
        if (L === 0) return 0;
        if (mode === 'usdt_m') {
            return (M * P_entry * S) / L; // Uæœ¬ä½ï¼šé¢å€¼*å¼€ä»“ä»·æ ¼*å¼ æ•°/æ æ†
        } else if (mode === 'coin_m') {
            return (M * S) / (P_entry * L); // å¸æœ¬ä½ï¼šé¢å€¼*å¼ æ•°/(å¼€ä»“ä»·æ ¼*æ æ†) (ä»¥äº¤æ˜“å¸è®¡ä»·)
        }
        return 0;
    }
    
    /**
     * ç»´æŒä¿è¯é‡‘ (Maintenance Margin Required)
     * å…¬å¼: M * |S| * MMR * P_mark (Uæœ¬ä½) æˆ– M*|S|*MMR / P_mark (å¸æœ¬ä½)
     */
    function calculateMaintenanceMargin(mode, M, S, MMR, P_mark) {
        const absS = Math.abs(S);
        if (mode === 'usdt_m') {
            return M * absS * (MMR / 100) * P_mark; // Uæœ¬ä½
        } else if (mode === 'coin_m') {
            return (M * absS * (MMR / 100)) / P_mark; // å¸æœ¬ä½ (ä»¥äº¤æ˜“å¸è®¡ä»·)
        }
        return 0;
    }

    /**
     * é¢„ä¼°å¼ºå¹³ä»· (Estimated Liquidation Price) - æ ¸å¿ƒå¼ºå¹³å…¬å¼
     */
    function calculateLiquidationPrice(mode, direction, M, S, P_entry, P_mark, L, MMR, FeeRate, MarginBalance) {
        const fee = FeeRate / 100;
        const mmr = MMR / 100;

        // Uæœ¬ä½å…¬å¼ (ä»¥ P_entry ä¸ºåŸºå‡†)
        if (mode === 'usdt_m') {
            const V = M * S * P_entry; // åä¹‰ä»·å€¼ï¼ˆåŸºäºå¼€ä»“ä»·ï¼‰
            const MMR_req = M * S * mmr * P_mark; // ç»´æŒä¿è¯é‡‘è¦æ±‚ (åŸºäºæ ‡è®°ä»·ï¼Œè¿‘ä¼¼)
            const TotalCost = M * S * P_entry * (fee * 2); // å‡è®¾å¼€å¹³ä»“æ‰‹ç»­è´¹

            const LossNeeded = (MarginBalance + TotalCost) - MMR_req;
            
            if (direction === 'long') {
                // P_liq = P_entry - [ (MarginBalance - MMR_req) / (M*S) ]
                // ç®€åŒ–è‡ªæ–‡æ¡£å…¬å¼ï¼šP_liq = (ä¿è¯é‡‘ä½™é¢ - M*S*P_entry) / (M*S*(MMR + Fee - 1))
                // ä½¿ç”¨æ–‡æ¡£å…¬å¼ï¼š
                return (MarginBalance - (M * S * P_entry)) / (M * S * (mmr + fee - 1));
            } else { // short
                // ç®€åŒ–è‡ªæ–‡æ¡£å…¬å¼ï¼šP_liq = P_entry + [ (MMR_req - MarginBalance) / (M*S) ]
                // ä½¿ç”¨æ–‡æ¡£å…¬å¼ï¼š
                return (MarginBalance + (M * S * P_entry)) / (M * S * (mmr + fee + 1));
            }
        } 
        // å¸æœ¬ä½å…¬å¼ (ä»¥ P_entry ä¸ºåŸºå‡†)
        else if (mode === 'coin_m') {
            const V_base = M * S / P_mark; // ä»“ä½ä»·å€¼ (ä»¥äº¤æ˜“å¸è®¡ä»·, åŸºäºæ ‡è®°ä»·)

            if (direction === 'long') {
                 // æ–‡æ¡£å…¬å¼ï¼šP_liq = V_base *(MMR + Fee + 1) / (MarginBalance + V_base / P_entry)
                return (V_base * (mmr + fee + 1)) / (MarginBalance + V_base / P_entry);
            } else { // short
                // æ–‡æ¡£å…¬å¼ï¼šP_liq = V_base * (MMR + Fee - 1) / (MarginBalance - V_base / P_entry)
                return (V_base * (mmr + fee - 1)) / (MarginBalance - V_base / P_entry);
            }
        }
        return 0;
    }


    /**
     * æœŸæƒç›ˆäºå¹³è¡¡ç‚¹
     */
    function calculateOptionBreakEven(direction, StrikePrice, Premium) {
        if (direction === 'long') {
            // ä¹°å…¥ç›ˆäºå¹³è¡¡ç‚¹ = æ‰§è¡Œä»·æ ¼ / (1 + æœŸæƒè´¹ç‡)
            return StrikePrice / (1 + Premium); 
        } else {
            // å–å‡ºç›ˆäºå¹³è¡¡ç‚¹ = æ‰§è¡Œä»·æ ¼ / (1 - æœŸæƒè´¹ç‡)
            return StrikePrice / (1 - Premium);
        }
    }


    // --- UI æ§åˆ¶ä¸æ€»è®¡ç®—å‡½æ•° ---

    function toggleInputs() {
        const mode = document.getElementById('mode').value;
        const reentry = document.getElementById('reentryInputs');
        const reentryPrice = document.getElementById('reentryPriceInputs');
        const option = document.getElementById('optionInputs');

        // é‡ç½®æ˜¾ç¤º
        [reentry, reentryPrice, option].forEach(el => el.classList.add('hidden'));

        // åˆ‡æ¢æ˜¾ç¤º
        if (mode === 'option') {
            option.classList.remove('hidden');
        } else {
            reentry.classList.remove('hidden');
            reentryPrice.classList.remove('hidden');
        }
        
        // æ¨¡å¼åˆ‡æ¢æ—¶è‡ªåŠ¨è®¡ç®—ä¸€æ¬¡
        calculateAll();
    }


    function calculateAll() {
        const mode = document.getElementById('mode').value;
        const direction = document.getElementById('direction').value;
        
        // é€šç”¨è¾“å…¥
        const M = parseFloat(document.getElementById('contractFaceValue').value); // åˆçº¦é¢å€¼
        const P_entry_old = parseFloat(document.getElementById('entryPrice').value); // åŸ/å½“å‰å¼€ä»“å‡ä»·
        const S_old = parseFloat(document.getElementById('positionSize').value); // åŸ/å½“å‰æŒä»“å¼ æ•°
        const L = parseFloat(document.getElementById('leverage').value); // æ æ†
        const P_mark = parseFloat(document.getElementById('markPrice').value); // æ ‡è®°ä»·æ ¼
        const MMR = parseFloat(document.getElementById('maintenanceMarginRate').value); // ç»´æŒä¿è¯é‡‘ç‡ (%)
        const FeeRate = parseFloat(document.getElementById('feeRate').value); // æ‰‹ç»­è´¹ç‡ (%)
        const MarginBalance = parseFloat(document.getElementById('accountBalance').value); // ä¿è¯é‡‘ä½™é¢
        
        // è¡¥ä»“è¾“å…¥ (ç”¨äºå¼€ä»“å‡ä»·è®¡ç®—)
        const S_new = parseFloat(document.getElementById('newPositionSize').value) || 0; // æ–°å¼€ä»“æ•°
        const P_entry_new = parseFloat(document.getElementById('newEntryPrice').value) || P_entry_old; // æ–°æˆäº¤å‡ä»·

        // æœŸæƒè¾“å…¥
        const StrikePrice = parseFloat(document.getElementById('strikePrice').value); // æ‰§è¡Œä»·æ ¼
        const OptionPremium = parseFloat(document.getElementById('optionPremium').value) / StrikePrice; // ç®€åŒ–ä¸ºè´¹ç‡ (P/K)
        const Multiplier = parseFloat(document.getElementById('optionMultiplier').value); // åˆçº¦ä¹˜æ•°

        if (isNaN(M) || isNaN(P_entry_old) || isNaN(S_old) || isNaN(P_mark)) {
            document.getElementById('resultContent').innerHTML = "<p style='color:red;'>è¯·è¾“å…¥æœ‰æ•ˆçš„åŸºæœ¬æ•°æ®!</p>";
            document.getElementById('formulaDisplay').innerHTML = "";
            return;
        }

        let resultsHTML = '';
        let formulasHTML = '';

        if (mode === 'usdt_m' || mode === 'coin_m') {
            // --- åˆçº¦æ¨¡å¼è®¡ç®— ---
            
            // 1. å¼€ä»“å‡ä»·
            const P_avg = mode === 'usdt_m' 
                ? calculateUsdtAvgEntry(M, S_old, P_entry_old, S_new, P_entry_new) 
                : calculateCoinAvgEntry(M, S_old, P_entry_old, S_new, P_entry_new);
            
            // 2. åˆå§‹ä¿è¯é‡‘ (ä½¿ç”¨å½“å‰æŒä»“æ•°æ®)
            const I_Margin = calculateInitialMargin(mode, M, S_old, P_entry_old, L);
            
            // 3. ç»´æŒä¿è¯é‡‘
            const M_Margin = calculateMaintenanceMargin(mode, M, S_old, MMR, P_mark);
            
            // 4. åˆçº¦æ”¶ç›Š (å‡è®¾å¹³ä»“ä»· = æ ‡è®°ä»·æ ¼)
            const PnL = calculateContractProfit(mode, M, S_old, P_entry_old, P_mark, direction);

            // 5. é¢„ä¼°å¼ºå¹³ä»·
            const P_liq = calculateLiquidationPrice(mode, direction, M, S_old, P_entry_old, P_mark, L, MMR, FeeRate, MarginBalance);

            // 6. ä»“ä½ä»·å€¼
            const V_position = mode === 'usdt_m' ? (M * S_old * P_mark) : (M * S_old / P_mark);
            
            // 7. èµ„é‡‘è´¹ç”¨
            const F_cost = V_position * (0.01 / 100); // å‡è®¾èµ„é‡‘è´¹ç‡ 0.01%
            
            const currency = mode === 'usdt_m' ? 'USDT' : 'å¸';
            const priceUnit = ' $/å¸';
            
            resultsHTML += `
                <div class="result-box"><span class="result-label">å¹³å‡å¼€ä»“ä»·:</span> <span class="result-value">${P_avg.toFixed(4)} ${priceUnit}</span></div>
                <div class="result-box"><span class="result-label">æœªå®ç°ç›ˆäº:</span> <span class="result-value">${PnL.toFixed(4)} ${currency}</span></div>
                <div class="result-box"><span class="result-label">åˆå§‹ä¿è¯é‡‘:</span> <span class="result-value">${I_Margin.toFixed(4)} ${currency}</span></div>
                <div class="result-box"><span class="result-label">ç»´æŒä¿è¯é‡‘:</span> <span class="result-value">${M_Margin.toFixed(4)} ${currency}</span></div>
                <div class="result-box"><span class="result-label">é¢„ä¼°å¼ºå¹³ä»·:</span> <span class="result-value" style="color:#dc3545;">${P_liq.toFixed(4)} ${priceUnit}</span></div>
                <div class="result-box"><span class="result-label">ä»“ä½ä»·å€¼:</span> <span class="result-value">${V_position.toFixed(4)} ${currency}</span></div>
                <div class="result-box"><span class="result-label">é¢„ä¼°èµ„é‡‘è´¹ç”¨:</span> <span class="result-value">${F_cost.toFixed(4)} ${currency}</span></div>
            `;
            
            // å…¬å¼å±•ç¤º
            if (mode === 'usdt_m') {
                formulasHTML += `
                    $$ P_{\\text{avg}} = \\frac{M \\cdot O \\cdot P_{\\text{old}} + M \\cdot N \\cdot P_{\\text{new}}}{M \\cdot (O + N)} $$
                    $$ P_{\\text{liq\\_long}} = \\frac{\\text{ä¿è¯é‡‘ä½™é¢} - M\\cdot S \\cdot P_{\\text{entry}}}{M\\cdot S \\cdot (MMR + \\text{Fee} - 1)} $$
                    $$ \\text{MM} = M \\cdot |S| \\cdot MMR \\cdot P_{\\text{mark}} $$
                `;
            } else { // coin_m
                formulasHTML += `
                    $$ P_{\\text{avg}} = \\frac{M \\cdot (O + N)}{M \\cdot O/P_{\\text{old}} + M \\cdot N/P_{\\text{new}}} $$
                    $$ P_{\\text{liq\\_long}} = \\frac{V_{\\text{base}} \\cdot (MMR + \\text{Fee} + 1)}{\\text{ä¿è¯é‡‘ä½™é¢} + V_{\\text{base}} / P_{\\text{entry}}} $$
                    $$ \\text{MM} = \\frac{M \\cdot |S| \\cdot MMR}{P_{\\text{mark}}} $$
                `;
            }

        } else if (mode === 'option') {
            // --- æœŸæƒæ¨¡å¼è®¡ç®— ---
            
            // 1. æœŸæƒè´¹
            const OptionFee = P_entry_old * Multiplier * S_old; // P_entry_old è§†ä¸º æœŸæƒå¼€ä»“å‡ä»·/è´¹ç‡
            
            // 2. ç›ˆäºå¹³è¡¡ç‚¹
            const BEP = calculateOptionBreakEven(direction, StrikePrice, OptionPremium);
            
            // 3. æœŸæƒå¸‚å€¼
            const OptionValue = M * Multiplier * S_old; // åˆçº¦é¢å€¼*ä¹˜æ•°*å¼ æ•°
            
            resultsHTML += `
                <div class="result-box"><span class="result-label">æ€»æœŸæƒè´¹æ”¯å‡º/æ”¶å…¥:</span> <span class="result-value">${OptionFee.toFixed(4)} $</span></div>
                <div class="result-box"><span class="result-label">ç›ˆäºå¹³è¡¡ç‚¹:</span> <span class="result-value" style="color:#007bff;">${BEP.toFixed(4)} $</span></div>
                <div class="result-box"><span class="result-label">åä¹‰æœŸæƒå¸‚å€¼:</span> <span class="result-value">${OptionValue.toFixed(4)} $</span></div>
            `;
            
            // å…¬å¼å±•ç¤º
            formulasHTML += `
                $$ \\text{æœŸæƒè´¹} = P_{\\text{entry}} \\cdot \\text{ä¹˜æ•°} \\cdot \\text{å¼ æ•°} $$
                $$ P_{\\text{BEP\_ä¹°}} = \\frac{\\text{æ‰§è¡Œä»·æ ¼}}{1 + \\text{æœŸæƒè´¹ç‡}} $$
                $$ P_{\\text{BEP\_å–}} = \\frac{\\text{æ‰§è¡Œä»·æ ¼}}{1 - \\text{æœŸæƒè´¹ç‡}} $$
            `;
        }

        document.getElementById('resultContent').innerHTML = resultsHTML;
        document.getElementById('formulaDisplay').innerHTML = formulasHTML;
        
        // é‡æ–°æ¸²æŸ“ MathJax å…¬å¼
        if (typeof MathJax !== 'undefined') {
            MathJax.typesetPromise();
        }
    }

    // åˆå§‹åŒ–è°ƒç”¨
    document.addEventListener('DOMContentLoaded', () => {
        toggleInputs(); 
        calculateAll();
    });
</script>

</body>
</html>
