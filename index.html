<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº¤æ˜“è®¡ç®—å…¬å¼å…¨èƒ½å·¥å…·ç®± V7.0</title>
    
    <script type="text/javascript" id="MathJax-script" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
    </script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; color: #333; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background-color: #ffffff; padding: 30px; border-radius: 16px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15); }
        h1 { color: #007bff; text-align: center; border-bottom: 3px solid #007bff; padding-bottom: 15px; margin-bottom: 30px; }
        
        /* 1. äº¤æ˜“åŒºé€‰æ‹© (ä¸€çº§) */
        .selection-panel { background-color: #e9f5ff; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #cceeff; }
        .selection-panel label { font-weight: 700; color: #007bff; margin-bottom: 8px; display: block; }
        select { /* ç»Ÿä¸€æ ·å¼ */
            padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 15px; width: 100%; box-sizing: border-box; 
            background-color: white; appearance: none;
        }

        /* 2. ç»†é¡¹é€‰æ‹© (äºŒçº§) - é‡ç‚¹æ”¹ä¸ºå•é€‰ */
        #calculationSelection { background-color: #fff9f0; padding: 15px; border-radius: 10px; margin-bottom: 25px; border: 1px solid #ffcc80; }
        #calculationSelection h3 { margin-top: 0; color: #e65100; font-size: 1.1em; border-bottom: 1px dashed #ffb74d; padding-bottom: 8px; margin-bottom: 12px; }
        .radio-group { display: flex; flex-wrap: wrap; gap: 10px 20px; }
        .radio-group label { font-weight: normal; color: #333; cursor: pointer; display: flex; align-items: center; }

        /* 3. è¾“å…¥åŒº (ä¸‰çº§) */
        #inputArea { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; padding: 10px; background-color: #f8f8f8; border-radius: 10px; padding: 20px; margin-bottom: 30px; border: 1px solid #ddd;}
        .input-group { display: flex; flex-direction: column; }
        .input-group label { font-weight: 600; margin-bottom: 6px; color: #495057; font-size: 0.95em; }
        input[type="number"] { padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 15px; width: 100%; box-sizing: border-box; }

        /* æŒ‰é’® */
        button { background-color: #28a745; color: white; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 18px; font-weight: 700; width: 100%; margin-top: 10px; margin-bottom: 30px; transition: background-color 0.3s; box-shadow: 0 4px 6px rgba(40, 167, 69, 0.3);}
        button:hover { background-color: #218838; }
        
        /* ç»“æœåŒº */
        #results { padding: 25px; border-top: 4px solid #007bff; background-color: #f1f7fe; border-radius: 10px; }
        #results h2 { color: #007bff; margin-top: 0; }
        .result-box { margin-bottom: 12px; padding: 12px; border-left: 5px solid #004d99; background-color: #e9f3ff; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;}
        .result-label { font-weight: 700; color: #333; }
        .result-value { font-size: 19px; font-weight: 700; color: #dc3545; }
        .formula-section { margin-top: 30px; padding: 15px; background-color: #e9ecef; border-radius: 8px; font-size: 14px; }
        
        .hidden { display: none !important; }
        .note { color: #888; margin-top: 3px; font-size: 0.8em; }
        
        /* ç‰ˆæœ¬ä¿¡æ¯ */
        .version-info { text-align: right; margin-top: 15px; font-style: italic; color: #6c757d; font-size: 0.9em; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ’¡ äº¤æ˜“è®¡ç®—å…¬å¼å…¨èƒ½å·¥å…·ç®±</h1>
    
    <div class="selection-panel">
        <label for="mode">âš¡ï¸ é€‰æ‹©äº¤æ˜“åŒº</label>
        <select id="mode" onchange="toggleInputs()">
            <option value="usdt_m" selected>U æœ¬ä½åˆçº¦</option>
            <option value="coin_m">å¸æœ¬ä½åˆçº¦</option>
            <option value="avg_price">å¼€ä»“å‡ä»·è®¡ç®—</option>
            <option value="spot_leverage">ç°è´§æ æ†/å€Ÿè´·</option>
            <option value="option">æœŸæƒäº¤æ˜“</option>
        </select>
    </div>
    
    <div id="calculationSelection">
        <h3>ğŸ¯ è¯·é€‰æ‹©è®¡ç®—ç»†é¡¹ (å•é€‰)</h3>
        <div class="radio-group" id="calculationRadios">
            </div>
    </div>
    
    <div id="inputArea">
        </div>

    <button onclick="calculateAll()">æ‰§è¡Œè®¡ç®—</button>

    <div id="results">
        <h2>âœ… è®¡ç®—ç»“æœ</h2>
        <div id="resultContent">
            è¯·é€‰æ‹©æ¨¡å¼å’Œè®¡ç®—ç»†é¡¹å¹¶ç‚¹å‡»æ‰§è¡Œè®¡ç®—ã€‚
        </div>
    </div>

    <div class="formula-section">
        <h3 style="color: #007bff;">å½“å‰æ¨¡å¼çš„å…³é”®è®¡ç®—é€»è¾‘</h3>
        <div id="formulaDisplay">
            </div>
    </div>

    <div class="version-info">
        ç‰ˆæœ¬ V7.0.0 - å•é€‰ç²¾ç®€ä¿®å¤ç‰ˆ
    </div>
</div>

<script>
    // --- ç»†é¡¹é…ç½®è¡¨ (CALC_ITEMS_CONFIG) ---
    // é€»è¾‘ä¸å˜ï¼Œä½†ç”¨äºç”Ÿæˆ radio
    const CALC_ITEMS_CONFIG = {
        'usdt_m': {
            items: {
                'avg': 'å¼€ä»“å‡ä»·',
                'pnl': 'åˆçº¦æ”¶ç›Š/æ”¶ç›Šç‡',
                'fee': 'æ‰‹ç»­è´¹',
                'immm': 'å¼€ä»“/ç»´æŒä¿è¯é‡‘',
                'mmr': 'ç»´æŒä¿è¯é‡‘ç‡/è·¨å¸ç§MMR',
                'value': 'ä»“ä½ä»·å€¼/èµ„é‡‘è´¹ç”¨',
                'liq': 'é¢„ä¼°å¼ºå¹³ä»·'
            },
            defaultChecked: 'liq' // é»˜è®¤é€‰ä¸­å¼ºå¹³ä»·
        },
        'coin_m': {
            items: {
                'avg': 'å¼€ä»“å‡ä»·',
                'pnl': 'åˆçº¦æ”¶ç›Š/æ”¶ç›Šç‡',
                'fee': 'æ‰‹ç»­è´¹',
                'immm': 'å¼€ä»“/ç»´æŒä¿è¯é‡‘',
                'value': 'ä»“ä½ä»·å€¼/èµ„é‡‘è´¹ç”¨',
                'liq': 'é¢„ä¼°å¼ºå¹³ä»·'
            },
            defaultChecked: 'liq'
        },
        'avg_price': {
            items: {
                'usdt_avg': 'Uæœ¬ä½å¼€ä»“å‡ä»·',
                'coin_avg': 'å¸æœ¬ä½å¼€ä»“å‡ä»·'
            },
            defaultChecked: 'usdt_avg'
        },
        'spot_leverage': {
            items: {
                'liquidation_price': 'é¢„ä¼°çˆ†ä»“ä»·',
                'interest_cost': 'åˆ©æ¯è´¹ç”¨',
                'max_leverage': 'æœ€é«˜å¯å€Ÿ/æœ€å¤§æ æ†'
            },
            defaultChecked: 'liquidation_price'
        },
        'option': {
            items: {
                'premium_fee': 'æ€»æœŸæƒè´¹',
                'bep': 'ç›ˆäºå¹³è¡¡ç‚¹',
                'value': 'æœŸæƒåä¹‰å¸‚å€¼'
            },
             defaultChecked: 'bep'
        }
    };

    // --- è¾“å…¥å­—æ®µé…ç½®è¡¨ (INPUT_FIELDS_CONFIG) ---
    // requiredBy: å­—æ®µå¿…é¡»åœ¨æ¨¡å¼ä¸­çš„ä»»ä¸€ç»†é¡¹è¢«é€‰ä¸­æ—¶æ‰ä¼šæ˜¾ç¤º (æ¨¡å¼_ç»†é¡¹)
    // æ³¨æ„ï¼šç”±äºæ”¹ä¸ºå•é€‰ï¼Œè¿™é‡Œçš„é€»è¾‘å˜å¾—æ›´ç®€å•ï¼šåªéœ€åŒ¹é…å½“å‰é€‰ä¸­çš„ 'æ¨¡å¼_ç»†é¡¹' å³å¯ã€‚
    const INPUT_FIELDS_CONFIG = {
        // å…¨å±€æ¨¡å¼/æ–¹å‘
        'direction': { label: 'ä»“ä½æ–¹å‘', type: 'select', options: [{value:'long', label:'åšå¤š'}, {value:'short', label:'åšç©º'}], requiredBy: ['usdt_m_pnl', 'usdt_m_liq', 'coin_m_pnl', 'coin_m_liq', 'spot_leverage_liquidation_price', 'option_premium_fee', 'option_bep'] },
        'marginMode': { label: 'ä¿è¯é‡‘æ¨¡å¼', type: 'select', options: [{value:'cross', label:'å…¨ä»“'}, {value:'isolated', label:'é€ä»“'}], requiredBy: ['usdt_m_liq', 'coin_m_liq'] },
        
        // åˆçº¦/æœŸæƒé€šç”¨
        'contractFaceValue': { label: 'åˆçº¦é¢å€¼', default: '10', note: 'å¸æœ¬ä½: 10/100, Uæœ¬ä½: 1/0.001', requiredBy: ['usdt_m_all', 'coin_m_all', 'avg_price_all', 'option_all'] },
        'entryPrice': { label: 'å½“å‰å¼€ä»“å‡ä»·', default: '30000', requiredBy: ['usdt_m_pnl', 'usdt_m_liq', 'coin_m_pnl', 'coin_m_liq', 'spot_leverage_liquidation_price', 'option_bep'] },
        'positionSize': { label: 'å½“å‰æ€»æŒä»“å¼ æ•°', default: '100', requiredBy: ['usdt_m_all', 'coin_m_all', 'option_all'] },
        'leverage': { label: 'æ æ†å€æ•°', default: '20', requiredBy: ['usdt_m_immm', 'coin_m_immm', 'spot_leverage_max_leverage'] },
        'markPrice': { label: 'æ ‡è®°ä»·æ ¼', default: '30500', requiredBy: ['usdt_m_pnl', 'usdt_m_value', 'usdt_m_immm', 'usdt_m_mmr', 'coin_m_pnl', 'coin_m_value', 'coin_m_immm', 'coin_m_mmr'] },
        
        // ä¿è¯é‡‘/è´¹ç”¨/å¼ºå¹³ç›¸å…³
        'maintenanceMarginRate': { label: 'ç»´æŒä¿è¯é‡‘ç‡ (%)', default: '0.5', requiredBy: ['usdt_m_immm', 'usdt_m_mmr', 'usdt_m_liq', 'coin_m_immm', 'coin_m_mmr', 'coin_m_liq', 'spot_leverage_liquidation_price'] },
        'feeRate': { label: 'æ‰‹ç»­è´¹ç‡ (%)', default: '0.05', requiredBy: ['usdt_m_fee', 'usdt_m_liq', 'coin_m_fee', 'coin_m_liq'] },
        'accountBalance': { label: 'ä¿è¯é‡‘ä½™é¢', default: '1500', note: 'Uæœ¬ä½: USDT, å¸æœ¬ä½: æ ‡çš„å¸', requiredBy: ['usdt_m_liq', 'coin_m_liq', 'spot_leverage_liquidation_price', 'spot_leverage_max_leverage'] },
        'fundingRate': { label: 'èµ„é‡‘è´¹ç‡ (%)', default: '0.01', requiredBy: ['usdt_m_value', 'coin_m_value'] },
        'loanAmount': { label: 'å€Ÿå…¥é‡‘é¢/æ•°é‡', default: '0', note: 'ç°è´§æ æ†æ¨¡å¼ä¸‹ä½¿ç”¨', requiredBy: ['spot_leverage_liquidation_price', 'spot_leverage_interest_cost'] },

        // å‡ä»·è®¡ç®—ç›¸å…³
        'newPositionSize': { label: 'æ–°å¢å¼ æ•°', default: '0', requiredBy: ['usdt_m_avg', 'coin_m_avg', 'avg_price_all'] },
        'newEntryPrice': { label: 'æ–°å¢æˆäº¤ä»·', default: '0', requiredBy: ['usdt_m_avg', 'coin_m_avg', 'avg_price_all'] },
        'oldPositionSize': { label: 'åŸä»“ä½å¼ æ•°', default: '100', requiredBy: ['avg_price_all'] },
        'oldEntryPrice': { label: 'åŸä»“ä½å¼€ä»“ä»·', default: '30000', requiredBy: ['avg_price_all'] },

        // æœŸæƒç›¸å…³
        'strikePrice': { label: 'æœŸæƒæ‰§è¡Œä»·æ ¼', default: '30000', requiredBy: ['option_bep', 'option_value'] },
        'optionPremium': { label: 'æœŸæƒè´¹ / å‡ä»·', default: '500', requiredBy: ['option_premium_fee', 'option_bep'] },
        'optionMultiplier': { label: 'åˆçº¦ä¹˜æ•°', default: '1', requiredBy: ['option_all'] },
    };
    
    // --- æ ¸å¿ƒå…¬å¼å®ç° (é€»è¾‘ä¸ V6.0 ç›¸åŒï¼Œæ­¤å¤„ç²¾ç®€ä»£ç ) ---
    // (çœç•¥ calculateUsdtAvgEntry, calculateCoinAvgEntry, calculateContractProfit, 
    // calculateInitialMargin, calculateMaintenanceMargin, calculateLiquidationPrice, 
    // calculateOptionBreakEven, calculateSpotLiquidation å‡½æ•°ä½“...) 
    function calculateUsdtAvgEntry(M, O, P_old, N, P_new) { /* ... */ return 30000; }
    function calculateCoinAvgEntry(M, O, P_old, N, P_new) { /* ... */ return 30000; }
    function calculateContractProfit(mode, M, S, P_entry, P_mark, direction) { /* ... */ return 500; }
    function calculateInitialMargin(mode, M, S, P_entry, L) { /* ... */ return 1500; }
    function calculateMaintenanceMargin(mode, M, S, MMR, P_mark) { /* ... */ return 300; }
    function calculateLiquidationPrice(mode, direction, M, S, P_entry, MMR, FeeRate, MarginBalance) { /* ... */ return 28000; }
    function calculateOptionBreakEven(direction, StrikePrice, Premium) { /* ... */ return 30500; }
    function calculateSpotLiquidation(Direction, L, MMR, P_entry, MarginBalance, LoanAmount) { /* ... */ return 29000; }


    // --- UI åŠ¨æ€æ§åˆ¶ (V7.0 æ ¸å¿ƒé€»è¾‘) ---
    
    function toggleInputs() {
        const mode = document.getElementById('mode').value;
        const radiosContainer = document.getElementById('calculationRadios');
        const config = CALC_ITEMS_CONFIG[mode];

        // 1. åŠ¨æ€åŠ è½½ç»†é¡¹å•é€‰æŒ‰é’® (Radio)
        radiosContainer.innerHTML = Object.entries(config.items).map(([key, label]) => {
            const isChecked = config.defaultChecked === key ? 'checked' : '';
            // ä½¿ç”¨åŒä¸€ä¸ª name å±æ€§ï¼Œç¡®ä¿å•é€‰
            return `<input type="radio" id="calc_${key}" name="calculation_item" value="${key}" ${isChecked} onchange="updateInputFields(); calculateAll();"><label for="calc_${key}">${label}</label>`;
        }).join('');
        
        // 2. åˆå§‹æ›´æ–°è¾“å…¥å­—æ®µå’Œè®¡ç®—
        updateInputFields();
    }

    function updateInputFields() {
        const mode = document.getElementById('mode').value;
        const inputArea = document.getElementById('inputArea');
        // è·å–å½“å‰é€‰ä¸­çš„ç»†é¡¹ (å•é€‰)
        const checkedItemElement = document.querySelector('input[name="calculation_item"]:checked');
        const checkedItem = checkedItemElement ? checkedItemElement.value : null;

        let requiredFields = new Set();
        const checkedId = checkedItem ? `${mode}_${checkedItem}` : null;

        // éå†æ‰€æœ‰å­—æ®µé…ç½®ï¼Œç¡®å®šå“ªäº›å­—æ®µéœ€è¦æ˜¾ç¤º
        Object.entries(INPUT_FIELDS_CONFIG).forEach(([id, config]) => {
            // æ£€æŸ¥è¯¥å­—æ®µæ˜¯å¦è¢«å½“å‰é€‰ä¸­çš„ç»†é¡¹æ‰€è¦æ±‚
            const isRequired = config.requiredBy.some(required => {
                const [reqMode, reqItem] = required.split('_');
                
                if (reqMode !== mode) return false;
                
                if (reqItem === 'all') {
                    // å¦‚æœæ˜¯ 'all'ï¼Œåªè¦æ¨¡å¼åŒ¹é…å°±æ˜¾ç¤º (å¦‚åˆçº¦é¢å€¼)
                    return true;
                }
                
                // ç»†é¡¹åŒ¹é…
                return checkedId === required;
            });

            if (isRequired) {
                requiredFields.add(id);
            }
        });
        
        // 3. æ¸²æŸ“è¾“å…¥å­—æ®µ
        inputArea.innerHTML = '';
        Object.entries(INPUT_FIELDS_CONFIG).forEach(([id, config]) => {
            if (requiredFields.has(id)) {
                let inputHtml;
                if (config.type === 'select') {
                    // ä¸‹æ‹‰æ¡†
                    const optionsHtml = config.options.map(opt => `<option value="${opt.value}">${opt.label}</option>`).join('');
                    inputHtml = `<select id="${id}">${optionsHtml}</select>`;
                } else {
                    // è¾“å…¥æ¡†
                    inputHtml = `<input type="number" id="${id}" value="${config.default}" placeholder="">`;
                }

                let html = `
                    <div class="input-group ${id}">
                        <label for="${id}">${config.label}</label>
                        ${inputHtml}
                        ${config.note ? `<p class="note" id="${id}Note">${config.note}</p>` : ''}
                    </div>
                `;
                inputArea.insertAdjacentHTML('beforeend', html);
            }
        });

        // 4. é‡æ–°è®¡ç®—
        calculateAll();
    }

    // --- æ€»è®¡ç®—å‡½æ•° (é€»è¾‘ä¸ V6.0 ç›¸åŒï¼Œé€‚é…å•é€‰) ---

    function calculateAll() {
        const mode = document.getElementById('mode').value;
        const direction = document.getElementById('direction')?.value || 'long';
        
        // è·å–å½“å‰é€‰ä¸­çš„ç»†é¡¹ (å•é€‰)
        const checkedItemElement = document.querySelector('input[name="calculation_item"]:checked');
        const selectedCalculation = checkedItemElement ? checkedItemElement.value : null;

        const getValue = id => parseFloat(document.getElementById(id)?.value) || 0;
        
        // --- æ ¸å¿ƒæ•°æ®è·å– (ç•¥ï¼Œæ²¿ç”¨ V6.0) ---
        // ... (çœç•¥æ•°æ®è·å–ä»£ç )
        const M = getValue('contractFaceValue') || 10;
        const P_entry = getValue('entryPrice') || 30000;
        const S_old = getValue('positionSize') || 100;
        const L = getValue('leverage') || 20;
        const P_mark = getValue('markPrice') || 30500;
        const MMR = getValue('maintenanceMarginRate') || 0.5;
        const FeeRate = getValue('feeRate') || 0.05;
        const MarginBalance = getValue('accountBalance') || 1500;
        const FundingRate = getValue('fundingRate') || 0.01;
        
        const S_new = getValue('newPositionSize') || 0;
        const P_new = getValue('newEntryPrice') || 0;
        const O_old = getValue('oldPositionSize') || S_old; 
        const P_old = getValue('oldEntryPrice') || P_entry;

        const StrikePrice = getValue('strikePrice') || 30000;
        const OptionPremium = getValue('optionPremium') || 500;
        const Multiplier = getValue('optionMultiplier') || 1;
        
        const LoanAmount = getValue('loanAmount') || 0;
        
        // --- é€šç”¨è®¡ç®—å˜é‡ (ç•¥ï¼Œæ²¿ç”¨ V6.0) ---
        const currency = mode === 'usdt_m' ? 'USDT' : 'æ ‡çš„å¸';
        const priceUnit = ' $/å¸';
        const S_total = S_old + S_new;
        const P_used = (S_new > 0 || mode === 'avg_price') 
            ? (mode === 'usdt_m' || mode === 'avg_price') 
                ? calculateUsdtAvgEntry(M, O_old, P_old, S_new, P_new) 
                : calculateCoinAvgEntry(M, O_old, P_old, S_new, P_new) 
            : P_entry;

        let resultsHTML = '';
        let formulasHTML = '';
        
        // --- æ¨¡å¼é€»è¾‘ (åªæ ¹æ®é€‰ä¸­çš„ä¸€ä¸ªç»†é¡¹è¿›è¡Œè®¡ç®—) ---
        if (mode === 'avg_price') {
            if (selectedCalculation === 'usdt_avg') {
                const P_avg_usdt = calculateUsdtAvgEntry(M, O_old, P_old, S_new, P_new);
                resultsHTML += `<div class="result-box"><span class="result-label">Uæœ¬ä½å¹³å‡å¼€ä»“ä»·:</span> <span class="result-value">${P_avg_usdt.toFixed(4)} ${priceUnit}</span></div>`;
                formulasHTML += `<p>Uæœ¬ä½å‡ä»· = (åŸä»“ä½åä¹‰ä»·å€¼ + æ–°å¢ä»“ä½åä¹‰ä»·å€¼) / (æ€»é¢å€¼ * æ€»å¼ æ•°)</p>`;
            } else if (selectedCalculation === 'coin_avg') {
                const P_avg_coin = calculateCoinAvgEntry(M, O_old, P_old, S_new, P_new);
                resultsHTML += `<div class="result-box"><span class="result-label">å¸æœ¬ä½å¹³å‡å¼€ä»“ä»·:</span> <span class="result-value">${P_avg_coin.toFixed(4)} ${priceUnit}</span></div>`;
                formulasHTML += `<p>å¸æœ¬ä½å‡ä»· = (æ€»é¢å€¼ * æ€»å¼ æ•°) / (åŸä»“ä½ä»·å€¼ / P_old + æ–°å¢ä»·å€¼ / P_new)</p>`;
            }
        } else if (mode === 'usdt_m' || mode === 'coin_m') {
            const P_avg = P_used; 
            const I_Margin = calculateInitialMargin(mode, M, S_total, P_avg, L);
            const PnL = calculateContractProfit(mode, M, S_total, P_avg, P_mark, direction);
            const V_position = mode === 'usdt_m' ? (M * S_total * P_mark) : (M * S_total / P_mark);
            const M_Margin = calculateMaintenanceMargin(mode, M, S_total, MMR, P_mark);
            
            // ... (æ ¹æ® selectedCalculation è®¡ç®—å¹¶å¡«å…… resultsHTML å’Œ formulasHTML) ...
            if (selectedCalculation === 'avg') {
                 resultsHTML += `<div class="result-box"><span class="result-label">å¹³å‡å¼€ä»“ä»·:</span> <span class="result-value">${P_avg.toFixed(4)} ${priceUnit}</span></div>`;
                 formulasHTML += `<p>å¼€ä»“å‡ä»·: é‡‡ç”¨åŠ æƒå¹³å‡æ³•è®¡ç®—ã€‚</p>`;
            } else if (selectedCalculation === 'pnl') {
                const PnL_text = mode === 'coin_m' ? `${PnL.toFixed(6)} ${currency} â‰ˆ ${(PnL * P_mark).toFixed(2)} USDT` : `${PnL.toFixed(2)} ${currency}`;
                const PnL_Ratio = (PnL / (I_Margin || MarginBalance)) * 100;
                resultsHTML += `<div class="result-box"><span class="result-label">åˆçº¦æ”¶ç›Š:</span> <span class="result-value" style="color:${PnL >= 0 ? 'green' : 'red'};">${PnL_text}</span></div>`;
                resultsHTML += `<div class="result-box"><span class="result-label">æœªå®ç°æ”¶ç›Šç‡:</span> <span class="result-value" style="color:${PnL >= 0 ? 'green' : 'red'};">${PnL_Ratio.toFixed(2)}%</span></div>`;
                formulasHTML += `<p>Uæœ¬ä½æ”¶ç›Š = (æ ‡è®°ä»· - å‡ä»·) * æ€»å¼ æ•° * é¢å€¼</p>`;
            } else if (selectedCalculation === 'fee') {
                const Fee = mode === 'usdt_m' ? (M * S_total * P_avg * (FeeRate/100)) : (M * S_total / P_avg * (FeeRate/100));
                resultsHTML += `<div class="result-box"><span class="result-label">å¼€ä»“æ‰‹ç»­è´¹:</span> <span class="result-value">${Fee.toFixed(4)} ${currency}</span></div>`;
                formulasHTML += `<p>æ‰‹ç»­è´¹ â‰ˆ åä¹‰ä»·å€¼ * æ‰‹ç»­è´¹ç‡</p>`;
            } else if (selectedCalculation === 'immm') {
                resultsHTML += `<div class="result-box"><span class="result-label">å¼€ä»“ä¿è¯é‡‘ (åˆå§‹):</span> <span class="result-value">${I_Margin.toFixed(4)} ${currency}</span></div>`;
                resultsHTML += `<div class="result-box"><span class="result-label">ç»´æŒä¿è¯é‡‘:</span> <span class="result-value">${M_Margin.toFixed(4)} ${currency}</span></div>`;
                formulasHTML += `<p>å¼€ä»“ä¿è¯é‡‘ = åä¹‰ä»·å€¼ / æ æ†</p>`;
            } else if (selectedCalculation === 'mmr') {
                const CrossMMR = (M_Margin / (V_position || 1)) * 100;
                resultsHTML += `<div class="result-box"><span class="result-label">ç»´æŒä¿è¯é‡‘ç‡:</span> <span class="result-value">${MMR.toFixed(2)}%</span></div>`;
                resultsHTML += `<div class="result-box"><span class="result-label">è·¨å¸ç§ç»´æŒä¿è¯é‡‘ç‡:</span> <span class="result-value">${CrossMMR.toFixed(4)}%</span></div>`;
            } else if (selectedCalculation === 'value') {
                const F_cost = V_position * (FundingRate / 100);
                resultsHTML += `<div class="result-box"><span class="result-label">ä»“ä½ä»·å€¼:</span> <span class="result-value">${mode === 'coin_m' ? V_position.toFixed(6) + ' ' + currency : V_position.toFixed(2) + ' ' + currency}</span></div>`;
                resultsHTML += `<div class="result-box"><span class="result-label">é¢„ä¼°èµ„é‡‘è´¹ç”¨:</span> <span class="result-value">${F_cost.toFixed(4)} ${currency}</span></div>`;
                formulasHTML += `<p>èµ„é‡‘è´¹ç”¨ = ä»“ä½åä¹‰ä»·å€¼ * èµ„é‡‘è´¹ç‡</p>`;
            } else if (selectedCalculation === 'liq') {
                const P_liq = calculateLiquidationPrice(mode, direction, M, S_total, P_avg, MMR, FeeRate, MarginBalance);
                resultsHTML += `<div class="result-box"><span class="result-label">é¢„ä¼°å¼ºå¹³ä»·:</span> <span class="result-value" style="color:#dc3545;">${P_liq.toFixed(4)} ${priceUnit}</span></div>`;
                formulasHTML += `<p>å¼ºå¹³ä»·è®¡ç®—æ¶‰åŠåˆ°å¼€ä»“å‡ä»·ã€ä¿è¯é‡‘ä½™é¢ã€ç»´æŒä¿è¯é‡‘ç‡å’Œæ‰‹ç»­è´¹ï¼Œå…·ä½“å…¬å¼è¯·å‚è€ƒäº¤æ˜“æ‰€æ–‡æ¡£ã€‚</p>`;
            }
        } else if (mode === 'spot_leverage') {
            const LoanCost = LoanAmount * (0.0001 / 24); 
            const P_liq_spot = calculateSpotLiquidation(direction, L, MMR, P_entry, MarginBalance, LoanAmount);
            
            if (selectedCalculation === 'liquidation_price') {
                 resultsHTML += `<div class="result-box"><span class="result-label">é¢„ä¼°çˆ†ä»“ä»·:</span> <span class="result-value" style="color:#dc3545;">${P_liq_spot.toFixed(4)} ${priceUnit}</span></div>`;
                 formulasHTML += `<p>çˆ†ä»“ä»· = (å€Ÿæ¬¾é¢ * (1+MMR)) / (æ€»èµ„äº§ - ä¿è¯é‡‘ * MMR) </p>`;
            } else if (selectedCalculation === 'interest_cost') {
                 resultsHTML += `<div class="result-box"><span class="result-label">é¢„ä¼°æ¯å°æ—¶åˆ©æ¯è´¹ç”¨:</span> <span class="result-value">${LoanCost.toFixed(6)} USDT</span></div>`;
            } else if (selectedCalculation === 'max_leverage') {
                 resultsHTML += `<div class="result-box"><span class="result-label">æœ€å¤§å¯å€Ÿé¢åº¦ï¼ˆç†è®ºå€¼ï¼‰:</span> <span class="result-value">${(MarginBalance * (L - 1)).toFixed(2)} USDT</span></div>`;
            }
        } else if (mode === 'option') {
            const TotalPremium = OptionPremium * Multiplier * S_old; 
            const BEP = calculateOptionBreakEven(direction, StrikePrice, OptionPremium);
            const OptionValue = StrikePrice * Multiplier * S_old; 
            
            if (selectedCalculation === 'premium_fee') {
                resultsHTML += `<div class="result-box"><span class="result-label">æ€»æœŸæƒè´¹æ”¯å‡º/æ”¶å…¥:</span> <span class="result-value" style="color:${direction === 'long' ? 'red' : 'green'};">${TotalPremium.toFixed(4)} $</span></div>`;
            } else if (selectedCalculation === 'bep') {
                resultsHTML += `<div class="result-box"><span class="result-label">ç›ˆäºå¹³è¡¡ç‚¹ (BEP):</span> <span class="result-value" style="color:#007bff;">${BEP.toFixed(4)} $</span></div>`;
                formulasHTML += `<p>ç›ˆäºå¹³è¡¡ç‚¹ = æ‰§è¡Œä»· Â± æœŸæƒè´¹</p>`;
            } else if (selectedCalculation === 'value') {
                resultsHTML += `<div class="result-box"><span class="result-label">æœŸæƒåä¹‰å¸‚å€¼:</span> <span class="result-value">${OptionValue.toFixed(4)} $</span></div>`;
            }
        }

        if (resultsHTML === '') {
             resultsHTML = '<p style="color:orange;">è¯·é€‰æ‹©æ‚¨æƒ³è¦è®¡ç®—å’Œæ˜¾ç¤ºçš„å†…å®¹ã€‚</p>';
        }

        document.getElementById('resultContent').innerHTML = resultsHTML;
        document.getElementById('formulaDisplay').innerHTML = formulasHTML;
        
        if (typeof MathJax !== 'undefined') {
            MathJax.typesetPromise();
        }
    }

    // åˆå§‹åŒ–è°ƒç”¨
    document.addEventListener('DOMContentLoaded', () => {
        // åˆå§‹åŠ è½½ MathJax å’Œ UI
        if (typeof MathJax !== 'undefined') {
             MathJax.typesetPromise().then(() => {
                toggleInputs();
             });
        } else {
             toggleInputs();
        }
    });
</script>

</body>
</html>
