<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<title>合约公式计算器 · Excel版可视化</title>
<style>
  *{box-sizing:border-box;}
  body{
    margin:0;
    padding:24px;
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    background:#f5f7fb;
    color:#111827;
  }
  .wrap{max-width:1180px;margin:0 auto;}
  h1{margin:0 0 14px;font-size:22px;}
  .top-row{
    display:flex;
    gap:12px;
    margin-bottom:16px;
    flex-wrap:wrap;
  }
  .top-row select{
    padding:8px 10px;
    border-radius:8px;
    border:1px solid #d0d4e0;
    font-size:14px;
    min-width:220px;
  }
  .grid{
    display:grid;
    grid-template-columns: minmax(0,2.3fr) minmax(0,2.1fr) minmax(0,2.1fr);
    gap:16px;
  }
  .card{
    background:#fff;
    border-radius:14px;
    padding:16px 16px 18px;
    border:1px solid #e1e4f0;
  }
  .card h2{
    font-size:15px;
    margin:0 0 10px;
  }
  label{
    font-size:13px;
    font-weight:600;
    display:block;
    margin-bottom:4px;
  }
  input,select{
    width:100%;
    padding:8px 9px;
    border-radius:7px;
    border:1px solid #d0d4e0;
    font-size:14px;
  }
  .row2{
    display:grid;
    grid-template-columns:repeat(2,minmax(0,1fr));
    gap:10px;
  }
  .field{margin-bottom:9px;}
  button{
    width:100%;
    margin-top:10px;
    padding:11px;
    border-radius:8px;
    border:none;
    background:#005cff;
    color:#fff;
    font-size:15px;
    font-weight:600;
    cursor:pointer;
  }
  button:hover{opacity:.92;}
  .result-block{
    margin-top:4px;
    padding:10px 11px;
    border-radius:10px;
    background:#f3f4ff;
    font-size:13px;
    line-height:1.6;
  }
  .res-row{
    display:flex;
    justify-content:space-between;
    margin-bottom:3px;
  }
  .res-row span:first-child{color:#4b5563;}
  .res-row span:last-child{font-weight:600;}
  .res-row.big span:last-child{font-size:15px;}
  .hint{font-size:11px;color:#9ca3af;margin-top:1px;}
</style>
</head>
<body>
<div class="wrap">

  <h1>合约公式计算器 · 来自 Excel 公式整理</h1>

  <div class="top-row">
    <select id="sheetType">
      <option value="u_perp">U本位合约（当前）</option>
      <option value="coin_perp" disabled>币本位合约（预留，对应 Excel「币本位合约」页）</option>
      <option value="avg_open" disabled>开仓均价 · 合约 U+币本（预留）</option>
      <option value="margin_spot" disabled>现货杠杆（预留）</option>
      <option value="spot_avg" disabled>现货开仓均价（预留）</option>
      <option value="option" disabled>期权（预留）</option>
    </select>
  </div>

  <div class="grid">

    <!-- 左：U本位参数 + 手续费（全部手动输入） -->
    <div class="card">
      <h2>U本位合约 · 基础参数</h2>

      <div class="row2">
        <div class="field">
          <label>方向</label>
          <select id="side">
            <option value="long">做多</option>
            <option value="short">做空</option>
          </select>
        </div>
        <div class="field">
          <label>合约面值</label>
          <input id="faceValue" type="text" inputmode="decimal" placeholder="例如 0.01 / 1" />
          <div class="hint">Excel：面值</div>
        </div>
      </div>

      <div class="row2">
        <div class="field">
          <label>开仓均价</label>
          <input id="openPx" type="text" inputmode="decimal" placeholder="支持小数" />
        </div>
        <div class="field">
          <label>平仓均价</label>
          <input id="closePx" type="text" inputmode="decimal" placeholder="支持小数" />
        </div>
      </div>

      <div class="row2">
        <div class="field">
          <label>张数</label>
          <input id="contracts" type="text" inputmode="decimal" placeholder="正数，对应 Excel「张数」" />
        </div>
        <div class="field">
          <label>杠杆倍数</label>
          <input id="leverage" type="text" inputmode="decimal" value="10" />
          <div class="hint">Excel：杠杆</div>
        </div>
      </div>

      <div class="row2">
        <div class="field">
          <label>开仓手续费率</label>
          <input id="feeOpen" type="text" inputmode="decimal" placeholder="手动输入，例如 0.0005" />
          <div class="hint">Excel：手续费率</div>
        </div>
        <div class="field">
          <label>平仓手续费率</label>
          <input id="feeClose" type="text" inputmode="decimal" placeholder="手动输入，例如 0.0005" />
        </div>
      </div>

      <h2 style="margin-top:14px;">风险相关参数</h2>

      <div class="row2">
        <div class="field">
          <label>标记价格</label>
          <input id="markPx" type="text" inputmode="decimal" placeholder="Excel：标记价格" />
        </div>
        <div class="field">
          <label>资金费率</label>
          <input id="fundingRate" type="text" inputmode="decimal" placeholder="例如 0.0005" />
          <div class="hint">Excel：资金费率</div>
        </div>
      </div>

      <div class="row2">
        <div class="field">
          <label>仓位维持保证金率</label>
          <input id="mmRate" type="text" inputmode="decimal" placeholder="例如 0.005" />
          <div class="hint">Excel：仓位维持保证金率</div>
        </div>
        <div class="field">
          <label>强平计算手续费率</label>
          <input id="liqFeeRate" type="text" inputmode="decimal" placeholder="例如 0.0005" />
          <div class="hint">用于强平价公式中的手续费率</div>
        </div>
      </div>

      <div class="field">
        <label>保证金余额</label>
        <input id="marginBalance" type="text" inputmode="decimal" placeholder="Excel：保证金余额" />
      </div>
    </div>

    <!-- 中：保证金 / 收益 / 资金费用 -->
    <div class="card">
      <h2>保证金 / 收益 / 资金费用</h2>

      <button onclick="calcAll()">按 Excel 公式计算</button>

      <div id="blockMain" class="result-block">
        填写参数后点击上方按钮。
      </div>
    </div>

    <!-- 右：维持保证金 / 仓位价值 / 预估强平价 -->
    <div class="card">
      <h2>维持保证金 / 强平相关</h2>

      <div id="blockRisk" class="result-block">
        将维持保证金率、保证金余额等填好后一起计算。
      </div>
    </div>

  </div>

</div>

<script>
function toNum(id){
  const raw = document.getElementById(id).value.trim().replace(/,/g,'').replace(/，/g,'').replace(/\s+/g,'');
  if(!raw) return null;
  const v = parseFloat(raw);
  return Number.isFinite(v) ? v : null;
}

function calcAll(){
  const type = document.getElementById("sheetType").value;
  const mainBox = document.getElementById("blockMain");
  const riskBox = document.getElementById("blockRisk");

  if(type !== "u_perp"){
    mainBox.innerHTML = "当前仅启用：Excel《U本位合约》页相关公式。其它类型已预留。";
    riskBox.innerHTML = "请选择 U本位合约进行计算。";
    return;
  }

  const side      = document.getElementById("side").value;
  const faceValue = toNum("faceValue");
  const openPx    = toNum("openPx");
  const closePx   = toNum("closePx");
  const contracts = toNum("contracts");
  const lev       = toNum("leverage");
  const feeOpen   = toNum("feeOpen");
  const feeClose  = toNum("feeClose");
  const markPx    = toNum("markPx");
  const funding   = toNum("fundingRate");
  const mmRate    = toNum("mmRate");
  const liqFee    = toNum("liqFeeRate");
  const mb        = toNum("marginBalance");

  if([faceValue,openPx,closePx,contracts,lev,feeOpen,feeClose].some(v => v===null)){
    mainBox.innerHTML = "请至少把：合约面值 / 开平仓价 / 张数 / 杠杆 / 两个手续费率 填完整。";
    return;
  }

  const absContracts = Math.abs(contracts);

  // 开仓保证金（初始） = 面值 * 开仓价格 * 张数 / 杠杆
  const openMargin = faceValue * openPx * absContracts / lev;

  // 合约收益（未扣手续费）
  let grossPnl = 0;
  if(side === "long"){
    grossPnl = faceValue * absContracts * (closePx - openPx);
  }else{
    grossPnl = faceValue * absContracts * (openPx - closePx);
  }

  // 手续费 = 面值 * 张数 * 开或平仓均价 * 手续费率
  const feeOpenAmt  = faceValue * absContracts * openPx  * feeOpen;
  const feeCloseAmt = faceValue * absContracts * closePx * feeClose;
  const totalFee    = feeOpenAmt + feeCloseAmt;

  const netPnl      = grossPnl - totalFee;
  const roe         = openMargin !== 0 ? netPnl / openMargin * 100 : 0;

  let posValue = null;
  let fundingFee = null;
  if(markPx !== null){
    // 仓位价值 = 面值 * 张数 * 标记价格
    posValue = faceValue * absContracts * markPx;
    if(funding !== null){
      // 资金费用 = 仓位价值 × 资金费率
      fundingFee = posValue * funding;
    }
  }

  mainBox.innerHTML =
    row("开仓保证金（初始保证金）", fmt(openMargin,8)) +
    row("开仓手续费", fmt(feeOpenAmt,8)) +
    row("平仓手续费", fmt(feeCloseAmt,8)) +
    row("总手续费", fmt(totalFee,8)) +
    row("合约收益（未扣手续费）", fmt(grossPnl,8)) +
    rowBig("最终盈亏（含手续费）", fmt(netPnl,8)) +
    row("收益率（收益 / 开仓保证金）", fmt(roe,4) + " %") +
    (posValue!==null ? row("仓位价值", fmt(posValue,8)) : "") +
    (fundingFee!==null ? row("资金费用", fmt(fundingFee,8)) : "");

  // 维持保证金 / 强平
  if(markPx===null || mmRate===null){
    riskBox.innerHTML = "若要计算维持保证金 / 强平价，请补充：标记价格、仓位维持保证金率、保证金余额等。";
    return;
  }

  const maintMargin = faceValue * absContracts * mmRate * markPx;

  let liqLong = null, liqShort = null;
  if(mb!==null && liqFee!==null){
    const pos = faceValue * absContracts;
    const denomLong  = pos * (mmRate + liqFee - 1);
    const denomShort = pos * (mmRate + liqFee + 1);
    if(denomLong!==0){
      liqLong = (mb - pos * openPx) / denomLong;
    }
    if(denomShort!==0){
      liqShort = (mb + pos * openPx) / denomShort;
    }
  }

  riskBox.innerHTML =
    row("维持保证金", fmt(maintMargin,8)) +
    (liqLong!==null  ? row("多仓预估强平价", fmt(liqLong,8))   : "") +
    (liqShort!==null ? row("空仓预估强平价", fmt(liqShort,8)) : "");
}

function row(label, val){
  return '<div class="res-row"><span>'+label+'</span><span>'+val+'</span></div>';
}
function rowBig(label,val){
  return '<div class="res-row big"><span>'+label+'</span><span>'+val+'</span></div>';
}
function fmt(v,dec){
  if(v===null || !Number.isFinite(v)) return "-";
  return v.toFixed(dec);
}
</script>

</body>
</html>
