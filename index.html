<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<title>U本位合约计算器（Excel 完整版）</title>

<style>
  *{box-sizing:border-box;}
  body{
    margin:0; padding:28px;
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    background:linear-gradient(135deg,#f4f6ff,#eef1f7);
    color:#111;
  }
  .wrap{max-width:1200px;margin:0 auto;}
  h1{margin:0 0 18px;font-size:23px;font-weight:700;}
  .card{
    background:white;
    padding:20px 22px;
    border-radius:14px;
    box-shadow:0 4px 14px rgba(0,0,0,.06);
    border:1px solid #e4e6f2;
    margin-bottom:22px;
  }
  h2{margin:0 0 12px;font-size:17px;font-weight:700;}
  label{font-size:13px;font-weight:600;display:block;margin-bottom:4px;}
  input,select{
    width:100%; padding:9px 10px;
    border-radius:8px; border:1px solid #ccd0da;
    font-size:14px; background:#fafbff;
  }
  .grid2{
    display:grid; grid-template-columns:repeat(2,minmax(0,1fr));
    gap:14px;
  }
  button{
    width:100%; margin-top:14px; padding:12px;
    border:none; border-radius:8px;
    background:#0061ff; color:white;
    font-size:15px; font-weight:600;
    cursor:pointer;
  }
  .result-block{
    margin-top:10px; padding:14px;
    background:#f5f6ff; border-radius:10px;
    border:1px solid #dfe3ff;
    font-size:14px;
  }
  .row{
    display:flex; justify-content:space-between;
    margin-bottom:6px; font-size:14px;
  }
  .row span:first-child{color:#4c5161;}
  .row.big span:last-child{font-size:16px;}
</style>
</head>

<body>
<div class="wrap">

<h1>U本位合约 · Excel 公式完整版</h1>

<!-- 参数输入卡片 -->
<div class="card">
  <h2>基础参数</h2>

  <div class="grid2">
    <div>
      <label>方向</label>
      <select id="side">
        <option value="long">做多</option>
        <option value="short">做空</option>
      </select>
    </div>

    <div>
      <label>面值</label>
      <input id="faceValue" type="text" inputmode="decimal" />
    </div>

    <div>
      <label>开仓均价</label>
      <input id="openPx" type="text" inputmode="decimal" />
    </div>

    <div>
      <label>平仓均价</label>
      <input id="closePx" type="text" inputmode="decimal" />
    </div>

    <div>
      <label>张数</label>
      <input id="contracts" type="text" inputmode="decimal" />
    </div>

    <div>
      <label>杠杆倍数</label>
      <input id="leverage" type="text" inputmode="decimal" />
    </div>
  </div>

  <h2 style="margin-top:18px;">手续费（允许负数）</h2>

  <div class="grid2">
    <div>
      <label>Maker（%）</label>
      <input id="makerFee" type="text" inputmode="decimal" placeholder="输入百分比，如 0.05" />
    </div>
    <div>
      <label>Taker（%）</label>
      <input id="takerFee" type="text" inputmode="decimal" placeholder="输入百分比，如 0.05" />
    </div>

    <div>
      <label>开仓使用</label>
      <select id="openRole">
        <option value="maker">Maker</option>
        <option value="taker">Taker</option>
      </select>
    </div>

    <div>
      <label>平仓使用</label>
      <select id="closeRole">
        <option value="maker">Maker</option>
        <option value="taker">Taker</option>
      </select>
    </div>
  </div>

  <h2 style="margin-top:18px;">风险参数</h2>

  <div class="grid2">
    <div>
      <label>标记价格</label>
      <input id="markPx" type="text" inputmode="decimal" />
    </div>

    <div>
      <label>资金费率（%）</label>
      <input id="fundingRate" type="text" inputmode="decimal" />
    </div>

    <div>
      <label>维持保证金率（%）</label>
      <input id="mmRate" type="text" inputmode="decimal" />
    </div>

    <div>
      <label>强平手续费率（%）</label>
      <input id="liqFeeRate" type="text" inputmode="decimal" />
    </div>

    <div>
      <label>保证金余额</label>
      <input id="marginBalance" type="text" inputmode="decimal" />
    </div>
  </div>

  <button onclick="calcU()">计算（Excel 全公式）</button>
</div>

<!-- 结果 -->
<div class="card">
  <h2>计算结果</h2>
  <div id="result" class="result-block">
    输入数据后点击“计算”。
  </div>
</div>

</div>

<script>
function num(id){
  let v = document.getElementById(id).value.trim();
  if(!v) return null;
  v = v.replace(/,/g,'').replace(/，/g,'');
  return parseFloat(v);
}

function pctToDecimal(v){
  // 输入 0.05 → 0.05% → 0.0005
  return v / 100;
}

function calcU(){
  const side = document.getElementById("side").value;
  const face = num("faceValue");
  const open = num("openPx");
  const close = num("closePx");
  const ctt = num("contracts");
  const lev = num("leverage");

  const makerPct = num("makerFee");
  const takerPct = num("takerFee");

  const openRole = document.getElementById("openRole").value;
  const closeRole = document.getElementById("closeRole").value;

  const mark = num("markPx");
  const fundPct = num("fundingRate");
  const mmPct = num("mmRate");
  const liqPct = num("liqFeeRate");
  const mb = num("marginBalance");

  if([face,open,close,ctt,lev].some(v => v === null)){
    result.innerHTML = "请先把所有主要参数输入完整。";
    return;
  }

  const absC = Math.abs(ctt);

  // 手续费转换
  const maker = pctToDecimal(makerPct || 0);
  const taker = pctToDecimal(takerPct || 0);

  const feeOpenRate = openRole === "maker" ? maker : taker;
  const feeCloseRate = closeRole === "maker" ? maker : taker;

  // Excel：开仓保证金
  const margin = face * absC * open / lev;

  // Excel：未扣手续费的收益
  let pnl = 0;
  if(side === "long"){
    pnl = face * absC * (close - open);
  }else{
    pnl = face * absC * (open - close);
  }

  // 手续费
  const feeOpen = face * absC * open * feeOpenRate;
  const feeClose = face * absC * close * feeCloseRate;
  const totalFee = feeOpen + feeClose;

  // 扣手续费后的收益
  const net = pnl - totalFee;

  // ROE
  const roe = margin !== 0 ? (net / margin * 100) : 0;

  // 仓位价值
  let posValue = null, fundingFee = null;
  if(mark !== null){
    posValue = face * absC * mark;

    if(fundPct !== null){
      const fund = pctToDecimal(fundPct);
      fundingFee = posValue * fund;
    }
  }

  // 维持保证金
  let maint = null;
  if(mark !== null && mmPct !== null){
    const mm = pctToDecimal(mmPct);
    maint = face * absC * mark * mm;
  }

  // 强平价
  let liqLong = null, liqShort = null;
  if(mb !== null && liqPct !== null && mark !== null){
    const mm = pctToDecimal(mmPct || 0);
    const liqF = pctToDecimal(liqPct);

    const pos = face * absC;

    // 多仓强平价（Excel 结构）
    const denomLong = pos * (mm + liqF - 1);
    if(denomLong !== 0){
      liqLong = (mb - pos * open) / denomLong;
    }

    // 空仓强平价（Excel 结构）
    const denomShort = pos * (mm + liqF + 1);
    if(denomShort !== 0){
      liqShort = (mb + pos * open) / denomShort;
    }
  }

  // 输出
  let html = "";
  html += row("开仓保证金", margin.toFixed(8));
  html += row("开仓手续费", feeOpen.toFixed(8));
  html += row("平仓手续费", feeClose.toFixed(8));
  html += row("总手续费", totalFee.toFixed(8));
  html += row("收益（未扣手续费）", pnl.toFixed(8));
  html += rowBig("最终收益（含手续费）", net.toFixed(8));
  html += row("收益率 ROE", roe.toFixed(4) + " %");

  if(posValue !== null) html += row("仓位价值", posValue.toFixed(8));
  if(fundingFee !== null) html += row("资金费用", fundingFee.toFixed(8));

  if(maint !== null) html += row("维持保证金", maint.toFixed(8));
  if(liqLong !== null) html += row("多仓强平价", liqLong.toFixed(8));
  if(liqShort !== null) html += row("空仓强平价", liqShort.toFixed(8));

  document.getElementById("result").innerHTML = html;
}

function row(a,b){
  return `<div class="row"><span>${a}</span><span>${b}</span></div>`;
}
function rowBig(a,b){
  return `<div class="row big"><span>${a}</span><span>${b}</span></div>`;
}
</script>

</body>
</html>
