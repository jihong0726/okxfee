<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>交易计算工具 · 内部自用</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    html, body {
      height: 100%;
      -webkit-text-size-adjust: 100%;
      touch-action: manipulation;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "PingFang SC",
      "Helvetica Neue", Arial, sans-serif;
      background: radial-gradient(circle at top left, #1b2750 0, #050816 45%, #02030a 100%);
      color: #e8f0ff;
      min-height: 100vh;
    }
    /* 禁止双击放大 */
    body {
      touch-action: manipulation;
    }

    .app-root {
      max-width: 1440px;
      margin: 20px auto;
      padding: 0 20px 32px;
      display: flex;
      gap: 20px;
    }

    /* 左侧：交易区 */
    .sidebar {
      width: 280px;
      background: radial-gradient(circle at top, #16213a 0, #050815 60%);
      border-radius: 20px;
      padding: 18px 18px 14px;
      box-shadow: 0 18px 45px rgba(0,0,0,0.6);
      border: 1px solid rgba(86,123,255,0.4);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      letter-spacing: 0.02em;
      color: #c5d4ff;
      background: linear-gradient(135deg, rgba(76,130,255,0.18), rgba(119,148,255,0.05));
      border: 1px solid rgba(118,150,255,0.6);
    }
    .badge-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      margin-right: 6px;
      background: #4fd1ff;
      box-shadow: 0 0 8px rgba(79,209,255,0.9);
    }
    .side-title {
      font-size: 24px;
      font-weight: 700;
    }
    .side-subtitle {
      font-size: 13px;
      line-height: 1.6;
      color: #a9b6dd;
    }
    .side-section-title {
      font-size: 12px;
      color: #8f9ad0;
      margin-top: 4px;
    }
    .area-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .area-item {
      border-radius: 14px;
      padding: 12px 14px;
      background: rgba(10,18,40,0.9);
      border: 1px solid rgba(77,102,179,0.5);
      cursor: pointer;
      transition: all .16s ease-out;
    }
    .area-item:hover {
      border-color: #5c7cff;
      box-shadow: 0 0 0 1px rgba(92,124,255,0.4);
    }
    .area-item.active {
      background: radial-gradient(circle at top left, #255dff40 0, #101424 60%);
      border-color: #6c8dff;
      box-shadow: 0 12px 25px rgba(15,70,200,0.65);
    }
    .area-item-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .area-item-desc {
      font-size: 12px;
      color: #9facdf;
    }
    .side-tip {
      margin-top: auto;
      font-size: 11px;
      color: #6f7bb0;
      border-top: 1px dashed rgba(92,119,210,0.5);
      padding-top: 8px;
      line-height: 1.6;
    }

    /* 主区域布局：上中右 + 下方历史 */
    .main {
      flex: 1;
      background: radial-gradient(circle at top, #141c38 0, #050815 45%, #02030a 100%);
      border-radius: 20px;
      padding: 18px 20px 16px;
      border: 1px solid rgba(86,123,255,0.45);
      box-shadow: 0 18px 45px rgba(0,0,0,0.7);
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .main-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
    }
    .main-headline {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 2px;
    }
    .main-desc {
      font-size: 13px;
      color: #99a7de;
    }
    .tool-select-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: #c6d3ff;
    }
    .select {
      min-width: 180px;
      border-radius: 999px;
      padding: 6px 12px;
      border: 1px solid rgba(103,133,212,0.9);
      background: rgba(5,10,32,0.95);
      color: #f5f7ff;
      font-size: 13px;
      outline: none;
    }

    .main-body {
      display: grid;
      grid-template-columns: minmax(0,1.1fr) minmax(0,1.1fr);
      gap: 16px;
      align-items: flex-start;
    }

    .card {
      border-radius: 16px;
      padding: 14px 16px 14px;
      background: radial-gradient(circle at top left, #232c4a 0, #050815 65%);
      border: 1px solid rgba(88,120,210,0.65);
      box-shadow: 0 12px 26px rgba(0,0,0,0.55);
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    .card-title {
      font-size: 14px;
      font-weight: 600;
    }
    .card-subtitle {
      font-size: 11px;
      color: #9cadf0;
    }

    .input-tip {
      font-size: 12px;
      color: #94a2df;
      margin-bottom: 10px;
      line-height: 1.6;
    }
    .field-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 10px;
    }
    .field-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .field-label {
      min-width: 110px;
      font-size: 13px;
      color: #cbd6ff;
      text-align: right;
    }
    .field-input-wrap {
      flex: 1;
      position: relative;
    }
    .field-input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(103,133,212,0.9);
      background: rgba(5,10,32,0.9);
      color: #f5f7ff;
      font-size: 13px;
      outline: none;
      transition: all .16s ease-out;
    }
    .field-input:focus {
      border-color: #a9c4ff;
      box-shadow: 0 0 0 1px rgba(80,140,255,0.6);
      background: rgba(7,13,38,0.95);
    }
    .field-select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(103,133,212,0.9);
      background: rgba(5,10,32,0.9);
      color: #f5f7ff;
      font-size: 13px;
      outline: none;
    }
    .field-suffix {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 11px;
      color: #9fb0f3;
      pointer-events: none;
    }

    .btn-row {
      display: flex;
      gap: 10px;
      margin-top: 4px;
    }
    .btn {
      border-radius: 999px;
      padding: 7px 18px;
      font-size: 13px;
      border: 1px solid rgba(107,136,220,0.9);
      background: rgba(9,14,38,0.9);
      color: #d3dfff;
      cursor: pointer;
      transition: all .16s ease-out;
    }
    .btn:hover {
      background: rgba(124,157,255,0.15);
      border-color: #9eb7ff;
    }
    .btn-primary {
      background: radial-gradient(circle at top left, #3f83ff 0, #1b3da6 45%, #0b183a 100%);
      border-color: #a3c3ff;
      color: #fff;
      box-shadow: 0 10px 26px rgba(50,120,255,0.85);
    }
    .btn-primary:hover {
      background: radial-gradient(circle at top left, #4b8fff 0, #2546b4 45%, #0e214a 100%);
      border-color: #c4d6ff;
    }

    .status-text {
      margin-top: 6px;
      font-size: 12px;
      color: #93a4ff;
      min-height: 16px;
    }
    .status-error {
      color: #ff9a9a;
    }

    /* 右边：公式 + 结果 + 复制 */
    .preview-section {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .preview-block {
      border-radius: 12px;
      padding: 10px 12px;
      background: rgba(3,9,32,0.95);
      border: 1px solid rgba(116,144,235,0.7);
      font-size: 13px;
      line-height: 1.7;
      white-space: pre-wrap;
      min-height: 80px;
    }
    .preview-block-title {
      font-size: 12px;
      font-weight: 600;
      color: #cfd8ff;
      margin-bottom: 4px;
    }
    .preview-result {
      border-radius: 12px;
      padding: 10px 12px;
      background: rgba(7,14,46,0.95);
      border: 1px solid rgba(131,158,243,0.9);
      font-size: 13px;
      line-height: 1.7;
      min-height: 60px;
    }

    .preview-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    /* 底部历史区域 */
    .history-card {
      margin-top: 6px;
      border-radius: 14px;
      padding: 10px 14px;
      background: rgba(5,10,35,0.95);
      border: 1px solid rgba(96,126,220,0.75);
      box-shadow: 0 10px 24px rgba(0,0,0,0.55);
      font-size: 12px;
      color: #c7d2ff;
    }
    .history-title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      font-size: 12px;
      color: #aeb8ff;
    }
    .history-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 150px;
      overflow-y: auto;
      padding-right: 4px;
    }
    .history-item {
      border-radius: 10px;
      padding: 6px 8px;
      background: rgba(9,15,45,0.95);
      border: 1px solid rgba(110,138,234,0.7);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .history-item-main {
      flex: 1;
      min-width: 0;
    }
    .history-item-main div {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .history-item-main .line1 {
      font-size: 12px;
      color: #e1e6ff;
      margin-bottom: 2px;
    }
    .history-item-main .line2 {
      font-size: 11px;
      color: #9faaf5;
    }
    .history-btn {
      border-radius: 999px;
      padding: 3px 10px;
      font-size: 11px;
      border: 1px solid rgba(134,160,245,0.9);
      background: rgba(10,20,60,0.9);
      color: #e4ebff;
      cursor: pointer;
    }

    .version {
      font-size: 11px;
      color: #7f8ae0;
      text-align: right;
      margin-top: 6px;
      opacity: 0.9;
    }

    @media (max-width: 1100px) {
      .app-root {
        flex-direction: column;
      }
      .sidebar {
        width: 100%;
      }
      .main-body {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
<div class="app-root">
  <!-- 左侧：交易区 -->
  <aside class="sidebar">
    <div class="badge">
      <span class="badge-dot"></span>
      交易计算助手 · 内部自用
    </div>
    <div class="side-title">交易计算工具</div>
    <div class="side-subtitle">
      一个页面搞定：U 本位 / 币本位合约、后续现货杠杆、现货开仓均价、期权等多种计算。先选交易区，再选计算项目，右侧输入数据即可看到结果和中文公式说明。
    </div>

    <div class="side-section-title">交易区</div>
    <div class="area-list" id="areaList">
      <div class="area-item active" data-area="uPerp">
        <div class="area-item-title">U 本位合约</div>
        <div class="area-item-desc">逐笔 / 全仓：开仓均价、合约收益、保证金、强平价等</div>
      </div>
      <div class="area-item" data-area="coinPerp">
        <div class="area-item-title">币本位合约</div>
        <div class="area-item-desc">以币本身结算：开仓均价、收益、保证金等</div>
      </div>
      <div class="area-item" data-area="other">
        <div class="area-item-title">其他交易区（开发中）</div>
        <div class="area-item-desc">暂不开放，统一在 U 本位页面展示占位提示</div>
      </div>
    </div>

    <div class="side-tip">
      提示：左侧切换 U 本位 / 币本位后，右侧内容区域即时刷新，不会跳转页面 / 不刷新链接，适合公司电脑固定打开当工具使用。
    </div>
  </aside>

  <!-- 主区域 -->
  <main class="main">
    <div class="main-header">
      <div>
        <div class="main-headline" id="currentAreaTitle">当前交易区：U 本位合约</div>
        <div class="main-desc" id="currentAreaDesc">
          以 USDT 结算的合约：支持开仓均价、合约收益、收益率、保证金、仓位价值、资金费用、预估强平价等计算。
        </div>
      </div>
      <div class="tool-select-row">
        <span>计算项目：</span>
        <select id="toolSelect" class="select"></select>
      </div>
    </div>

    <!-- 中 + 右 -->
    <div class="main-body">
      <!-- 中间：输入区 -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title" id="inputCardTitle">输入区：开仓均价</div>
            <div class="card-subtitle" id="inputCardSub">
              输入合约面值、原持仓张数和均价、新开仓张数和成交均价，计算新的整体开仓均价。
            </div>
          </div>
          <div class="card-subtitle" id="inputCardTag">U 本位 · 合约工具</div>
        </div>

        <div class="input-tip" id="inputTip">
          示例：合约面值 0.01、原持仓 100 张、原持仓均价 1000，新开仓 50 张，新成交均价 2000。
        </div>

        <div class="field-list" id="fieldList"></div>

        <div class="btn-row">
          <button class="btn" id="btnClear">清空输入</button>
          <button class="btn btn-primary" id="btnCalc">开始计算</button>
        </div>

        <div class="status-text" id="statusText"></div>
      </section>

      <!-- 右侧：公式 + 结果 -->
      <section class="card">
        <div class="preview-header-row">
          <div>
            <div class="card-title">结果预览</div>
            <div class="card-subtitle">可复制 / 记录在飞书文档中使用。</div>
          </div>
          <button class="btn" id="btnCopy">复制当前结果</button>
        </div>

        <div class="preview-section">
          <div class="preview-block" id="previewFormula">
            <div class="preview-block-title">公式 + 代入数值：</div>
            选择上方的计算项目后，点击“开始计算”，这里会展示中文公式和代入数值写法。
          </div>

          <div class="preview-result" id="previewResult">
            当前结果会显示在这里。
          </div>
        </div>

        <div class="version">本工具仅作内部计算参考，请以系统实际数据为准。版本：v1.0（示例）</div>
      </section>
    </div>

    <!-- 底部：最近计算记录 -->
    <section class="history-card">
      <div class="history-title-row">
        <span>最近计算记录（最多保留 5 条）</span>
        <span style="font-size:11px;color:#9ba7ff;">可快速恢复输入，再次调整数值重新计算。</span>
      </div>
      <div class="history-list" id="historyList">
        <div style="font-size:11px;color:#8792d9;">暂时无记录。</div>
      </div>
    </section>
  </main>
</div>

<script>
  // ===== 配置：U 本位 / 币本位 =====
  const AREA_CONFIG = {
    uPerp: {
      title: "当前交易区：U 本位合约",
      desc: "以 USDT 结算的合约：支持开仓均价、合约收益、收益率、保证金、仓位价值、资金费用、预估强平价等计算。",
      tag: "U 本位 · 合约工具",
      tools: []
    },
    coinPerp: {
      title: "当前交易区：币本位合约",
      desc: "以币本身结算的合约：支持开仓均价、合约收益、收益率、保证金、仓位价值、资金费用、预估强平价等计算（公式与 U 本位略有区别，先按示例占位）。",
      tag: "币本位 · 合约工具",
      tools: []
    }
  };

  // 基础工具（先用一套公式，后续你可以按币本位的 Excel 替换 calc 部分）
  const baseTools = [
    {
      id: "openPrice",
      name: "开仓均价",
      tip: "输入合约面值、原持仓张数和均价、新开仓张数和成交均价，计算新的整体开仓均价。",
      subTitle: "开仓均价 = (原持仓面值总额 + 新开仓面值总额) ÷ 总张数的面值。",
      fields: [
        { key: "faceValue", label: "合约面值", placeholder: "例如 0.01", suffix: "" },
        { key: "oldQty", label: "原持仓张数", placeholder: "整数，例如 100", suffix: "张" },
        { key: "oldPrice", label: "原持仓均价", placeholder: "例如 1000", suffix: "" },
        { key: "newQty", label: "新开仓张数", placeholder: "整数，例如 50", suffix: "张" },
        { key: "newPrice", label: "新成交均价", placeholder: "例如 2000", suffix: "" }
      ],
      calc: (d) => {
        const f = d.faceValue, oc = d.oldQty, op = d.oldPrice, nc = d.newQty, np = d.newPrice;
        if (oc + nc === 0) throw new Error("原持仓张数 + 新开仓张数 不能为 0。");
        const numerator = f * oc * op + f * nc * np;
        const denominator = f * (oc + nc);
        const avg = numerator / denominator;
        const main = `新的开仓均价 ≈ ${avg.toFixed(4)} U`;
        const formula = "开仓均价 = (合约面值 × 原持仓张数 × 原持仓均价 + 合约面值 × 新开仓张数 × 新成交均价) ÷ [合约面值 × (原持仓张数 + 新开仓张数)]";
        const withVal = `开仓均价 = (${f} × ${oc} × ${op} + ${f} × ${nc} × ${np}) ÷ [${f} × (${oc} + ${nc})]`;
        return { main, formula, withVal };
      }
    },
    {
      id: "fee",
      name: "手续费",
      tip: "输入合约面值、张数、开/平仓均价、手续费率（%），计算单次交易手续费。",
      subTitle: "手续费 = 合约面值 × 张数 × 开/平仓均价 × 手续费率（小数）。",
      fields: [
        { key: "faceValue", label: "合约面值", placeholder: "例如 0.01", suffix: "" },
        { key: "qty", label: "张数", placeholder: "整数，例如 100", suffix: "张" },
        { key: "price", label: "开/平仓均价", placeholder: "例如 1000", suffix: "" },
        { key: "rate", label: "手续费率", placeholder: "例如 0.03（代表 0.03%）", suffix: "%", isPercent: true }
      ],
      calc: (d) => {
        const fee = d.faceValue * d.qty * d.price * d.rate;
        const main = `本次手续费 ≈ ${fee.toFixed(6)} U`;
        const formula = "手续费 = 合约面值 × 张数 × 开/平仓均价 × 手续费率（小数）";
        const withVal = `手续费 = ${d.faceValue} × ${d.qty} × ${d.price} × ${d.rate}`;
        return { main, formula, withVal };
      }
    },
    {
      id: "pnl",
      name: "合约收益",
      tip: "选择多仓或空仓，输入合约面值、张数、开仓均价和平仓均价，计算本次平仓收益。",
      subTitle: "多仓：收益 = 面值 × 张数 × (平仓均价 - 开仓均价)；空仓相反。",
      fields: [
        {
          key: "side",
          label: "持仓方向",
          type: "select",
          options: [
            { value: "long", label: "多仓" },
            { value: "short", label: "空仓" }
          ]
        },
        { key: "faceValue", label: "合约面值", placeholder: "例如 0.01", suffix: "" },
        { key: "qty", label: "张数", placeholder: "整数，例如 100", suffix: "张" },
        { key: "openPrice", label: "开仓均价", placeholder: "例如 1000", suffix: "" },
        { key: "closePrice", label: "平仓均价", placeholder: "例如 1200", suffix: "" }
      ],
      calc: (d) => {
        let pnl, formula, withVal;
        if (d.side === "long") {
          pnl = d.faceValue * d.qty * (d.closePrice - d.openPrice);
          formula = "多仓：收益 = 合约面值 × 张数 × (平仓均价 - 开仓均价)";
          withVal = `收益 = ${d.faceValue} × ${d.qty} × (${d.closePrice} - ${d.openPrice})`;
        } else {
          pnl = d.faceValue * d.qty * (d.openPrice - d.closePrice);
          formula = "空仓：收益 = 合约面值 × 张数 × (开仓均价 - 平仓均价)";
          withVal = `收益 = ${d.faceValue} × ${d.qty} × (${d.openPrice} - ${d.closePrice})`;
        }
        const main = `本次平仓收益 ≈ ${pnl.toFixed(4)} U`;
        return { main, formula, withVal };
      }
    },
    {
      id: "roi",
      name: "收益率",
      tip: "输入本次收益金额和开仓固定保证金，计算收益率（%）。",
      subTitle: "收益率 = 收益 ÷ 开仓固定保证金 × 100%。",
      fields: [
        { key: "pnl", label: "收益金额", placeholder: "例如 50", suffix: "U" },
        { key: "margin", label: "开仓固定保证金", placeholder: "例如 200", suffix: "U" }
      ],
      calc: (d) => {
        if (d.margin === 0) throw new Error("开仓固定保证金不能为 0。");
        const roi = (d.pnl / d.margin) * 100;
        const main = `收益率 ≈ ${roi.toFixed(2)} %`;
        const formula = "收益率 = 收益 ÷ 开仓固定保证金 × 100%";
        const withVal = `收益率 = ${d.pnl} ÷ ${d.margin} × 100%`;
        return { main, formula, withVal };
      }
    },
    {
      id: "initMargin",
      name: "开仓保证金（初始）",
      tip: "输入合约面值、开仓价格、张数和杠杆倍数，计算开仓所需初始保证金。",
      subTitle: "开仓保证金 = 合约面值 × 开仓价格 × 张数 ÷ 杠杆倍数。",
      fields: [
        { key: "faceValue", label: "合约面值", placeholder: "例如 0.01", suffix: "" },
        { key: "price", label: "开仓价格", placeholder: "例如 3000", suffix: "U" },
        { key: "qty", label: "张数", placeholder: "整数，例如 1", suffix: "张" },
        { key: "leverage", label: "杠杆倍数", placeholder: "例如 20", suffix: "倍" }
      ],
      calc: (d) => {
        if (d.leverage === 0) throw new Error("杠杆倍数不能为 0。");
        const margin = d.faceValue * d.price * d.qty / d.leverage;
        const main = `开仓需要的初始保证金 ≈ ${margin.toFixed(4)} U`;
        const formula = "开仓保证金 = 合约面值 × 开仓价格 × 张数 ÷ 杠杆倍数";
        const withVal = `开仓保证金 = ${d.faceValue} × ${d.price} × ${d.qty} ÷ ${d.leverage}`;
        return { main, formula, withVal };
      }
    },
    {
      id: "positionValue",
      name: "仓位价值",
      tip: "输入合约面值、张数和标记价格，计算当前仓位价值。",
      subTitle: "仓位价值 = 合约面值 × 张数 × 标记价格。",
      fields: [
        { key: "faceValue", label: "合约面值", placeholder: "例如 0.01", suffix: "" },
        { key: "qty", label: "张数", placeholder: "整数，例如 100", suffix: "张" },
        { key: "markPrice", label: "标记价格", placeholder: "例如 1000", suffix: "U" }
      ],
      calc: (d) => {
        const value = d.faceValue * d.qty * d.markPrice;
        const main = `当前仓位价值 ≈ ${value.toFixed(4)} U`;
        const formula = "仓位价值 = 合约面值 × 张数 × 标记价格";
        const withVal = `仓位价值 = ${d.faceValue} × ${d.qty} × ${d.markPrice}`;
        return { main, formula, withVal };
      }
    },
    {
      id: "funding",
      name: "资金费用",
      tip: "输入仓位价值和资金费率（%），计算当前资金费用。",
      subTitle: "资金费用 = 仓位价值 × 资金费率（小数）。",
      fields: [
        { key: "positionValue", label: "仓位价值", placeholder: "例如 1000", suffix: "U" },
        { key: "fundingRate", label: "资金费率", placeholder: "例如 0.03（代表 0.03%）", suffix: "%", isPercent: true }
      ],
      calc: (d) => {
        const fee = d.positionValue * d.fundingRate;
        const main = `本次资金费用 ≈ ${fee.toFixed(6)} U`;
        const formula = "资金费用 = 仓位价值 × 资金费率（小数）";
        const withVal = `资金费用 = ${d.positionValue} × ${d.fundingRate}`;
        return { main, formula, withVal };
      }
    }
  ];

  // U 本位、币本位先共用这套，后续你可以复制一份给 coinPerp 专门改 calc
  AREA_CONFIG.uPerp.tools = baseTools;
  AREA_CONFIG.coinPerp.tools = baseTools.map(t => ({ ...t })); // 浅拷贝一份

  // ===== DOM =====
  const areaListEl = document.getElementById("areaList");
  const currentAreaTitleEl = document.getElementById("currentAreaTitle");
  const currentAreaDescEl = document.getElementById("currentAreaDesc");
  const inputCardTagEl = document.getElementById("inputCardTag");

  const toolSelectEl = document.getElementById("toolSelect");
  const inputCardTitleEl = document.getElementById("inputCardTitle");
  const inputCardSubEl = document.getElementById("inputCardSub");
  const inputTipEl = document.getElementById("inputTip");
  const fieldListEl = document.getElementById("fieldList");
  const btnClear = document.getElementById("btnClear");
  const btnCalc = document.getElementById("btnCalc");
  const statusTextEl = document.getElementById("statusText");

  const previewFormulaEl = document.getElementById("previewFormula");
  const previewResultEl = document.getElementById("previewResult");
  const btnCopy = document.getElementById("btnCopy");

  const historyListEl = document.getElementById("historyList");

  let currentArea = "uPerp";
  let currentToolId = baseTools[0].id;
  const historyStore = []; // {area, toolId, toolName, main, formula, withVal, inputs}

  // ===== 渲染工具下拉 =====
  function renderToolSelect() {
    const areaCfg = AREA_CONFIG[currentArea];
    toolSelectEl.innerHTML = "";
    areaCfg.tools.forEach(tool => {
      const opt = document.createElement("option");
      opt.value = tool.id;
      opt.textContent = tool.name;
      toolSelectEl.appendChild(opt);
    });
    toolSelectEl.value = currentToolId;
  }

  // ===== 渲染输入字段 =====
  function renderFields() {
    const tool = getCurrentTool();
    inputCardTitleEl.textContent = "输入区：" + tool.name;
    inputCardSubEl.textContent = tool.subTitle;
    inputTipEl.textContent = tool.tip;

    const tagText = currentArea === "uPerp" ? AREA_CONFIG.uPerp.tag : AREA_CONFIG.coinPerp.tag;
    inputCardTagEl.textContent = tagText;

    fieldListEl.innerHTML = "";
    tool.fields.forEach(f => {
      const row = document.createElement("div");
      row.className = "field-row";

      const label = document.createElement("div");
      label.className = "field-label";
      label.textContent = f.label;
      row.appendChild(label);

      const wrap = document.createElement("div");
      wrap.className = "field-input-wrap";

      if (f.type === "select") {
        const select = document.createElement("select");
        select.className = "field-select";
        select.id = "field_" + f.key;
        f.options.forEach(opt => {
          const o = document.createElement("option");
          o.value = opt.value;
          o.textContent = opt.label;
          select.appendChild(o);
        });
        wrap.appendChild(select);
      } else {
        const input = document.createElement("input");
        input.className = "field-input";
        input.type = "text";
        input.placeholder = f.placeholder || "";
        input.id = "field_" + f.key;
        wrap.appendChild(input);

        if (f.suffix) {
          const suf = document.createElement("span");
          suf.className = "field-suffix";
          suf.textContent = f.suffix;
          wrap.appendChild(suf);
        }
      }

      row.appendChild(wrap);
      fieldListEl.appendChild(row);
    });

    // 重置预览
    previewFormulaEl.innerHTML = '<div class="preview-block-title">公式 + 代入数值：</div>选择上方的计算项目后，点击“开始计算”，这里会展示中文公式和代入数值写法。';
    previewResultEl.textContent = "当前结果会显示在这里。";
    statusTextEl.textContent = "";
    statusTextEl.classList.remove("status-error");
  }

  function getCurrentTool() {
    const areaCfg = AREA_CONFIG[currentArea];
    return areaCfg.tools.find(t => t.id === currentToolId);
  }

  // ===== 获取输入数据 =====
  function getInputData() {
    const tool = getCurrentTool();
    const data = {};
    tool.fields.forEach(f => {
      const el = document.getElementById("field_" + f.key);
      if (!el) return;
      if (f.type === "select") {
        data[f.key] = el.value;
      } else {
        const raw = el.value.trim();
        if (raw === "") {
          data[f.key] = NaN;
        } else {
          let num = Number(raw);
          if (Number.isNaN(num)) {
            data[f.key] = NaN;
          } else {
            if (f.isPercent) {
              num = num / 100; // 百分比转小数
            }
            data[f.key] = num;
          }
        }
      }
    });
    return data;
  }

  function checkNumbers(obj) {
    for (const [k, v] of Object.entries(obj)) {
      if (typeof v === "number" && Number.isNaN(v)) {
        throw new Error("有必填项为空或不是数字，请检查输入。");
      }
    }
  }

  // ===== 历史记录渲染 =====
  function renderHistory() {
    historyListEl.innerHTML = "";
    if (historyStore.length === 0) {
      const div = document.createElement("div");
      div.style.fontSize = "11px";
      div.style.color = "#8792d9";
      div.textContent = "暂时无记录。";
      historyListEl.appendChild(div);
      return;
    }

    historyStore.slice(-5).forEach((item, idx) => {
      const row = document.createElement("div");
      row.className = "history-item";

      const main = document.createElement("div");
      main.className = "history-item-main";
      const line1 = document.createElement("div");
      line1.className = "line1";
      line1.textContent = `[${item.areaLabel}] ${item.toolName}`;
      const line2 = document.createElement("div");
      line2.className = "line2";
      line2.textContent = item.main;
      main.appendChild(line1);
      main.appendChild(line2);
      row.appendChild(main);

      const btn = document.createElement("button");
      btn.className = "history-btn";
      btn.textContent = "恢复输入";
      btn.onclick = () => {
        // 切换到对应区域和工具
        if (currentArea !== item.area) {
          switchArea(item.area);
        }
        currentToolId = item.toolId;
        renderToolSelect();
        renderFields();

        const tool = getCurrentTool();
        tool.fields.forEach(f => {
          const el = document.getElementById("field_" + f.key);
          if (!el) return;
          const value = item.inputs[f.key];
          if (f.type === "select") {
            el.value = value;
          } else {
            if (typeof value === "number" && f.isPercent) {
              el.value = (value * 100).toString();
            } else if (typeof value === "number") {
              el.value = value.toString();
            } else {
              el.value = "";
            }
          }
        });

        // 恢复预览
        previewFormulaEl.innerHTML = `<div class="preview-block-title">公式 + 代入数值：</div>${item.formula}\n\n${item.withVal}`;
        previewResultEl.textContent = item.main;
        statusTextEl.textContent = "已根据记录恢复输入。";
        statusTextEl.classList.remove("status-error");
      };
      row.appendChild(btn);

      historyListEl.appendChild(row);
    });
  }

  // ===== 区域切换 =====
  function switchArea(area) {
    currentArea = area;
    const cfg = AREA_CONFIG[area];

    // 左侧高亮
    Array.from(areaListEl.querySelectorAll(".area-item")).forEach(el => {
      el.classList.toggle("active", el.dataset.area === area);
    });

    currentAreaTitleEl.textContent = cfg.title;
    currentAreaDescEl.textContent = cfg.desc;

    if (!cfg.tools || cfg.tools.length === 0) {
      toolSelectEl.innerHTML = "";
      fieldListEl.innerHTML = "";
      inputTipEl.textContent = "该交易区功能还在设计中。";
      previewFormulaEl.innerHTML = '<div class="preview-block-title">公式 + 代入数值：</div>该交易区暂未开放详细计算功能。';
      previewResultEl.textContent = "敬请期待。";
      return;
    }

    currentToolId = cfg.tools[0].id;
    renderToolSelect();
    renderFields();
  }

  // ===== 事件绑定 =====
  areaListEl.addEventListener("click", (e) => {
    const item = e.target.closest(".area-item");
    if (!item) return;
    const area = item.dataset.area;

    if (area === "other") {
      alert("其它交易区暂未开放，请先使用 U 本位 / 币本位。");
      return;
    }
    switchArea(area);
  });

  toolSelectEl.addEventListener("change", () => {
    currentToolId = toolSelectEl.value;
    renderFields();
  });

  btnClear.onclick = () => {
    Array.from(fieldListEl.querySelectorAll("input.field-input")).forEach(el => {
      el.value = "";
    });
    statusTextEl.textContent = "已清空输入。";
    statusTextEl.classList.remove("status-error");
    previewFormulaEl.innerHTML = '<div class="preview-block-title">公式 + 代入数值：</div>选择上方的计算项目后，点击“开始计算”，这里会展示中文公式和代入数值写法。';
    previewResultEl.textContent = "当前结果会显示在这里。";
  };

  btnCalc.onclick = () => {
    try {
      const tool = getCurrentTool();
      const data = getInputData();
      checkNumbers(data);

      const { main, formula, withVal } = tool.calc(data);

      previewFormulaEl.innerHTML =
        `<div class="preview-block-title">公式 + 代入数值：</div>${formula}\n\n${withVal}`;
      previewResultEl.textContent = main;

      statusTextEl.textContent = "计算完成。结果仅供参考。";
      statusTextEl.classList.remove("status-error");

      // 存历史
      historyStore.push({
        area: currentArea,
        areaLabel: currentArea === "uPerp" ? "U 本位" : "币本位",
        toolId: tool.id,
        toolName: tool.name,
        main,
        formula,
        withVal,
        inputs: getInputData() // 注意：这里已经是标准化后（百分比转小数）的值
      });
      if (historyStore.length > 5) historyStore.splice(0, historyStore.length - 5);
      renderHistory();

    } catch (err) {
      statusTextEl.textContent = err.message || "计算失败，请检查输入。";
      statusTextEl.classList.add("status-error");
    }
  };

  btnCopy.onclick = () => {
    const tool = getCurrentTool();
    const formulaBlock = previewFormulaEl.textContent.replace(/^公式 \+ 代入数值：\s*/, "");
    const resultText = previewResultEl.textContent;
    const fullText =
      `${tool.name}\n` +
      `${formulaBlock}\n` +
      `${resultText}`;
    navigator.clipboard.writeText(fullText).then(() => {
      statusTextEl.textContent = "已复制当前结果到剪贴板。";
      statusTextEl.classList.remove("status-error");
    }).catch(() => {
      statusTextEl.textContent = "复制失败，可以手动框选复制。";
      statusTextEl.classList.add("status-error");
    });
  };

  // 初始化
  renderToolSelect();
  renderFields();
  renderHistory();
</script>
</body>
</html>
