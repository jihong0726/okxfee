<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>交易计算工具 · 币本位合约</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","PingFang SC","Helvetica Neue",Arial,sans-serif;
      background:radial-gradient(circle at top left,#1b2750 0,#050816 45%,#02030a 100%);
      color:#e8f0ff;min-height:100vh;
    }
    .app-root{
      max-width:1440px;margin:24px auto;padding:0 24px 32px;
      display:flex;gap:24px;
    }
    .sidebar{
      width:320px;background:radial-gradient(circle at top,#16213a 0,#050815 60%);
      border-radius:20px;padding:20px 20px 16px;
      box-shadow:0 18px 45px rgba(0,0,0,.6);
      border:1px solid rgba(86,123,255,.4);
    }
    .badge{display:inline-flex;align-items:center;padding:4px 12px;border-radius:999px;font-size:12px;
      letter-spacing:.02em;color:#c5d4ff;
      background:linear-gradient(135deg,rgba(76,130,255,.18),rgba(119,148,255,.05));
      border:1px solid rgba(118,150,255,.6);margin-bottom:16px;
    }
    .badge-dot{width:6px;height:6px;border-radius:999px;margin-right:6px;background:#4fd1ff;
      box-shadow:0 0 8px rgba(79,209,255,.9);
    }
    .side-title{font-size:26px;font-weight:700;margin-bottom:12px}
    .side-subtitle{font-size:13px;line-height:1.6;color:#a9b6dd;margin-bottom:20px}
    .side-section-title{font-size:13px;color:#8f9ad0;margin:10px 0 8px}
    .area-list{display:flex;flex-direction:column;gap:8px;margin-bottom:18px}
    .area-item{
      border-radius:14px;padding:12px 14px;
      background:rgba(10,18,40,.9);border:1px solid rgba(77,102,179,.5);
      cursor:pointer;transition:all .18s ease-out;
    }
    .area-item:hover{border-color:#5c7cff;box-shadow:0 0 0 1px rgba(92,124,255,.4)}
    .area-item.active{
      background:radial-gradient(circle at top left,#255dff40 0,#101424 60%);
      border-color:#6c8dff;box-shadow:0 12px 25px rgba(15,70,200,.65);
    }
    .area-item-title{font-size:15px;font-weight:600;margin-bottom:4px}
    .area-item-desc{font-size:12px;color:#9facdf}
    .side-tip{
      font-size:11px;color:#6f7bb0;margin-top:22px;
      border-top:1px dashed rgba(92,119,210,.5);
      padding-top:10px;line-height:1.6;
    }

    .main{
      flex:1;background:radial-gradient(circle at top,#141c38 0,#050815 45%,#02030a 100%);
      border-radius:20px;padding:20px 22px 18px;
      border:1px solid rgba(86,123,255,.45);
      box-shadow:0 18px 45px rgba(0,0,0,.7);
      display:flex;flex-direction:column;gap:16px;
    }
    .main-top{display:flex;justify-content:space-between;gap:16px;align-items:center}
    .main-headline{font-size:18px;font-weight:600;margin-bottom:3px}
    .main-desc{font-size:13px;color:#99a7de}

    .tool-select-wrap{display:flex;align-items:center;gap:8px;font-size:13px;color:#b8c4ff}
    .tool-select-label{white-space:nowrap}
    .tool-select{
      min-width:210px;padding:7px 10px;border-radius:999px;
      border:1px solid rgba(119,147,238,.9);
      background:rgba(6,12,36,.95);color:#f5f7ff;font-size:13px;outline:none;
    }

    .main-body{
      display:grid;grid-template-columns:minmax(0,1.1fr) minmax(0,1fr);
      grid-template-rows:auto auto;gap:18px;margin-top:4px;
    }
    .card{
      border-radius:16px;padding:14px 16px 14px;
      background:radial-gradient(circle at top left,#232c4a 0,#050815 65%);
      border:1px solid rgba(88,120,210,.65);
      box-shadow:0 12px 26px rgba(0,0,0,.55);min-height:220px;
    }
    .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;gap:8px}
    .card-title{font-size:14px;font-weight:600}
    .card-subtitle{font-size:11px;color:#9cadf0}

    .input-tip{font-size:12px;color:#94a2df;margin-bottom:10px;line-height:1.6}
    .field-list{display:flex;flex-direction:column;gap:10px;margin-bottom:12px}
    .field-row{display:flex;align-items:center;gap:10px}
    .field-label{min-width:120px;font-size:13px;color:#cbd6ff;text-align:right}
    .field-input-wrap{flex:1;position:relative}
    .field-input{
      width:100%;padding:8px 10px;border-radius:999px;
      border:1px solid rgba(103,133,212,.9);
      background:rgba(5,10,32,.9);color:#f5f7ff;font-size:13px;
      outline:none;transition:all .16s ease-out;
    }
    .field-input:focus{
      border-color:#a9c4ff;box-shadow:0 0 0 1px rgba(80,140,255,.6);
      background:rgba(7,13,38,.95);
    }
    .field-suffix{
      position:absolute;right:12px;top:50%;transform:translateY(-50%);
      font-size:11px;color:#9fb0f3;pointer-events:none;
    }
    .field-select{
      width:100%;padding:8px 10px;border-radius:999px;
      border:1px solid rgba(103,133,212,.9);
      background:rgba(5,10,32,.9);color:#f5f7ff;font-size:13px;outline:none;
    }

    .btn-row{display:flex;gap:10px;margin-top:4px}
    .btn{
      border-radius:999px;padding:7px 18px;font-size:13px;
      border:1px solid rgba(107,136,220,.9);
      background:rgba(9,14,38,.9);color:#d3dfff;
      cursor:pointer;transition:all .16s ease-out;white-space:nowrap;
    }
    .btn:hover{background:rgba(124,157,255,.15);border-color:#9eb7ff}
    .btn-primary{
      background:radial-gradient(circle at top left,#3f83ff 0,#1b3da6 45%,#0b183a 100%);
      border-color:#a3c3ff;color:#fff;box-shadow:0 10px 26px rgba(50,120,255,.85);
    }
    .btn-primary:hover{
      background:radial-gradient(circle at top left,#4b8fff 0,#2546b4 45%,#0e214a 100%);
      border-color:#c4d6ff;
    }
    .btn-ghost{
      padding:4px 10px;font-size:11px;border-radius:999px;
      border:1px solid rgba(132,154,245,.85);
      background:rgba(12,18,48,.9);color:#d6e0ff;cursor:pointer;
    }
    .btn-ghost:hover{background:rgba(149,173,255,.18)}

    .status-text{margin-top:6px;font-size:12px;color:#93a4ff;min-height:16px}
    .status-error{color:#ff9a9a}

    .preview-formula,.preview-main{
      border-radius:12px;padding:10px 12px;
      background:rgba(3,9,32,.95);
      border:1px solid rgba(116,144,235,.7);
      font-size:13px;line-height:1.7;white-space:pre-wrap;
      margin-bottom:10px;min-height:70px;
    }
    .preview-main{background:rgba(10,16,48,.95)}

    .version{font-size:11px;color:#7f8ae0;text-align:right;margin-top:4px;opacity:.9}

    .history-card{grid-column:1/span 2;min-height:90px}
    .history-list{margin-top:4px;display:flex;flex-direction:column;gap:6px;font-size:12px;max-height:160px;overflow-y:auto}
    .history-empty{font-size:12px;color:#9ca9e5}
    .history-item{
      border-radius:10px;padding:7px 9px;background:rgba(5,12,40,.9);
      border:1px solid rgba(90,120,220,.8);
      display:flex;justify-content:space-between;gap:10px;align-items:center;
    }
    .history-main{flex:1;min-width:0}
    .history-title{font-size:12px;font-weight:500;color:#d5e0ff;margin-bottom:2px}
    .history-sub{font-size:11px;color:#9fb0f3;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .history-actions{display:flex;flex-direction:column;gap:4px}

    @media(max-width:1100px){
      .app-root{flex-direction:column}
      .sidebar{width:100%}
      .main-body{grid-template-columns:1fr;grid-template-rows:auto auto auto}
      .history-card{grid-column:1/span 1}
      .main-top{flex-direction:column;align-items:flex-start}
    }
  </style>
</head>
<body>
<div class="app-root">
  <!-- 左侧：导航（这里从币本位回到 index） -->
  <aside class="sidebar">
    <div class="badge">
      <span class="badge-dot"></span>
      交易计算助手 · 内部自用
    </div>
    <div class="side-title">交易计算工具</div>
    <div class="side-subtitle">
      币本位合约：以币本身结算的合约。这里支持开仓均价、合约收益、收益率、保证金、仓位价值、资金费用、预估强平价等计算。
    </div>

    <div class="side-section-title">交易区</div>
    <div class="area-list">
      <div class="area-item" onclick="window.location.href='index.html'">
        <div class="area-item-title">U 本位合约</div>
        <div class="area-item-desc">回到 U 本位合约计算页面</div>
      </div>
      <div class="area-item active">
        <div class="area-item-title">币本位合约</div>
        <div class="area-item-desc">当前页面：以币本身结算的合约计算</div>
      </div>
      <div class="area-item">
        <div class="area-item-title">其他交易区（开发中）</div>
        <div class="area-item-desc">暂不开放，统一在 U 本位页面展示占位提示</div>
      </div>
    </div>

    <div class="side-tip">
      提示：左侧可快速切换 U 本位 / 币本位。页面不会自动刷新链接，适合公司电脑固定打开当工具使用。
    </div>
  </aside>

  <!-- 右侧：主体（币本位逻辑几乎与 U 本位一致，只是文案和单位改为“币”） -->
  <main class="main">
    <div class="main-top">
      <div>
        <div class="main-headline" id="currentAreaTitle">当前交易区：币本位合约</div>
        <div class="main-desc" id="currentAreaDesc">
          以币本身结算的合约：支持开仓均价、合约收益、收益率、保证金、仓位价值、资金费用、预估强平价等计算（公式与 U 本位类似，实际单位为币）。
        </div>
      </div>
      <div class="tool-select-wrap">
        <div class="tool-select-label">计算项目：</div>
        <select id="toolSelect" class="tool-select"></select>
      </div>
    </div>

    <div class="main-body">
      <!-- 中：输入卡片 -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title" id="inputCardTitle">输入区：开仓均价</div>
            <div class="card-subtitle" id="inputCardSub">
              输入合约面值、原持仓张数和均价、新开仓张数和成交均价，计算当前整体开仓均价（币本位）。
            </div>
          </div>
          <div class="card-subtitle">币本位 · 合约工具</div>
        </div>

        <div class="input-tip" id="inputTip">
          格式示例：合约面值 0.001 BTC、原持仓 100 张、原持仓均价 10000，新开仓 50 张，新成交均价 12000。
        </div>

        <div class="field-list" id="fieldList"></div>

        <div class="btn-row">
          <button class="btn" id="btnClear">清空输入</button>
          <button class="btn btn-primary" id="btnCalc">开始计算</button>
        </div>

        <div class="status-text" id="statusText"></div>
      </section>

      <!-- 右：结果预览 -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">结果预览</div>
            <div class="card-subtitle">可复制 / 记录在飞书文档中使用。</div>
          </div>
          <button class="btn-ghost" id="btnCopy">复制当前结果</button>
        </div>

        <div class="preview-formula" id="previewFormula">
          公式：选择上方的计算项目，点击“开始计算”后，这里会显示中文公式和代入数值。
        </div>

        <div class="preview-main" id="previewMain">
          当前结果：这里会显示本次计算结果（单位默认为“币”）。
        </div>

        <div class="version">本工具仅作内部计算参考，请以系统实际数据为准。版本：v1.0（币本位示例）</div>
      </section>

      <!-- 下：历史记录 -->
      <section class="card history-card">
        <div class="card-header">
          <div>
            <div class="card-title">最近计算记录（最多保留 5 条）</div>
            <div class="card-subtitle">可快速恢复输入，再次调整数值重新计算。</div>
          </div>
        </div>
        <div class="history-list" id="historyList">
          <div class="history-empty">暂时无记录。</div>
        </div>
      </section>
    </div>
  </main>
</div>

<script>
  // 币本位合约计算项目（和 U 本位同一套公式，只是文字单位改成“币”）
  const coinTools = [
    {
      id:"openPrice",
      name:"开仓均价",
      tip:"输入合约面值、原持仓张数与均价、新开仓张数与成交均价，计算新的整体开仓均价（币本位）。",
      subTitle:"开仓均价 = (合约面值 × 原持仓张数 × 原持仓均价 + 合约面值 × 新开仓张数 × 新成交均价) ÷ [合约面值 × (原持仓张数 + 新开仓张数)]。",
      fields:[
        {key:"faceValue",label:"合约面值",placeholder:"例如 0.001",suffix:""},
        {key:"oldQty",label:"原持仓张数",placeholder:"整数，例如 100",suffix:"张"},
        {key:"oldPrice",label:"原持仓均价",placeholder:"例如 10000",suffix:"币计价"},
        {key:"newQty",label:"新开仓张数",placeholder:"整数，例如 50",suffix:"张"},
        {key:"newPrice",label:"新成交均价",placeholder:"例如 12000",suffix:"币计价"}
      ],
      calc:(d)=>{
        const f=d.faceValue,oc=d.oldQty,op=d.oldPrice,nc=d.newQty,np=d.newPrice;
        if(oc+nc===0)throw new Error("原持仓张数 + 新开仓张数 不能为 0。");
        const numerator=f*oc*op+f*nc*np;
        const denominator=f*(oc+nc);
        const avg=numerator/denominator;
        const main=`新的开仓均价 ≈ ${avg.toFixed(4)} （计价币）`;
        const formula="开仓均价 = (合约面值 × 原持仓张数 × 原持仓均价 + 合约面值 × 新开仓张数 × 新成交均价) ÷ [合约面值 × (原持仓张数 + 新开仓张数)]";
        const withVal=`开仓均价 = (${f} × ${oc} × ${op} + ${f} × ${nc} × ${np}) ÷ [${f} × (${oc} + ${nc})]`;
        return{main,formula,withVal};
      }
    },
    {
      id:"fee",
      name:"手续费",
      tip:"输入合约面值、张数、开/平仓均价、手续费率（%），计算单次交易手续费（以币计）。",
      subTitle:"手续费 = 合约面值 × 张数 × 开/平仓均价 × 手续费率（% 数值）。",
      fields:[
        {key:"faceValue",label:"合约面值",placeholder:"例如 0.001",suffix:""},
        {key:"qty",label:"张数",placeholder:"整数，例如 100",suffix:"张"},
        {key:"price",label:"开/平仓均价",placeholder:"例如 10000",suffix:"计价币"},
        {key:"rate",label:"手续费率",placeholder:"例如 0.03（3%）",suffix:"%"}
      ],
      calc:(d)=>{
        const fee=d.faceValue*d.qty*d.price*d.rate;
        const main=`本次手续费 ≈ ${fee.toFixed(8)} 币`;
        const formula="手续费 = 合约面值 × 张数 × 开/平仓均价 × 手续费率";
        const withVal=`手续费 = ${d.faceValue} × ${d.qty} × ${d.price} × ${d.rate}`;
        return{main,formula,withVal};
      }
    },
    {
      id:"pnl",
      name:"合约收益",
      tip:"选择多仓或空仓，输入合约面值、张数、开仓均价和平仓均价，计算本次平仓收益（币）。",
      subTitle:"多仓：收益 = 面值 × 张数 × (平仓均价 - 开仓均价)；空仓相反。",
      fields:[
        {key:"side",label:"持仓方向",type:"select",options:[
          {value:"long",label:"多仓"},{value:"short",label:"空仓"}
        ]},
        {key:"faceValue",label:"合约面值",placeholder:"例如 0.001",suffix:""},
        {key:"qty",label:"张数",placeholder:"整数，例如 100",suffix:"张"},
        {key:"openPrice",label:"开仓均价",placeholder:"例如 10000",suffix:"计价币"},
        {key:"closePrice",label:"平仓均价",placeholder:"例如 12000",suffix:"计价币"}
      ],
      calc:(d)=>{
        let pnl,formula,withVal;
        if(d.side==="long"){
          pnl=d.faceValue*d.qty*(d.closePrice-d.openPrice);
          formula="多仓：收益 = 合约面值 × 张数 × (平仓均价 - 开仓均价)";
          withVal=`收益 = ${d.faceValue} × ${d.qty} × (${d.closePrice} - ${d.openPrice})`;
        }else{
          pnl=d.faceValue*d.qty*(d.openPrice-d.closePrice);
          formula="空仓：收益 = 合约面值 × 张数 × (开仓均价 - 平仓均价)";
          withVal=`收益 = ${d.faceValue} × ${d.qty} × (${d.openPrice} - ${d.closePrice})`;
        }
        const main=`本次平仓收益 ≈ ${pnl.toFixed(8)} 币`;
        return{main,formula,withVal};
      }
    },
    {
      id:"roi",
      name:"收益率",
      tip:"输入本次收益金额和开仓固定保证金（均为币），计算收益率（%）。",
      subTitle:"收益率 = 收益 ÷ 开仓固定保证金 × 100%。",
      fields:[
        {key:"pnl",label:"收益金额",placeholder:"例如 0.05",suffix:"币"},
        {key:"margin",label:"开仓固定保证金",placeholder:"例如 1.5",suffix:"币"}
      ],
      calc:(d)=>{
        if(d.margin===0)throw new Error("开仓固定保证金不能为 0。");
        const roi=(d.pnl/d.margin)*100;
        const main=`收益率 ≈ ${roi.toFixed(2)} %`;
        const formula="收益率 = 收益 ÷ 开仓固定保证金 × 100%";
        const withVal=`收益率 = ${d.pnl} ÷ ${d.margin} × 100%`;
        return{main,formula,withVal};
      }
    },
    {
      id:"initMargin",
      name:"开仓保证金（初始）",
      tip:"输入合约面值、开仓价格、张数和杠杆倍数，计算开仓所需初始保证金（币）。",
      subTitle:"开仓保证金 = 合约面值 × 开仓价格 × 张数 ÷ 杠杆倍数。",
      fields:[
        {key:"faceValue",label:"合约面值",placeholder:"例如 0.001",suffix:""},
        {key:"price",label:"开仓价格",placeholder:"例如 30000",suffix:"计价币"},
        {key:"qty",label:"张数",placeholder:"整数，例如 1",suffix:"张"},
        {key:"leverage",label:"杠杆倍数",placeholder:"例如 20",suffix:"倍"}
      ],
      calc:(d)=>{
        if(d.leverage===0)throw new Error("杠杆倍数不能为 0。");
        const margin=d.faceValue*d.price*d.qty/d.leverage;
        const main=`开仓需要的初始保证金 ≈ ${margin.toFixed(8)} 币`;
        const formula="开仓保证金 = 合约面值 × 开仓价格 × 张数 ÷ 杠杆倍数";
        const withVal=`开仓保证金 = ${d.faceValue} × ${d.price} × ${d.qty} ÷ ${d.leverage}`;
        return{main,formula,withVal};
      }
    },
    {
      id:"positionValue",
      name:"仓位价值",
      tip:"输入合约面值、张数和标记价格，计算当前仓位价值（计价币）。",
      subTitle:"仓位价值 = 合约面值 × 张数 × 标记价格。",
      fields:[
        {key:"faceValue",label:"合约面值",placeholder:"例如 0.001",suffix:""},
        {key:"qty",label:"张数",placeholder:"整数，例如 100",suffix:"张"},
        {key:"markPrice",label:"标记价格",placeholder:"例如 30000",suffix:"计价币"}
      ],
      calc:(d)=>{
        const value=d.faceValue*d.qty*d.markPrice;
        const main=`当前仓位价值 ≈ ${value.toFixed(4)} 计价币`;
        const formula="仓位价值 = 合约面值 × 张数 × 标记价格";
        const withVal=`仓位价值 = ${d.faceValue} × ${d.qty} × ${d.markPrice}`;
        return{main,formula,withVal};
      }
    },
    {
      id:"funding",
      name:"资金费用",
      tip:"输入仓位价值和资金费率（%），计算当前资金费用（币）。",
      subTitle:"资金费用 = 仓位价值 × 资金费率（% 数值）。",
      fields:[
        {key:"positionValue",label:"仓位价值",placeholder:"例如 2",suffix:"计价币"},
        {key:"fundingRate",label:"资金费率",placeholder:"例如 0.03（3%）",suffix:"%"}
      ],
      calc:(d)=>{
        const fee=d.positionValue*d.fundingRate;
        const main=`本次资金费用 ≈ ${fee.toFixed(8)} 币`;
        const formula="资金费用 = 仓位价值 × 资金费率";
        const withVal=`资金费用 = ${d.positionValue} × ${d.fundingRate}`;
        return{main,formula,withVal};
      }
    }
  ];

  const toolSelectEl=document.getElementById("toolSelect");
  const fieldListEl=document.getElementById("fieldList");
  const inputTipEl=document.getElementById("inputTip");
  const inputCardTitleEl=document.getElementById("inputCardTitle");
  const inputCardSubEl=document.getElementById("inputCardSub");
  const btnClear=document.getElementById("btnClear");
  const btnCalc=document.getElementById("btnCalc");
  const btnCopy=document.getElementById("btnCopy");
  const statusTextEl=document.getElementById("statusText");
  const previewMainEl=document.getElementById("previewMain");
  const previewFormulaEl=document.getElementById("previewFormula");
  const historyListEl=document.getElementById("historyList");

  let currentToolId=coinTools[0].id;
  let lastCopyText="";
  const history=[];
  const MAX_HISTORY=5;

  function renderToolSelect(){
    toolSelectEl.innerHTML="";
    coinTools.forEach(t=>{
      const opt=document.createElement("option");
      opt.value=t.id;opt.textContent=t.name;
      toolSelectEl.appendChild(opt);
    });
    toolSelectEl.value=currentToolId;
  }

  function renderFields(tool){
    fieldListEl.innerHTML="";
    tool.fields.forEach(f=>{
      const row=document.createElement("div");
      row.className="field-row";
      const label=document.createElement("div");
      label.className="field-label";
      label.textContent=f.label;
      row.appendChild(label);

      const wrap=document.createElement("div");
      wrap.className="field-input-wrap";

      if(f.type==="select"){
        const sel=document.createElement("select");
        sel.className="field-select";sel.id="field_"+f.key;
        f.options.forEach(o=>{
          const opt=document.createElement("option");
          opt.value=o.value;opt.textContent=o.label;
          sel.appendChild(opt);
        });
        wrap.appendChild(sel);
      }else{
        const input=document.createElement("input");
        input.className="field-input";
        input.type="text";
        input.placeholder=f.placeholder||"";
        input.id="field_"+f.key;
        wrap.appendChild(input);
        if(f.suffix){
          const suf=document.createElement("span");
          suf.className="field-suffix";
          suf.textContent=f.suffix;
          wrap.appendChild(suf);
        }
      }
      row.appendChild(wrap);
      fieldListEl.appendChild(row);
    });
  }

  function updateToolUI(){
    const tool=coinTools.find(t=>t.id===currentToolId);
    inputCardTitleEl.textContent="输入区："+tool.name;
    inputCardSubEl.textContent=tool.subTitle;
    inputTipEl.textContent=tool.tip;
    renderFields(tool);
    statusTextEl.textContent="";
    statusTextEl.classList.remove("status-error");
    previewFormulaEl.textContent="公式：点击“开始计算”后，这里会显示该功能的公式以及代入数值写法。";
    previewMainEl.textContent="当前结果：这里会显示 "+tool.name+" 的计算结果。";
    lastCopyText="";
  }

  toolSelectEl.addEventListener("change",()=>{
    currentToolId=toolSelectEl.value;
    updateToolUI();
  });

  function getCurrentData(){
    const tool=coinTools.find(t=>t.id===currentToolId);
    const data={},raw={};
    tool.fields.forEach(f=>{
      const el=document.getElementById("field_"+f.key);
      if(!el)return;
      if(f.type==="select"){
        data[f.key]=el.value;
        raw[f.key]=el.value;
      }else{
        const v=el.value.trim();
        raw[f.key]=v;
        data[f.key]=v===""?NaN:Number(v);
      }
    });
    return{data,raw};
  }

  function checkNumbers(obj){
    for(const [k,v] of Object.entries(obj)){
      if(typeof v==="number" && Number.isNaN(v)){
        throw new Error("有必填项为空或不是数字，请检查输入。");
      }
    }
  }

  function renderHistory(){
    historyListEl.innerHTML="";
    if(history.length===0){
      const empty=document.createElement("div");
      empty.className="history-empty";
      empty.textContent="暂时无记录。";
      historyListEl.appendChild(empty);
      return;
    }
    history.forEach((item,idx)=>{
      const row=document.createElement("div");
      row.className="history-item";

      const mainDiv=document.createElement("div");
      mainDiv.className="history-main";
      const title=document.createElement("div");
      title.className="history-title";
      title.textContent=`${item.toolName}：${item.mainShort}`;
      mainDiv.appendChild(title);
      const sub=document.createElement("div");
      sub.className="history-sub";
      sub.textContent=item.sub;
      mainDiv.appendChild(sub);
      row.appendChild(mainDiv);

      const act=document.createElement("div");
      act.className="history-actions";
      const b1=document.createElement("button");
      b1.className="btn-ghost";
      b1.textContent="恢复输入";
      b1.onclick=()=>restoreHistory(idx);
      act.appendChild(b1);

      const b2=document.createElement("button");
      b2.className="btn-ghost";
      b2.textContent="复制结果";
      b2.onclick=()=>copyText(item.copyText);
      act.appendChild(b2);

      row.appendChild(act);
      historyListEl.appendChild(row);
    });
  }

  function addHistory(entry){
    history.unshift(entry);
    if(history.length>MAX_HISTORY)history.length=MAX_HISTORY;
    renderHistory();
  }

  function restoreHistory(idx){
    const item=history[idx];
    if(!item)return;
    const tool=coinTools.find(t=>t.id===item.toolId);
    if(!tool)return;
    currentToolId=item.toolId;
    toolSelectEl.value=currentToolId;
    updateToolUI();
    tool.fields.forEach(f=>{
      const el=document.getElementById("field_"+f.key);
      if(!el)return;
      if(f.type==="select"){
        el.value=item.raw[f.key]??"";
      }else{
        el.value=item.raw[f.key]??"";
      }
    });
  }

  function copyText(text){
    if(!text)return;
    navigator.clipboard?.writeText(text).then(()=>{
      statusTextEl.textContent="已复制当前结果到剪贴板。";
      statusTextEl.classList.remove("status-error");
    }).catch(()=>{
      statusTextEl.textContent="复制失败，可以手动选择文本复制。";
      statusTextEl.classList.add("status-error");
    });
  }

  btnCopy.onclick=()=>{
    if(!lastCopyText){
      statusTextEl.textContent="暂无可复制的结果，请先进行一次计算。";
      statusTextEl.classList.add("status-error");
      return;
    }
    copyText(lastCopyText);
  };

  btnCalc.onclick=()=>{
    try{
      const tool=coinTools.find(t=>t.id===currentToolId);
      const {data,raw}=getCurrentData();
      checkNumbers(data);
      const {main,formula,withVal}=tool.calc(data);
      const copyContent=`${formula}\n${withVal}\n${main}`;

      previewFormulaEl.textContent=`公式：${formula}\n\n代入数值：\n${withVal}`;
      previewMainEl.textContent=main;
      statusTextEl.textContent="计算完成。结果仅供参考。";
      statusTextEl.classList.remove("status-error");
      lastCopyText=copyContent;

      addHistory({
        toolId:tool.id,
        toolName:tool.name,
        mainShort:main,
        sub:formula,
        copyText:copyContent,
        raw
      });
    }catch(e){
      statusTextEl.textContent=e.message||"计算失败，请检查输入。";
      statusTextEl.classList.add("status-error");
    }
  };

  btnClear.onclick=()=>{
    Array.from(fieldListEl.querySelectorAll("input.field-input")).forEach(el=>el.value="");
    statusTextEl.textContent="已清空输入。";
    statusTextEl.classList.remove("status-error");
    previewFormulaEl.textContent="公式：点击“开始计算”后，这里会显示该功能的公式以及代入数值写法。";
    previewMainEl.textContent="当前结果：这里会显示本次计算结果。";
    lastCopyText="";
  };

  // 初始化
  renderToolSelect();
  renderHistory();
  updateToolUI();
</script>
</body>
</html>
